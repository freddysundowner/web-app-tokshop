import{a as Fe,g as Re,u as ze,r as a,f as $e,j as e,d as m,I as ee,B as S,L as se,m as te,A as ae,z as re,C as ie,D as ne,E as le,F as oe,G as ce,H as de,aM as Ye,aN as ue,aP as He,aQ as Qe,aT as Ve,aV as Je,aR as Ke}from"./index-FVTY5sKH.js";import{A as me,a as he,b as xe}from"./avatar-BgbrThQo.js";import{B as qe}from"./badge-BTf7a5Ku.js";import{S as fe}from"./scroll-area-BXmfGVKf.js";import{D as Ge,a as We,b as _e,c as ge}from"./dropdown-menu-BrJ5tGq0.js";import{D as Xe,a as Ze,b as es,c as ss}from"./dialog-A2pFZcsY.js";import{b as ts,c as as,m as rs,d as is,e as ns,f as ls,u as pe,h as I,i as je,j as os,k as cs,l as ds,n as us}from"./firebase-chat-COGJCOhY.js";import{S as be}from"./search-zDcbIzzp.js";import{A as ms}from"./arrow-left-C3R-C2jj.js";import{E as hs}from"./ellipsis-vertical-YsH48IHQ.js";import{S as xs}from"./shield-ZxSMvgGn.js";import{B as P}from"./ban-D6W4oNgC.js";import{I as fs}from"./image-D492slPc.js";import{S as gs}from"./send-Bsu1P8_-.js";import"./index-BaZiuLT8.js";import"./index-BdQq_4o_.js";import"./index-CoWBA0E_.js";import"./chevron-right-HRo85rGP.js";import"./check-DWjWNqF1.js";import"./circle-tm_CQXKA.js";function Ls(){const{user:o}=Fe(),[,h]=Re("/inbox/:chatId?"),[,L]=ze(),[r,U]=a.useState(null),[x,F]=a.useState(""),[R,Ne]=a.useState(""),[z,C]=a.useState(!1),[d,ve]=a.useState([]),[ye,$]=a.useState([]),[ke,D]=a.useState(!0),[j,Y]=a.useState(!1),[b,H]=a.useState(!1),N=a.useRef(null),Q=a.useRef(null),[B,T]=a.useState(!1),[E,we]=a.useState(!1),[Se,A]=a.useState(!1),[Ie,v]=a.useState(!1),[f,y]=a.useState(!1),[V,Ue]=a.useState(!1),[O,Ce]=a.useState(!1),[J,De]=a.useState(""),[M,K]=a.useState(null),{toast:u}=$e(),t=(o==null?void 0:o._id)||(o==null?void 0:o.id)||"",q=(o==null?void 0:o.userName)||(o==null?void 0:o.firstName)||"User",g=(o==null?void 0:o.profilePhoto)||"";a.useEffect(()=>{if(!t||!g)return;(async()=>{try{const i=Ye(ue(),"chats"),l=He(i,Qe("userIds","array-contains",t)),Le=(await Ve(l)).docs.map(async k=>{try{const X=k.data().users||[],Z=X.map(w=>w.id===t&&w.profilePhoto!==g?{...w,profilePhoto:g}:w);JSON.stringify(X)!==JSON.stringify(Z)&&(await Je(Ke(ue(),"chats",k.id),{users:Z}),console.log("Updated profile photo in chat:",k.id))}catch(_){console.error("Error updating chat:",k.id,_)}});await Promise.all(Le)}catch(i){console.error("Error updating user profile in chats:",i)}})()},[t,g]),a.useEffect(()=>{if(!t){D(!1);return}const s=ts(t,i=>{ve(i),D(!1)},i=>{console.error("Error loading chats:",i),D(!1)});return()=>s()},[t]),a.useEffect(()=>{if(!r){$([]);return}const s=as(r,i=>{const l=i.map(c=>({id:c.id,senderId:c.sender,content:c.message,timestamp:Be(c.date),isOwn:c.sender===t,isImage:us(c.message)}));$(l),setTimeout(()=>{var c;return(c=Q.current)==null?void 0:c.scrollIntoView({behavior:"smooth"})},100)},i=>{console.error("Error loading messages:",i)});return t&&rs(r,t),()=>s()},[r,t]),a.useEffect(()=>{if(!r||!t)return;const s=d.find(i=>i.id===r);s!=null&&s.otherUserId&&is(t,s.otherUserId).then(i=>{T(i.hasBlockedOther),we(i.isBlockedByOther)})},[r,t,d]),a.useEffect(()=>{if(!r)return;const s=d.find(l=>l.id===r);if(!(s!=null&&s.otherUserId))return;const i=ns(s.otherUserId,l=>{Ue(l.online),De(l.lastSeen)});return()=>i()},[r,d]),a.useEffect(()=>{if(!r)return;const s=d.find(l=>l.id===r);if(!(s!=null&&s.otherUserId))return;const i=ls(r,s.otherUserId,l=>{Ce(l)});return()=>i()},[r,d]),a.useEffect(()=>{if(t)return pe(t,!0),()=>{pe(t,!1)}},[t]),a.useEffect(()=>{if(!r||!t)return;let s;return x?(I(r,t,!0),s=setTimeout(()=>{I(r,t,!1)},3e3)):I(r,t,!1),()=>{s&&clearTimeout(s),r&&I(r,t,!1)}},[x,r,t]),a.useEffect(()=>{const s=h==null?void 0:h.chatId;s&&d.length>0&&d.some(l=>l.id===s)&&(U(s),C(!0))},[h==null?void 0:h.chatId,d]);const Be=s=>new Date(parseInt(s)).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}),Te=d.filter(s=>s.userName.toLowerCase().includes(R.toLowerCase())),n=d.find(s=>s.id===r),p=B||E,G=async()=>{if(x.trim()&&r&&t&&!p&&!j){Y(!0);const s=await je(r,x.trim(),t,q,g);s.success?F(""):(console.error("Failed to send message:",s.error),u({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"})),Y(!1)}},Ee=async s=>{var l;const i=(l=s.target.files)==null?void 0:l[0];if(!(!i||!r||!t||p)){if(!i.type.startsWith("image/")){u({title:"Invalid file",description:"Please select an image file.",variant:"destructive"});return}if(i.size>5*1024*1024){u({title:"File too large",description:"Please select an image smaller than 5MB.",variant:"destructive"});return}H(!0);try{const c=await os(i,t);await je(r,c,t,q,g),u({title:"Image sent",description:"Your image has been sent successfully."})}catch(c){console.error("Error uploading image:",c),u({title:"Upload failed",description:"Failed to upload image. Please try again.",variant:"destructive"})}finally{H(!1),N.current&&(N.current.value="")}}},Ae=async()=>{if(!(n!=null&&n.otherUserId)||!t)return;y(!0);const s=await cs(t,n.otherUserId);y(!1),A(!1),s?(T(!0),u({title:"User blocked",description:`You have blocked ${n.userName}. They can no longer send you messages.`})):u({title:"Error",description:"Failed to block user. Please try again.",variant:"destructive"})},Oe=async()=>{if(!(n!=null&&n.otherUserId)||!t)return;y(!0);const s=await ds(t,n.otherUserId);y(!1),v(!1),s?(T(!1),u({title:"User unblocked",description:`You have unblocked ${n.userName}.`})):u({title:"Error",description:"Failed to unblock user. Please try again.",variant:"destructive"})},Me=s=>{U(s),C(!0),L(`/inbox/${s}`)},Pe=()=>{C(!1),U(null),L("/inbox")},W=s=>s.replace("@","").substring(0,2).toUpperCase();return e.jsxs("div",{className:"h-full bg-background","data-testid":"page-inbox",children:[e.jsx("input",{ref:N,type:"file",accept:"image/*",onChange:Ee,className:"hidden"}),e.jsx("div",{className:"flex justify-center w-full h-full",children:e.jsx("div",{className:"w-full lg:w-[90%] h-full",children:ke?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading chats..."})}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 h-full",children:[e.jsxs("div",{className:m("lg:col-span-1 border-r border-border bg-card",z&&"hidden lg:block"),children:[e.jsxs("div",{className:"p-4 border-b border-border",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4","data-testid":"text-inbox-title",children:"Messages"}),e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ee,{placeholder:"Search conversations...",value:R,onChange:s=>Ne(s.target.value),className:"pl-10","data-testid":"input-search-conversations"})]})]}),e.jsx(fe,{className:"h-[calc(100vh-12rem)]",children:e.jsx("div",{className:"divide-y divide-border",children:Te.map(s=>e.jsxs("button",{onClick:()=>Me(s.id),className:m("w-full p-4 flex items-start gap-3 hover-elevate active-elevate-2 transition-colors text-left",r===s.id&&"bg-muted"),"data-testid":`conversation-${s.id}`,children:[e.jsxs("div",{className:"relative",children:[e.jsxs(me,{className:"h-12 w-12",children:[e.jsx(he,{src:s.userAvatar}),e.jsx(xe,{children:W(s.userName)})]}),s.online&&e.jsx("span",{className:"absolute bottom-0 right-0 h-3 w-3 bg-green-500 rounded-full border-2 border-card"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:m("text-sm font-medium truncate",s.unread?"text-foreground":"text-muted-foreground"),children:s.userName}),e.jsx("span",{className:"text-xs text-muted-foreground ml-2 flex-shrink-0",children:s.timestamp})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:m("text-sm truncate",s.unread?"font-medium text-foreground":"text-muted-foreground"),children:s.lastMessage}),s.unreadCount&&s.unreadCount>0&&e.jsx(qe,{variant:"default",className:"ml-2 flex-shrink-0 h-5 min-w-[20px] flex items-center justify-center",children:s.unreadCount})]})]})]},s.id))})})]}),e.jsx("div",{className:m("lg:col-span-2 flex flex-col",!z&&"hidden lg:flex"),children:n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border bg-card flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S,{variant:"ghost",size:"icon",className:"lg:hidden",onClick:Pe,"data-testid":"button-back-to-list",children:e.jsx(ms,{className:"h-5 w-5"})}),e.jsx(se,{href:`/profile/${n.otherUserId}`,children:e.jsxs(me,{className:"h-10 w-10 cursor-pointer hover-elevate",children:[e.jsx(he,{src:n.userAvatar}),e.jsx(xe,{children:W(n.userName)})]})}),e.jsxs("div",{children:[e.jsx(se,{href:`/profile/${n.otherUserId}`,children:e.jsx("p",{className:"font-medium text-foreground hover:underline cursor-pointer","data-testid":"text-conversation-user",children:n.userName})}),!p&&e.jsxs(e.Fragment,{children:[O&&e.jsx("p",{className:"text-xs text-primary italic",children:"typing..."}),!O&&V&&e.jsx("p",{className:"text-xs text-green-600 dark:text-green-400",children:"Online"}),!O&&!V&&J&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Last seen ",J]})]})]})]}),e.jsxs(Ge,{children:[e.jsx(We,{asChild:!0,children:e.jsx(S,{variant:"ghost",size:"icon","data-testid":"button-conversation-menu",children:e.jsx(hs,{className:"h-5 w-5"})})}),e.jsx(_e,{align:"end",children:B?e.jsxs(ge,{onClick:()=>v(!0),"data-testid":"menu-item-unblock",children:[e.jsx(xs,{className:"h-4 w-4 mr-2"}),"Unblock User"]}):!E&&e.jsxs(ge,{onClick:()=>A(!0),className:"text-destructive","data-testid":"menu-item-block",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Block User"]})})]})]}),p&&e.jsxs("div",{className:"bg-destructive/10 border-y border-destructive/20 p-4 text-center",children:[B&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-destructive",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsxs("span",{children:["You blocked ",n.userName,"."," ",e.jsx("button",{onClick:()=>v(!0),className:"underline font-medium",children:"Unblock"})]})]}),E&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-destructive",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsxs("span",{children:["You have been blocked by ",n.userName]})]})]}),e.jsx(fe,{className:"flex-1 p-4",children:e.jsxs("div",{className:"space-y-4",children:[ye.map(s=>e.jsx("div",{className:m("flex",s.isOwn?"justify-end":"justify-start"),"data-testid":`message-${s.id}`,children:e.jsx("div",{className:m("max-w-[70%] rounded-lg",s.isImage?"p-0":"px-4 py-2",s.isOwn?"bg-primary text-primary-foreground":"bg-muted text-foreground"),children:s.isImage?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s.content,alt:"Chat image",className:"rounded-lg max-w-full h-auto cursor-pointer",onClick:()=>K(s.content),style:{maxHeight:"300px"}}),e.jsx("p",{className:m("text-xs mt-1 px-2 pb-1",s.isOwn?"text-primary-foreground/70 text-right":"text-muted-foreground"),children:s.timestamp})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm",children:s.content}),e.jsx("p",{className:m("text-xs mt-1",s.isOwn?"text-primary-foreground/70":"text-muted-foreground"),children:s.timestamp})]})})},s.id)),e.jsx("div",{ref:Q})]})}),!p&&e.jsxs("div",{className:"p-4 border-t border-border bg-card",children:[b&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-2",children:[e.jsx(te,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Uploading image..."})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>{var s;return(s=N.current)==null?void 0:s.click()},disabled:b,"data-testid":"button-attach-image",children:e.jsx(fs,{className:"h-5 w-5"})}),e.jsx("div",{className:"flex-1",children:e.jsx(ee,{placeholder:"Type a message...",value:x,onChange:s=>F(s.target.value),onKeyPress:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),G())},disabled:j||b,className:"resize-none","data-testid":"input-message"})}),e.jsx(S,{onClick:G,disabled:!x.trim()||j||b,"data-testid":"button-send-message",children:j?e.jsx(te,{className:"h-4 w-4 animate-spin"}):e.jsx(gs,{className:"h-4 w-4"})})]})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-center p-8",children:e.jsxs("div",{children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(be,{className:"h-8 w-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No conversation selected"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose a conversation from the list to start messaging"})]})})})]})})}),e.jsx(ae,{open:Se,onOpenChange:A,children:e.jsxs(re,{children:[e.jsxs(ie,{children:[e.jsxs(ne,{children:["Block ",n==null?void 0:n.userName,"?"]}),e.jsx(le,{children:"They won't be able to send you messages anymore. You can unblock them anytime."})]}),e.jsxs(oe,{children:[e.jsx(ce,{disabled:f,children:"Cancel"}),e.jsx(de,{onClick:Ae,disabled:f,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:f?"Blocking...":"Block"})]})]})}),e.jsx(ae,{open:Ie,onOpenChange:v,children:e.jsxs(re,{children:[e.jsxs(ie,{children:[e.jsxs(ne,{children:["Unblock ",n==null?void 0:n.userName,"?"]}),e.jsx(le,{children:"They will be able to send you messages again."})]}),e.jsxs(oe,{children:[e.jsx(ce,{disabled:f,children:"Cancel"}),e.jsx(de,{onClick:Oe,disabled:f,children:f?"Unblocking...":"Unblock"})]})]})}),e.jsx(Xe,{open:!!M,onOpenChange:()=>K(null),children:e.jsxs(Ze,{className:"max-w-4xl",children:[e.jsx(es,{children:e.jsx(ss,{children:"Image Preview"})}),M&&e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("img",{src:M,alt:"Full size",className:"max-w-full max-h-[80vh] object-contain rounded-lg"})})]})})]})}export{Ls as default};
