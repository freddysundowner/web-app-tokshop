import{c as se,r as N,f as re,a as ie,j as e,B as F,m as oe,I as m,l as p,o as le,p as ne,K as de,v as ce,q as J,M as me,N as x}from"./index-FVTY5sKH.js";import{u as pe,F as xe,a as h,b as f,f as u,c as g,d as j,t as he}from"./form-CqTjZ3qa.js";import{C as O,a as G,d as z,b as H}from"./card-CF4CqaN2.js";import{A as fe,a as ue,b as ge}from"./avatar-BgbrThQo.js";import{A as je,a as Ne}from"./alert-_3QEPDXW.js";import{S as ye}from"./separator-QabP-acS.js";import{u as ve}from"./useQuery-DsZx8GVA.js";import{S as be}from"./square-pen-CAsDE1RN.js";import{U as we}from"./user-DBElIW39.js";import{S as Pe}from"./save-DQ6UIs6d.js";import{M as Se}from"./mail-CxzT5chc.js";import{P as Ce}from"./phone-BQAxbi5Q.js";import{M as Fe}from"./map-pin-jcALPDnh.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=se("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]),Ie=me({firstName:x().min(1,"First name is required"),lastName:x().min(1,"Last name is required"),userName:x().min(3,"Username must be at least 3 characters").regex(/^[a-zA-Z0-9_]+$/,"Username can only contain letters, numbers, and underscores"),email:x().email("Please enter a valid email address"),phone:x().optional().refine(r=>!r||r===""?!0:/^[\+]?[1-9][\d]{0,15}$|^[\+]?[(]?[0-9]{3}[)]?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4,6}$|^[\+]?[0-9]{8,15}$/.test(r.replace(/[\s\-\(\)]/g,"")),"Please enter a valid phone number"),country:x().min(1,"Country is required"),date_of_birth:x().optional().refine(r=>{if(!r||r==="")return!0;const d=new Date(r);return!isNaN(d.getTime())&&d<=new Date},"Please enter a valid date")});function Je(){var M,q;const[r,d]=N.useState(!1),[_,I]=N.useState(""),[E,A]=N.useState(!1),[T,b]=N.useState(!1),[Q,y]=N.useState(0),L=N.useRef(null),{toast:n}=re(),{user:a,refreshUserData:D}=ie(),k=(a==null?void 0:a._id)||(a==null?void 0:a.id),{data:Y}=ve({queryKey:[`/api/profile/${k}`],enabled:!!k,staleTime:0}),l=Y||a,o=pe({resolver:he(Ie),defaultValues:{firstName:(a==null?void 0:a.firstName)||"",lastName:(a==null?void 0:a.lastName)||"",userName:(a==null?void 0:a.userName)||"",email:(a==null?void 0:a.email)||"",phone:(a==null?void 0:a.phone)||"",country:(a==null?void 0:a.country)||"",date_of_birth:(a==null?void 0:a.date_of_birth)||""}}),w=(a==null?void 0:a.authProvider)==="google"||(a==null?void 0:a.authProvider)==="apple",V=async t=>{try{A(!0),I("");const i=await fetch("/api/users/profile",{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)}),c=await i.json();if(!i.ok)throw new Error(c.error||"Failed to update profile");if(c.data){const P=localStorage.getItem("user");if(P){const S={...JSON.parse(P),...c.data};localStorage.setItem("user",JSON.stringify(S))}}n({title:"Profile updated",description:"Your profile has been successfully updated."}),d(!1),window.location.reload()}catch(i){const c=i instanceof Error?i.message:"Profile update failed";I(c),n({title:"Update failed",description:c,variant:"destructive"})}finally{A(!1)}},W=()=>{o.reset(),d(!1),I("")},Z=async t=>{var S;const i=(S=t.target.files)==null?void 0:S[0];if(!i)return;if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(i.type)){n({title:"Invalid file type",description:"Please select a valid image file (JPEG, PNG, GIF, or WebP)",variant:"destructive"});return}const P=5*1024*1024;if(i.size>P){n({title:"File too large",description:"Please select an image smaller than 5MB",variant:"destructive"});return}try{b(!0),y(0);const v=le(),X=Date.now(),ee=`profile-images/${(a==null?void 0:a.id)||"unknown"}_${X}_${i.name}`,ae=ne(v,ee),R=de(ae,i);R.on("state_changed",s=>{const C=s.bytesTransferred/s.totalBytes*100;y(Math.round(C))},s=>{console.error("Upload error:",s),n({title:"Upload failed",description:s.message||"Failed to upload image",variant:"destructive"}),b(!1),y(0)},async()=>{try{const s=await ce(R.snapshot.ref);console.log("Image uploaded successfully:",s);const C=await fetch("/api/users/profile",{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({profilePhoto:s})}),U=await C.json();if(!C.ok)throw new Error(U.error||"Failed to update profile photo");if(U.data){const B=localStorage.getItem("user");if(B){const te={...JSON.parse(B),...U.data};localStorage.setItem("user",JSON.stringify(te))}}const $=(a==null?void 0:a._id)||(a==null?void 0:a.id);J.invalidateQueries({queryKey:["/api/profile",$]}),J.invalidateQueries({queryKey:[`/api/profile/${$}`]}),D&&await D(),n({title:"Profile photo updated",description:"Your profile photo has been successfully updated."})}catch(s){console.error("Profile update error:",s),n({title:"Update failed",description:s instanceof Error?s.message:"Failed to update profile photo",variant:"destructive"})}finally{b(!1),y(0)}})}catch(v){console.error("Image upload error:",v),n({title:"Upload failed",description:v instanceof Error?v.message:"Failed to upload image",variant:"destructive"}),b(!1),y(0)}};return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:"w-full p-4 sm:p-6 space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground",children:"Profile"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Manage your account information and preferences"})]}),!r&&e.jsxs(F,{onClick:()=>d(!0),"data-testid":"button-edit-profile",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),"Edit Profile"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6",children:[e.jsxs(O,{className:"lg:col-span-1",children:[e.jsx(G,{children:e.jsxs(z,{className:"flex items-center text-base sm:text-lg",children:[e.jsx(K,{className:"h-5 w-5 mr-2"}),"Profile Picture"]})}),e.jsx(H,{className:"space-y-4",children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsxs(fe,{className:"h-24 w-24","data-testid":"avatar-profile",children:[e.jsx(ue,{src:l==null?void 0:l.profilePhoto}),e.jsxs(ge,{className:"text-lg",children:[(M=l==null?void 0:l.firstName)==null?void 0:M[0],(q=l==null?void 0:l.lastName)==null?void 0:q[0]]})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:L,type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:Z,className:"hidden","data-testid":"input-file-upload"}),e.jsx(F,{variant:"outline",size:"sm",onClick:()=>{var t;return(t=L.current)==null?void 0:t.click()},disabled:T,"data-testid":"button-upload-photo",children:T?e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"h-4 w-4 mr-2 animate-spin"}),"Uploading ",Q,"%"]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Change Photo"]})})]})]})})]}),e.jsxs(O,{className:"lg:col-span-2",children:[e.jsx(G,{children:e.jsxs(z,{className:"flex items-center text-base sm:text-lg",children:[e.jsx(we,{className:"h-5 w-5 mr-2"}),"Profile Information"]})}),e.jsxs(H,{children:[_&&e.jsx(je,{variant:"destructive",className:"mb-6","data-testid":"alert-update-error",children:e.jsx(Ne,{children:_})}),r?e.jsx(xe,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(V),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(h,{control:o.control,name:"firstName",render:({field:t})=>e.jsxs(f,{children:[e.jsx(u,{children:"First Name"}),e.jsx(g,{children:e.jsx(m,{placeholder:"Enter your first name","data-testid":"input-first-name",...t})}),e.jsx(j,{})]})}),e.jsx(h,{control:o.control,name:"lastName",render:({field:t})=>e.jsxs(f,{children:[e.jsx(u,{children:"Last Name"}),e.jsx(g,{children:e.jsx(m,{placeholder:"Enter your last name","data-testid":"input-last-name",...t})}),e.jsx(j,{})]})})]}),e.jsx(h,{control:o.control,name:"userName",render:({field:t})=>e.jsxs(f,{children:[e.jsx(u,{children:"Username"}),e.jsx(g,{children:e.jsx(m,{placeholder:"Enter your username","data-testid":"input-username",...t})}),e.jsx(j,{})]})}),e.jsx(h,{control:o.control,name:"email",render:({field:t})=>e.jsxs(f,{children:[e.jsx(u,{children:"Email Address"}),e.jsx(g,{children:e.jsx(m,{type:"email",placeholder:"Enter your email","data-testid":"input-email",disabled:w,...t})}),w&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Email cannot be changed for ",(a==null?void 0:a.authProvider)==="google"?"Google":"Apple"," accounts"]}),e.jsx(j,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(h,{control:o.control,name:"phone",render:({field:t})=>e.jsxs(f,{children:[e.jsx(u,{children:"Phone Number"}),e.jsx(g,{children:e.jsx(m,{placeholder:"Enter your phone number","data-testid":"input-phone",...t})}),e.jsx(j,{})]})}),e.jsx(h,{control:o.control,name:"country",render:({field:t})=>e.jsxs(f,{children:[e.jsx(u,{children:"Country"}),e.jsx(g,{children:e.jsx(m,{placeholder:"Enter your country","data-testid":"input-country",...t})}),e.jsx(j,{})]})})]}),e.jsx(h,{control:o.control,name:"date_of_birth",render:({field:t})=>e.jsxs(f,{children:[e.jsx(u,{children:"Date of Birth"}),e.jsx(g,{children:e.jsx(m,{type:"date",placeholder:"Select your date of birth","data-testid":"input-date-of-birth",max:new Date().toISOString().split("T")[0],...t})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"You must be at least 18 years old to use this platform"}),e.jsx(j,{})]})}),e.jsx(ye,{className:"my-6"}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(F,{type:"button",variant:"outline",onClick:W,disabled:E,"data-testid":"button-cancel",children:"Cancel"}),e.jsx(F,{type:"submit",disabled:E,"data-testid":"button-save",children:E?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent mr-2"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Save Changes"]})})]})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{className:"text-sm font-medium text-muted-foreground",children:"First Name"}),e.jsx("p",{className:"text-foreground","data-testid":"text-first-name",children:(a==null?void 0:a.firstName)||"Not provided"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{className:"text-sm font-medium text-muted-foreground",children:"Last Name"}),e.jsx("p",{className:"text-foreground","data-testid":"text-last-name",children:(a==null?void 0:a.lastName)||"Not provided"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{className:"text-sm font-medium text-muted-foreground",children:"Username"}),e.jsx("p",{className:"text-foreground","data-testid":"text-username",children:(a==null?void 0:a.userName)||"Not provided"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{className:"text-sm font-medium text-muted-foreground flex items-center",children:[e.jsx(Se,{className:"h-4 w-4 mr-2"}),"Email Address",w&&e.jsxs("span",{className:"ml-2 px-2 py-1 text-xs bg-primary/10 text-primary rounded",children:[(a==null?void 0:a.authProvider)==="google"?"Google":"Apple"," Account"]})]}),e.jsx("p",{className:"text-foreground","data-testid":"text-email",children:(a==null?void 0:a.email)||"Not provided"}),w&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Email is managed by your ",(a==null?void 0:a.authProvider)==="google"?"Google":"Apple"," account"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{className:"text-sm font-medium text-muted-foreground flex items-center",children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Phone Number"]}),e.jsx("p",{className:"text-foreground","data-testid":"text-phone",children:(a==null?void 0:a.phone)||"Not provided"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{className:"text-sm font-medium text-muted-foreground flex items-center",children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Country"]}),e.jsx("p",{className:"text-foreground","data-testid":"text-country",children:(a==null?void 0:a.country)||"Not provided"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{className:"text-sm font-medium text-muted-foreground",children:"Date of Birth"}),e.jsx("p",{className:"text-foreground","data-testid":"text-date-of-birth",children:a!=null&&a.date_of_birth?new Date(a.date_of_birth).toLocaleDateString():"Not provided"})]})]})]})]})]})]})})}export{Je as default};
