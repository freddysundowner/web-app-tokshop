import{aM as _,aN as f,aO as M,aP as B,aQ as j,aR as h,aS as A,aT as F,aU as Q,aV as C,aW as v,aX as L,aY as N,aZ as E,p as D,o as ee,t as se,v as te,a_ as ne,a$ as re}from"./index-FVTY5sKH.js";function fe(t,n,e){try{const s=_(f(),"chats"),c=B(s,j("userIds","array-contains",t)),o=new Map,r=new Map,l=async a=>{const m=a.docs.map(async g=>{var O,x;const u=g.data(),$=g.id,p=((O=u.userIds)==null?void 0:O.find(i=>i!==t))||"",b=(x=u.users)==null?void 0:x.find(i=>i.id===p),J=(b==null?void 0:b.userName)||(b==null?void 0:b.firstName)||"Unknown User",V=(b==null?void 0:b.profilePhoto)||"";if((await q(t,p)).isBlockedByOther)return null;if(p&&!o.has(p)){const i=h(f(),"presence",p),w=M(i,U=>{var k;const S=U.exists()&&((k=U.data())==null?void 0:k.online)===!0;r.set(p,S),l(a)});o.set(p,w)}const X=`last_read_${t}`,Y=u[X]||0,Z=_(f(),"chats",$,"messages"),z=B(Z,A("date","desc")),P=(await F(z)).docs.map(i=>({id:i.id,...i.data()})).filter(i=>i.sender===t||i.sender===p).filter(i=>{const w=typeof i.date=="string"?parseInt(i.date):i.date;return i.sender!==t&&w>Y&&!i.seen}).length,G=i=>{if(!i)return"";let w;i instanceof Q?w=i.toDate():typeof i=="string"?w=new Date(parseInt(i)):w=new Date;const S=new Date().getTime()-w.getTime(),k=Math.floor(S/6e4),H=Math.floor(S/36e5),W=Math.floor(S/864e5);return k<1?"Just now":k<60?`${k}m ago`:H<24?`${H}h ago`:W<7?`${W}d ago`:w.toLocaleDateString()},K=u.lastMessage?I(u.lastMessage)?"ðŸ“· Photo":u.lastMessage:"";return{id:$,userName:J,userAvatar:V,lastMessage:K,timestamp:G(u.lastMessageTime),unread:P>0,unreadCount:P,online:r.get(p)||!1,otherUserId:p}}),R=(await Promise.all(m)).filter(g=>g!==null).filter(g=>g.otherUserId);n(R)},d=M(c,l,a=>{console.error("Error subscribing to chats:",a),e&&e(a)});return()=>{d(),o.forEach(a=>a()),o.clear(),r.clear()}}catch(s){return console.error("Error setting up chat subscription:",s),e&&e(s),()=>{}}}function ue(t,n,e){try{const s=_(f(),"chats",t,"messages"),c=B(s,A("date","asc"));return M(c,r=>{const l=r.docs.map(d=>({id:d.id,...d.data()}));n(l)},r=>{console.error("Error subscribing to messages:",r),e&&e(r)})}catch(s){return console.error("Error setting up messages subscription:",s),e&&e(s),()=>{}}}function ge(t,n,e){try{const s=_(f(),"chats",t,"room_messages");return M(s,o=>{const l=o.docs.map(d=>{const a=d.data(),m=a.name||a.senderName||"Unknown",y=a.senderId||a.sender||"",R=a.image_url||a.senderProfileUrl||"";let g=0;return a.timestamp?a.timestamp.seconds?g=a.timestamp.seconds*1e3:typeof a.timestamp=="number"&&(g=a.timestamp):a.date&&(g=typeof a.date=="string"?parseInt(a.date):a.date),{id:d.id,message:a.message||"",sender:y,senderName:m,senderProfileUrl:R,date:g.toString(),seen:a.seen||!1,mentions:a.mentions||[]}}).sort((d,a)=>{const m=parseInt(d.date)||0,y=parseInt(a.date)||0;return m-y});n(l)},o=>{console.error("Error subscribing to room messages:",o),e&&e(o)})}catch(s){return console.error("Error setting up room messages subscription:",s),e&&e(s),()=>{}}}async function me(t,n,e,s,c="",o=[]){try{const r=_(f(),"chats",t,"room_messages"),l={message:n,senderId:e,name:s,image_url:c,timestamp:N(),seen:!1,mentions:o};return await E(r,l),{success:!0}}catch(r){return console.error("Error sending room message:",r),{success:!1,error:r}}}async function he(t,n,e,s,c){var o,r;try{const l=h(f(),"chats",t),d=await v(l);if(!d.exists())return{success:!1,error:"Chat not found"};const a=d.data(),m=(o=a.userIds)==null?void 0:o.find(u=>u!==e);if(m){const u=await q(e,m);if(u.hasBlockedOther||u.isBlockedByOther)return{success:!1,error:"Cannot send message - user is blocked"}}const y=_(f(),"chats",t,"messages"),R={message:n,sender:e,senderName:s,senderProfileUrl:c,date:Date.now().toString(),seen:!1};await E(y,R);const g=((r=a.users)==null?void 0:r.map(u=>u.id===e?{...u,profilePhoto:c||u.profilePhoto}:u))||[];return await C(l,{lastMessage:I(n)?"ðŸ“· Photo":n,lastMessageTime:N(),lastSender:e,users:g}),{success:!0}}catch(l){return console.error("Error sending message:",l),{success:!1,error:l}}}async function pe(t,n){try{const e=h(f(),"chats",t),s={[`last_read_${n}`]:Date.now()};return await C(e,s),{success:!0}}catch(e){return console.error("Error marking messages as read:",e),{success:!1,error:e}}}async function be(t,n,e,s){try{const c=_(f(),"chats"),o=B(c,j("userIds","array-contains",t)),r=await F(o);for(const d of r.docs){const a=d.data();if(a.userIds&&a.userIds.includes(n))return d.id}return(await E(c,{lastMessage:"",lastMessageTime:N(),lastSender:"",chat_disabled:!1,userIds:[t,n],users:[{id:t,firstName:(e==null?void 0:e.firstName)||"",lastName:(e==null?void 0:e.lastName)||"",userName:(e==null?void 0:e.userName)||"",profilePhoto:(e==null?void 0:e.profilePhoto)||""},{id:n,firstName:(s==null?void 0:s.firstName)||"",lastName:(s==null?void 0:s.lastName)||"",userName:(s==null?void 0:s.userName)||"",profilePhoto:(s==null?void 0:s.profilePhoto)||""}],[`last_read_${t}`]:0,[`last_read_${n}`]:0})).id}catch(c){throw console.error("Error getting or creating chat:",c),c}}async function we(t,n){try{const e=Date.now(),s=`${n}_${e}_${t.name}`,c=D(ee(),`chat_images/${s}`);return await se(c,t),await te(c)}catch(e){throw console.error("Error uploading image:",e),e}}function I(t){return t.toLowerCase().includes("firebasestorage")||t.toLowerCase().endsWith(".jpg")||t.toLowerCase().endsWith(".jpeg")||t.toLowerCase().endsWith(".png")||t.toLowerCase().endsWith(".gif")||t.toLowerCase().endsWith(".webp")}async function ye(t,n){try{const e=h(f(),"blocked_users",t);return await L(e,{blockedUsers:ne(n)},{merge:!0}),!0}catch(e){return console.error("Error blocking user:",e),!1}}async function _e(t,n){try{const e=h(f(),"blocked_users",t);return await C(e,{blockedUsers:re(n)}),!0}catch(e){return console.error("Error unblocking user:",e),!1}}async function q(t,n){var e,s,c,o;try{const r=h(f(),"blocked_users",t),l=await v(r),d=l.exists()&&((s=(e=l.data())==null?void 0:e.blockedUsers)==null?void 0:s.includes(n)),a=h(f(),"blocked_users",n),m=await v(a),y=m.exists()&&((o=(c=m.data())==null?void 0:c.blockedUsers)==null?void 0:o.includes(t));return{hasBlockedOther:d,isBlockedByOther:y}}catch(r){return console.error("Error checking block status:",r),{hasBlockedOther:!1,isBlockedByOther:!1}}}async function T(t,n){try{const e=h(f(),"presence",t);if(await L(e,{online:n,lastSeen:N(),lastUpdate:Date.now()},{merge:!0}),n&&typeof window<"u"){const s=setInterval(async()=>{try{await L(e,{lastUpdate:Date.now()},{merge:!0})}catch(r){console.error("Heartbeat error:",r),clearInterval(s)}},3e4);window.__presenceHeartbeat=s;const c=()=>{document.hidden?T(t,!1):T(t,!0)},o=()=>{const r=JSON.stringify({userId:t,online:!1,timestamp:Date.now()});navigator.sendBeacon("/api/presence/offline",r),T(t,!1)};document.addEventListener("visibilitychange",c),window.addEventListener("beforeunload",o),window.__presenceCleanup=()=>{clearInterval(s),document.removeEventListener("visibilitychange",c),window.removeEventListener("beforeunload",o)}}else!n&&typeof window<"u"&&(window.__presenceHeartbeat&&(clearInterval(window.__presenceHeartbeat),delete window.__presenceHeartbeat),window.__presenceCleanup&&(window.__presenceCleanup(),delete window.__presenceCleanup))}catch(e){console.error("Error updating online status:",e)}}async function ke(t,n,e){try{const s=h(f(),"chats",t);await C(s,{[`typing_${n}`]:e})}catch(s){console.error("Error updating typing status:",s)}}function Me(t,n,e){try{const s=h(f(),"presence",t);return M(s,o=>{if(o.exists()){const r=o.data(),l=r.lastSeen instanceof Q?ae(r.lastSeen.toDate()):"";n({online:r.online||!1,lastSeen:l,typing:!1})}else n({online:!1,lastSeen:"",typing:!1})},o=>{console.error("Error subscribing to presence:",o)})}catch(s){return console.error("Error setting up presence subscription:",s),()=>{}}}function Re(t,n,e,s){try{const c=h(f(),"chats",t);return M(c,r=>{if(r.exists()){const l=r.data(),d=`typing_${n}`;e(l[d]||!1)}},r=>{console.error("Error subscribing to typing status:",r)})}catch(c){return console.error("Error setting up typing subscription:",c),()=>{}}}function ae(t){const n=new Date,e=n.getTime()-t.getTime(),s=Math.floor(e/6e4),c=Math.floor(e/36e5);if(s<1)return"just now";if(s<60)return`${s}m ago`;if(c<24)return`${c}h ago`;const o=new Date(n);return o.setDate(o.getDate()-1),t.toDateString()===o.toDateString()?"yesterday":t.toLocaleDateString()}export{me as a,fe as b,ue as c,q as d,Me as e,Re as f,be as g,ke as h,he as i,we as j,ye as k,_e as l,pe as m,I as n,ge as s,T as u};
