import{a as k,f as T,r as c,j as e,m as y,B as m,n as C}from"./index-FVTY5sKH.js";import{D as $,a as L,b as M,c as B}from"./dialog-A2pFZcsY.js";import{u as I}from"./useQuery-DsZx8GVA.js";import{AddPaymentDialog as U}from"./add-payment-dialog-D5fvnLYl.js";import{C as P}from"./credit-card-BDFvtuhf.js";import{C as q}from"./circle-check-B-MitUmb.js";import{T as z}from"./trash-2-CSnPCayR.js";import"./index-DCmjaWpM.js";function W({open:n,onOpenChange:u,onSuccess:g}){const{user:r,refreshUserData:x}=k(),{toast:l}=T(),[_,h]=c.useState(!1),[p,j]=c.useState(null),[N,v]=c.useState(null),i=(r==null?void 0:r.id)||(r==null?void 0:r._id),{data:w,isLoading:f,refetch:d}=I({queryKey:[`/api/users/paymentmethod/${i}`],enabled:!!i&&n});c.useEffect(()=>{n&&i&&d()},[n,i,d]);const S=()=>{h(!0)},A=async()=>{h(!1),await d(),await x()},E=async t=>{if(r){v(t);try{await C("PUT","/stripe/default",{paymentMethodId:t,userid:i}),l({title:"Default Payment Set",description:"This payment method is now your default."}),await d(),await x()}catch(a){console.error("Failed to set default payment method:",a);let s="Failed to set default payment method. Please try again.";a!=null&&a.message&&(s=a.message),l({title:"Error",description:s,variant:"destructive"})}finally{v(null)}}},F=async t=>{if(r){j(t);try{await C("DELETE","/stripe/remove",{paymentMethodId:t,userid:i}),l({title:"Payment Method Deleted",description:"Your payment method has been removed."}),await d(),await x()}catch(a){console.error("Failed to delete payment method:",a);let s="Failed to delete payment method. Please try again.";a!=null&&a.message&&(s=a.message),l({title:"Error",description:s,variant:"destructive"})}finally{j(null)}}},b=Array.isArray(w)?w:[],D=b.length>0;return e.jsxs(e.Fragment,{children:[e.jsx($,{open:n,onOpenChange:u,children:e.jsxs(L,{className:"sm:max-w-[500px]","data-testid":"dialog-payment-methods",children:[e.jsx(M,{children:e.jsx(B,{children:"Payment Methods"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[f&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(y,{className:"h-8 w-8 mx-auto mb-3 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading payment methods..."})]}),!f&&D&&b.map(t=>e.jsxs("div",{className:"flex items-start gap-3 border rounded-lg p-4 bg-muted/30",children:[e.jsx(P,{className:"h-5 w-5 mt-0.5 text-muted-foreground"}),e.jsxs("div",{className:"flex-1",children:[t.primary&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-green-500"}),e.jsx("p",{className:"font-medium text-sm",children:"Default Payment"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(()=>{const a=t.name||t.brand||t.card_type||t.type||"",s=t.last4||t.lastFour||t.last_four||"",o=a?a.charAt(0).toUpperCase()+a.slice(1):"";return o&&s?`${o} ****${s}`:s?`Card ****${s}`:o?`${o} card on file`:"Payment method on file"})()}),t.expiry&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Expires ",t.expiry]}),!t.primary&&e.jsx(m,{variant:"ghost",size:"sm",onClick:()=>E(t._id),disabled:N===t._id,className:"mt-2 h-7 text-xs","data-testid":`button-set-default-${t._id}`,children:N===t._id?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"h-3 w-3 mr-1 animate-spin"}),"Setting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"h-3 w-3 mr-1"}),"Set as Default"]})})]}),e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>F(t._id),disabled:p===t._id,className:"text-destructive hover:text-destructive hover:bg-destructive/10","data-testid":`button-delete-payment-${t._id}`,children:p===t._id?e.jsx(y,{className:"h-4 w-4 animate-spin"}):e.jsx(z,{className:"h-4 w-4"})})]},t._id)),!f&&!D&&e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(P,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No payment methods added yet"})]}),e.jsx("button",{onClick:S,className:"text-sm text-primary hover:underline","data-testid":"link-add-new-payment",children:"Add new payment method"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(m,{variant:"default",className:"flex-1 bg-secondary text-secondary-foreground rounded-full",onClick:()=>u(!1),"data-testid":"button-cancel-payment-list",children:"Cancel"}),e.jsx(m,{variant:"default",className:"flex-1 bg-primary text-primary-foreground rounded-full",onClick:()=>{u(!1),g&&g()},"data-testid":"button-save-payment-list",children:"Save"})]})]})}),e.jsx(U,{open:_,onOpenChange:h,onSuccess:A})]})}export{W as PaymentMethodListDialog,W as default};
