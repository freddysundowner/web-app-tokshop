import{a as Fe,f as Re,u as $e,r as a,e as ze,j as e,d as m,L as ee,am as Ye,an as se,aq as He,ar as Qe,au as qe,aw as Je,as as Ke}from"./index-DOZKoalF.js";import{I as te}from"./input-CsVTZWQJ.js";import{B as S}from"./button-bCrgsaso.js";import{A as ae,a as re,b as ie}from"./avatar-BNno7OSM.js";import{B as Ve}from"./badge-DdltLmN9.js";import{S as ne}from"./scroll-area-9X8_0Hp9.js";import{D as We,a as _e,b as Ge,c as le}from"./dropdown-menu-D0VRtd9b.js";import{A as oe,b as ce,c as de,d as ue,e as me,f as he,g as fe,h as xe}from"./alert-dialog-Ch03wVJZ.js";import{D as Xe,a as Ze,b as es,c as ss}from"./dialog-D_mWFmtX.js";import{b as ts,c as as,m as rs,d as is,e as ns,f as ls,u as ge,h as I,i as pe,j as os,k as cs,l as ds,n as us}from"./firebase-chat-Bvw3kWwK.js";import{S as je}from"./search-DsOHL3-T.js";import{A as ms}from"./arrow-left-BP7H-sSw.js";import{E as hs}from"./ellipsis-vertical-Y21RyCEq.js";import{S as fs}from"./shield-DQiC2Dos.js";import{B as P}from"./ban-B8-dg3Vx.js";import{L as be}from"./loader-circle-Bz7fq4IJ.js";import{I as xs}from"./image-CyAY67GT.js";import{S as gs}from"./send-Dx4XBAM6.js";import"./index-DwAU5pHh.js";import"./index-BdQq_4o_.js";import"./index-CXm_CZR6.js";import"./index-CYumVO2i.js";import"./index-CxUEmdCc.js";import"./chevron-right-SEiIbCON.js";import"./check-Bj3EYrSG.js";import"./circle-D2uhURtr.js";import"./index-D0GAShZH.js";function Qs(){const{user:o}=Fe(),[,h]=Re("/inbox/:chatId?"),[,L]=$e(),[r,U]=a.useState(null),[f,F]=a.useState(""),[R,Ne]=a.useState(""),[$,C]=a.useState(!1),[d,ve]=a.useState([]),[ye,z]=a.useState([]),[we,D]=a.useState(!0),[j,Y]=a.useState(!1),[b,H]=a.useState(!1),N=a.useRef(null),Q=a.useRef(null),[B,T]=a.useState(!1),[E,ke]=a.useState(!1),[Se,A]=a.useState(!1),[Ie,v]=a.useState(!1),[x,y]=a.useState(!1),[q,Ue]=a.useState(!1),[O,Ce]=a.useState(!1),[J,De]=a.useState(""),[M,K]=a.useState(null),{toast:u}=ze(),t=(o==null?void 0:o._id)||(o==null?void 0:o.id)||"",V=(o==null?void 0:o.userName)||(o==null?void 0:o.firstName)||"User",g=(o==null?void 0:o.profilePhoto)||"";a.useEffect(()=>{if(!t||!g)return;(async()=>{try{const i=Ye(se(),"chats"),l=He(i,Qe("userIds","array-contains",t)),Le=(await qe(l)).docs.map(async w=>{try{const X=w.data().users||[],Z=X.map(k=>k.id===t&&k.profilePhoto!==g?{...k,profilePhoto:g}:k);JSON.stringify(X)!==JSON.stringify(Z)&&(await Je(Ke(se(),"chats",w.id),{users:Z}),console.log("Updated profile photo in chat:",w.id))}catch(G){console.error("Error updating chat:",w.id,G)}});await Promise.all(Le)}catch(i){console.error("Error updating user profile in chats:",i)}})()},[t,g]),a.useEffect(()=>{if(!t){D(!1);return}const s=ts(t,i=>{ve(i),D(!1)},i=>{console.error("Error loading chats:",i),D(!1)});return()=>s()},[t]),a.useEffect(()=>{if(!r){z([]);return}const s=as(r,i=>{const l=i.map(c=>({id:c.id,senderId:c.sender,content:c.message,timestamp:Be(c.date),isOwn:c.sender===t,isImage:us(c.message)}));z(l),setTimeout(()=>{var c;return(c=Q.current)==null?void 0:c.scrollIntoView({behavior:"smooth"})},100)},i=>{console.error("Error loading messages:",i)});return t&&rs(r,t),()=>s()},[r,t]),a.useEffect(()=>{if(!r||!t)return;const s=d.find(i=>i.id===r);s!=null&&s.otherUserId&&is(t,s.otherUserId).then(i=>{T(i.hasBlockedOther),ke(i.isBlockedByOther)})},[r,t,d]),a.useEffect(()=>{if(!r)return;const s=d.find(l=>l.id===r);if(!(s!=null&&s.otherUserId))return;const i=ns(s.otherUserId,l=>{Ue(l.online),De(l.lastSeen)});return()=>i()},[r,d]),a.useEffect(()=>{if(!r)return;const s=d.find(l=>l.id===r);if(!(s!=null&&s.otherUserId))return;const i=ls(r,s.otherUserId,l=>{Ce(l)});return()=>i()},[r,d]),a.useEffect(()=>{if(t)return ge(t,!0),()=>{ge(t,!1)}},[t]),a.useEffect(()=>{if(!r||!t)return;let s;return f?(I(r,t,!0),s=setTimeout(()=>{I(r,t,!1)},3e3)):I(r,t,!1),()=>{s&&clearTimeout(s),r&&I(r,t,!1)}},[f,r,t]),a.useEffect(()=>{const s=h==null?void 0:h.chatId;s&&d.length>0&&d.some(l=>l.id===s)&&(U(s),C(!0))},[h==null?void 0:h.chatId,d]);const Be=s=>new Date(parseInt(s)).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}),Te=d.filter(s=>s.userName.toLowerCase().includes(R.toLowerCase())),n=d.find(s=>s.id===r),p=B||E,W=async()=>{if(f.trim()&&r&&t&&!p&&!j){Y(!0);const s=await pe(r,f.trim(),t,V,g);s.success?F(""):(console.error("Failed to send message:",s.error),u({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"})),Y(!1)}},Ee=async s=>{var l;const i=(l=s.target.files)==null?void 0:l[0];if(!(!i||!r||!t||p)){if(!i.type.startsWith("image/")){u({title:"Invalid file",description:"Please select an image file.",variant:"destructive"});return}if(i.size>5*1024*1024){u({title:"File too large",description:"Please select an image smaller than 5MB.",variant:"destructive"});return}H(!0);try{const c=await os(i,t);await pe(r,c,t,V,g),u({title:"Image sent",description:"Your image has been sent successfully."})}catch(c){console.error("Error uploading image:",c),u({title:"Upload failed",description:"Failed to upload image. Please try again.",variant:"destructive"})}finally{H(!1),N.current&&(N.current.value="")}}},Ae=async()=>{if(!(n!=null&&n.otherUserId)||!t)return;y(!0);const s=await cs(t,n.otherUserId);y(!1),A(!1),s?(T(!0),u({title:"User blocked",description:`You have blocked ${n.userName}. They can no longer send you messages.`})):u({title:"Error",description:"Failed to block user. Please try again.",variant:"destructive"})},Oe=async()=>{if(!(n!=null&&n.otherUserId)||!t)return;y(!0);const s=await ds(t,n.otherUserId);y(!1),v(!1),s?(T(!1),u({title:"User unblocked",description:`You have unblocked ${n.userName}.`})):u({title:"Error",description:"Failed to unblock user. Please try again.",variant:"destructive"})},Me=s=>{U(s),C(!0),L(`/inbox/${s}`)},Pe=()=>{C(!1),U(null),L("/inbox")},_=s=>s.replace("@","").substring(0,2).toUpperCase();return e.jsxs("div",{className:"h-full bg-background","data-testid":"page-inbox",children:[e.jsx("input",{ref:N,type:"file",accept:"image/*",onChange:Ee,className:"hidden"}),e.jsx("div",{className:"flex justify-center w-full h-full",children:e.jsx("div",{className:"w-full lg:w-[90%] h-full",children:we?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading chats..."})}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 h-full",children:[e.jsxs("div",{className:m("lg:col-span-1 border-r border-border bg-card",$&&"hidden lg:block"),children:[e.jsxs("div",{className:"p-4 border-b border-border",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4","data-testid":"text-inbox-title",children:"Messages"}),e.jsxs("div",{className:"relative",children:[e.jsx(je,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(te,{placeholder:"Search conversations...",value:R,onChange:s=>Ne(s.target.value),className:"pl-10","data-testid":"input-search-conversations"})]})]}),e.jsx(ne,{className:"h-[calc(100vh-12rem)]",children:e.jsx("div",{className:"divide-y divide-border",children:Te.map(s=>e.jsxs("button",{onClick:()=>Me(s.id),className:m("w-full p-4 flex items-start gap-3 hover-elevate active-elevate-2 transition-colors text-left",r===s.id&&"bg-muted"),"data-testid":`conversation-${s.id}`,children:[e.jsxs("div",{className:"relative",children:[e.jsxs(ae,{className:"h-12 w-12",children:[e.jsx(re,{src:s.userAvatar}),e.jsx(ie,{children:_(s.userName)})]}),s.online&&e.jsx("span",{className:"absolute bottom-0 right-0 h-3 w-3 bg-green-500 rounded-full border-2 border-card"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:m("text-sm font-medium truncate",s.unread?"text-foreground":"text-muted-foreground"),children:s.userName}),e.jsx("span",{className:"text-xs text-muted-foreground ml-2 flex-shrink-0",children:s.timestamp})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:m("text-sm truncate",s.unread?"font-medium text-foreground":"text-muted-foreground"),children:s.lastMessage}),s.unreadCount&&s.unreadCount>0&&e.jsx(Ve,{variant:"default",className:"ml-2 flex-shrink-0 h-5 min-w-[20px] flex items-center justify-center",children:s.unreadCount})]})]})]},s.id))})})]}),e.jsx("div",{className:m("lg:col-span-2 flex flex-col",!$&&"hidden lg:flex"),children:n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border bg-card flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S,{variant:"ghost",size:"icon",className:"lg:hidden",onClick:Pe,"data-testid":"button-back-to-list",children:e.jsx(ms,{className:"h-5 w-5"})}),e.jsx(ee,{href:`/profile/${n.otherUserId}`,children:e.jsxs(ae,{className:"h-10 w-10 cursor-pointer hover-elevate",children:[e.jsx(re,{src:n.userAvatar}),e.jsx(ie,{children:_(n.userName)})]})}),e.jsxs("div",{children:[e.jsx(ee,{href:`/profile/${n.otherUserId}`,children:e.jsx("p",{className:"font-medium text-foreground hover:underline cursor-pointer","data-testid":"text-conversation-user",children:n.userName})}),!p&&e.jsxs(e.Fragment,{children:[O&&e.jsx("p",{className:"text-xs text-primary italic",children:"typing..."}),!O&&q&&e.jsx("p",{className:"text-xs text-green-600 dark:text-green-400",children:"Online"}),!O&&!q&&J&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Last seen ",J]})]})]})]}),e.jsxs(We,{children:[e.jsx(_e,{asChild:!0,children:e.jsx(S,{variant:"ghost",size:"icon","data-testid":"button-conversation-menu",children:e.jsx(hs,{className:"h-5 w-5"})})}),e.jsx(Ge,{align:"end",children:B?e.jsxs(le,{onClick:()=>v(!0),"data-testid":"menu-item-unblock",children:[e.jsx(fs,{className:"h-4 w-4 mr-2"}),"Unblock User"]}):!E&&e.jsxs(le,{onClick:()=>A(!0),className:"text-destructive","data-testid":"menu-item-block",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Block User"]})})]})]}),p&&e.jsxs("div",{className:"bg-destructive/10 border-y border-destructive/20 p-4 text-center",children:[B&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-destructive",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsxs("span",{children:["You blocked ",n.userName,"."," ",e.jsx("button",{onClick:()=>v(!0),className:"underline font-medium",children:"Unblock"})]})]}),E&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-destructive",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsxs("span",{children:["You have been blocked by ",n.userName]})]})]}),e.jsx(ne,{className:"flex-1 p-4",children:e.jsxs("div",{className:"space-y-4",children:[ye.map(s=>e.jsx("div",{className:m("flex",s.isOwn?"justify-end":"justify-start"),"data-testid":`message-${s.id}`,children:e.jsx("div",{className:m("max-w-[70%] rounded-lg",s.isImage?"p-0":"px-4 py-2",s.isOwn?"bg-primary text-primary-foreground":"bg-muted text-foreground"),children:s.isImage?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s.content,alt:"Chat image",className:"rounded-lg max-w-full h-auto cursor-pointer",onClick:()=>K(s.content),style:{maxHeight:"300px"}}),e.jsx("p",{className:m("text-xs mt-1 px-2 pb-1",s.isOwn?"text-primary-foreground/70 text-right":"text-muted-foreground"),children:s.timestamp})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm",children:s.content}),e.jsx("p",{className:m("text-xs mt-1",s.isOwn?"text-primary-foreground/70":"text-muted-foreground"),children:s.timestamp})]})})},s.id)),e.jsx("div",{ref:Q})]})}),!p&&e.jsxs("div",{className:"p-4 border-t border-border bg-card",children:[b&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-2",children:[e.jsx(be,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Uploading image..."})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>{var s;return(s=N.current)==null?void 0:s.click()},disabled:b,"data-testid":"button-attach-image",children:e.jsx(xs,{className:"h-5 w-5"})}),e.jsx("div",{className:"flex-1",children:e.jsx(te,{placeholder:"Type a message...",value:f,onChange:s=>F(s.target.value),onKeyPress:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),W())},disabled:j||b,className:"resize-none","data-testid":"input-message"})}),e.jsx(S,{onClick:W,disabled:!f.trim()||j||b,"data-testid":"button-send-message",children:j?e.jsx(be,{className:"h-4 w-4 animate-spin"}):e.jsx(gs,{className:"h-4 w-4"})})]})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-center p-8",children:e.jsxs("div",{children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(je,{className:"h-8 w-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No conversation selected"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose a conversation from the list to start messaging"})]})})})]})})}),e.jsx(oe,{open:Se,onOpenChange:A,children:e.jsxs(ce,{children:[e.jsxs(de,{children:[e.jsxs(ue,{children:["Block ",n==null?void 0:n.userName,"?"]}),e.jsx(me,{children:"They won't be able to send you messages anymore. You can unblock them anytime."})]}),e.jsxs(he,{children:[e.jsx(fe,{disabled:x,children:"Cancel"}),e.jsx(xe,{onClick:Ae,disabled:x,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:x?"Blocking...":"Block"})]})]})}),e.jsx(oe,{open:Ie,onOpenChange:v,children:e.jsxs(ce,{children:[e.jsxs(de,{children:[e.jsxs(ue,{children:["Unblock ",n==null?void 0:n.userName,"?"]}),e.jsx(me,{children:"They will be able to send you messages again."})]}),e.jsxs(he,{children:[e.jsx(fe,{disabled:x,children:"Cancel"}),e.jsx(xe,{onClick:Oe,disabled:x,children:x?"Unblocking...":"Unblock"})]})]})}),e.jsx(Xe,{open:!!M,onOpenChange:()=>K(null),children:e.jsxs(Ze,{className:"max-w-4xl",children:[e.jsx(es,{children:e.jsx(ss,{children:"Image Preview"})}),M&&e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("img",{src:M,alt:"Full size",className:"max-w-full max-h-[80vh] object-contain rounded-lg"})})]})})]})}export{Qs as default};
