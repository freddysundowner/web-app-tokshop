import{r as c,a as ge,g as je,d as Ne,j as e,B as m,X as be,A as ye,h as ve,i as Ce,k as we,l as Se,m as Pe,n as Ae,o as De,x as ke,q as I,y as q}from"./index-GnvmivW0.js";import{u as U}from"./useMutation-DAKVWGzI.js";import{C as _,b as Q}from"./card-Bsqf9o7h.js";import{B as Z}from"./badge-CL9MXKGS.js";import{I as ee}from"./input-CDJz7BeV.js";import{S as Fe,a as Oe,b as Me,c as Ee,d as y}from"./select-EUq1_viI.js";import{D as Te,a as $e,b as Le,c as Ie,d as qe,e as Ue}from"./dialog-D1L4tMGI.js";import{C as _e,a as Qe,b as ze,A as Be}from"./collapsible-B-insiOQ.js";import{L as Ke}from"./label-CbaFYhHW.js";import{S as Re}from"./separator-Datc7ShZ.js";import{A as He,a as Ve,b as We}from"./avatar-T6GBhCEI.js";import{S as A,f as Ye}from"./skeleton-DfVG0-vC.js";import{S as Ge}from"./search-DE1AZ4db.js";import{T as Xe}from"./tag-jpmwmyGV.js";import{C as Je}from"./chevron-down-tcDKR_mK.js";import{C as te}from"./chevron-right-CXw-mF7y.js";import{C as Ze}from"./check-DoxmrmEj.js";import{C as et}from"./chevron-left-BnuQCvWV.js";import{f as se}from"./format-Crz72tIO.js";import"./index-BdQq_4o_.js";import"./index-CmYyiKyk.js";import"./index-Vue-pIA6.js";import"./chevron-up-Cda9uppk.js";import"./index-BUngnxKp.js";import"./constructNow-BkTMlMS8.js";import"./en-US-Cc-9gH5A.js";import"./endOfMonth-DAoz7cdb.js";const z={pending:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400",accepted:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400",rejected:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",declined:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",countered:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400",expired:"bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400"},tt=d=>d.charAt(0).toUpperCase()+d.slice(1),st=10;function Ot(){var W;const[d,ae]=c.useState("all"),[D,re]=c.useState(""),[ne,v]=c.useState(!1),[n,B]=c.useState(null),[k,F]=c.useState(""),[ie,le]=c.useState(new Set),[a,p]=c.useState(null),[g,K]=c.useState(1),{user:x}=ge(),{toast:u}=je(),O=(x==null?void 0:x._id)||(x==null?void 0:x.id),{data:f,isLoading:M,error:at,refetch:E}=Ne({queryKey:["/api/offers","seller",O,d,g],queryFn:async()=>{const t=new URLSearchParams;t.set("user",O),t.set("role","seller"),t.set("page",g.toString()),t.set("limit",st.toString()),d!=="all"&&t.set("status",d);const s=await fetch(`/api/offers?${t}`);if(!s.ok)throw new Error("Failed to fetch offers");return s.json()},enabled:!!O,staleTime:0,refetchOnMount:!0}),R=(f==null?void 0:f.products)||[],h=f==null?void 0:f.pagination;h!=null&&h.total||R.length;const C=(h==null?void 0:h.pages)||1,oe=t=>{le(s=>{const i=new Set(s);return i.has(t)?i.delete(t):i.add(t),i})},T=U({mutationFn:async t=>await q("POST","/api/offers/accept",{offerId:t,usertype:"seller"}),onSuccess:()=>{u({title:"Offer accepted successfully"}),I.invalidateQueries({queryKey:["/api/offers"]}),E()},onError:t=>{u({title:"Failed to accept offer",description:t.message,variant:"destructive"})}}),$=U({mutationFn:async t=>await q("POST","/api/offers/reject",{offerId:t,usertype:"seller"}),onSuccess:()=>{u({title:"Offer declined"}),I.invalidateQueries({queryKey:["/api/offers"]}),E()},onError:t=>{u({title:"Failed to decline offer",description:t.message,variant:"destructive"})}}),L=U({mutationFn:async({offerId:t,amount:s})=>await q("POST","/api/offers/counter",{offerId:t,counterPrice:s}),onSuccess:()=>{u({title:"Counter offer sent"}),v(!1),B(null),F(""),I.invalidateQueries({queryKey:["/api/offers"]}),E()},onError:t=>{u({title:"Failed to send counter offer",description:t.message,variant:"destructive"})}}),ce=t=>{p({offer:t,action:"accept"})},de=t=>{p({offer:t,action:"decline"})},ue=()=>{if(!a)return;const t=a.offer._id||a.offer.id;a.action==="accept"?T.mutate(t,{onSettled:()=>p(null)}):$.mutate(t,{onSettled:()=>p(null)})},w=T.isPending||$.isPending,me=(t,s)=>{var i;B({...t,product:s}),F(((i=t.offeredPrice||t.offerAmount)==null?void 0:i.toString())||""),v(!0)},xe=()=>{if(!n||!k)return;const t=parseFloat(k);if(isNaN(t)||t<=0){u({title:"Please enter a valid amount",variant:"destructive"});return}const s=n._id||n.id;L.mutate({offerId:s,amount:t})},H=R.filter(t=>{var s,i;if(D){const l=D.toLowerCase(),S=((s=t.name)==null?void 0:s.toLowerCase())||"",P=(i=t.offers)==null?void 0:i.some(j=>{var o,N;return(((o=j.buyer)==null?void 0:o.userName)||((N=j.buyer)==null?void 0:N.firstName)||"").toLowerCase().includes(l)});if(!S.includes(l)&&!P)return!1}return!0}),V=t=>(t.images||t.productimages||[])[0]||"/placeholder-product.png",fe=t=>{var i,l;return(((i=t.buyer)==null?void 0:i.userName)||((l=t.buyer)==null?void 0:l.firstName)||"U").charAt(0).toUpperCase()},he=t=>(t.offers||[]).filter(s=>s.status==="pending").length,pe=t=>(t.offers||[]).length;return M?e.jsxs("div",{className:"container max-w-7xl py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Offers"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage offers from buyers"})]}),e.jsx("div",{className:"grid gap-4",children:[1,2,3].map(t=>e.jsx(_,{children:e.jsx(Q,{className:"py-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(A,{className:"h-16 w-16 rounded-lg"}),e.jsxs("div",{className:"flex-1",children:[e.jsx(A,{className:"h-4 w-48 mb-2"}),e.jsx(A,{className:"h-3 w-32"})]}),e.jsx(A,{className:"h-8 w-24"})]})})},t))})]}):e.jsxs("div",{className:"container max-w-7xl py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground","data-testid":"text-page-title",children:"Offers"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage offers from buyers on your products"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ge,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ee,{placeholder:"Search by product or buyer...",value:D,onChange:t=>re(t.target.value),className:"pl-10","data-testid":"input-search-offers"})]}),e.jsxs(Fe,{value:d,onValueChange:ae,children:[e.jsx(Oe,{className:"w-full sm:w-[180px]","data-testid":"select-status-filter",children:e.jsx(Me,{placeholder:"Filter by status"})}),e.jsxs(Ee,{children:[e.jsx(y,{value:"all",children:"All Statuses"}),e.jsx(y,{value:"pending",children:"Pending"}),e.jsx(y,{value:"accepted",children:"Accepted"}),e.jsx(y,{value:"rejected",children:"Rejected"}),e.jsx(y,{value:"countered",children:"Countered"})]})]})]}),H.length===0?e.jsx(_,{children:e.jsxs(Q,{className:"py-12 text-center",children:[e.jsx(Xe,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No offers yet"}),e.jsx("p",{className:"text-muted-foreground",children:"When buyers make offers on your products, they'll appear here."})]})}):e.jsx("div",{className:"space-y-4",children:H.map(t=>{var j;const s=t._id||t.id,i=ie.has(s),l=he(t),S=pe(t),P=t.offers||[];return e.jsx(_,{"data-testid":`card-product-${s}`,children:e.jsxs(_e,{open:i,onOpenChange:()=>oe(s),children:[e.jsx(Qe,{asChild:!0,children:e.jsx("div",{className:"cursor-pointer hover-elevate",children:e.jsx(Q,{className:"py-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("img",{src:V(t),alt:t.name||"Product",className:"h-16 w-16 rounded-lg object-cover bg-muted"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-foreground truncate","data-testid":"text-product-name",children:t.name||"Unknown Product"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["List Price: $",((j=t.price)==null?void 0:j.toFixed(2))||"0.00"]}),e.jsxs("div",{className:"flex flex-wrap gap-x-3 gap-y-1 text-xs text-muted-foreground mt-1",children:[t.createdAt&&e.jsxs("span",{children:["Listed: ",se(new Date(t.createdAt),"MMM d, yyyy")]}),t.expiresAt&&e.jsxs("span",{className:new Date(t.expiresAt)<new Date?"text-red-500":"",children:["Expires: ",se(new Date(t.expiresAt),"MMM d, yyyy"),new Date(t.expiresAt)<new Date&&" (Expired)"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"flex items-center gap-2",children:[l>0&&e.jsxs(Z,{className:z.pending,children:[l," pending"]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[S," offer",S!==1?"s":""]})]})}),i?e.jsx(Je,{className:"h-5 w-5 text-muted-foreground"}):e.jsx(te,{className:"h-5 w-5 text-muted-foreground"})]})]})})})}),e.jsxs(ze,{children:[e.jsx(Re,{}),e.jsx("div",{className:"bg-muted/30",children:P.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"No offers for this product"}):e.jsx("div",{className:"divide-y",children:P.map(r=>{var G,X,J;const o=r._id||r.id,N=r.offeredPrice||r.offerAmount||0,Y=t.price?Math.round((1-N/t.price)*100):0;return e.jsx("div",{className:"p-4 hover:bg-muted/50 transition-colors","data-testid":`offer-row-${o}`,children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs(He,{className:"h-10 w-10",children:[e.jsx(Ve,{src:(G=r.buyer)==null?void 0:G.profilePhoto}),e.jsx(We,{children:fe(r)})]}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-foreground",children:["@",((X=r.buyer)==null?void 0:X.userName)||((J=r.buyer)==null?void 0:J.firstName)||"User"]}),e.jsxs("div",{className:"flex items-baseline gap-2 mt-1",children:[e.jsxs("span",{className:"text-lg font-bold text-foreground","data-testid":"text-offer-amount",children:["$",N.toFixed(2)]}),Y>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",Y,"% off)"]})]}),r.counterPrice&&e.jsxs("p",{className:"text-sm text-blue-600 dark:text-blue-400 mt-1",children:["Your counter: $",r.counterPrice.toFixed(2)]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Offered ",r.createdAt?Ye(new Date(r.createdAt),{addSuffix:!0}):"N/A"]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx(Z,{className:z[r.status]||z.pending,children:tt(r.status)}),r.status==="pending"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(m,{size:"sm",variant:"outline",onClick:b=>{b.stopPropagation(),de(r)},disabled:$.isPending,"data-testid":`button-decline-${o}`,children:[e.jsx(be,{className:"h-4 w-4 mr-1"}),"Decline"]}),e.jsxs(m,{size:"sm",variant:"outline",onClick:b=>{b.stopPropagation(),me(r,t)},"data-testid":`button-counter-${o}`,children:[e.jsx(Be,{className:"h-4 w-4 mr-1"}),"Counter"]}),e.jsxs(m,{size:"sm",onClick:b=>{b.stopPropagation(),ce(r)},disabled:T.isPending,"data-testid":`button-accept-${o}`,children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"}),"Accept"]})]}),r.status==="countered"&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Waiting for buyer response"})]})]})})]})},o)})})})]})]})},s)})}),C>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Page ",g," of ",C]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>K(t=>Math.max(1,t-1)),disabled:g===1||M,"data-testid":"button-prev-page",children:[e.jsx(et,{className:"h-4 w-4 mr-1"}),"Previous"]}),e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>K(t=>Math.min(C,t+1)),disabled:g===C||M,"data-testid":"button-next-page",children:["Next",e.jsx(te,{className:"h-4 w-4 ml-1"})]})]})]}),e.jsx(Te,{open:ne,onOpenChange:v,children:e.jsxs($e,{children:[e.jsxs(Le,{children:[e.jsx(Ie,{children:"Make Counter Offer"}),e.jsxs(qe,{children:["Enter a new price to counter the buyer's offer of $",((n==null?void 0:n.offeredPrice)||(n==null?void 0:n.offerAmount)||0).toFixed(2)]})]}),e.jsx("div",{className:"py-4",children:e.jsxs("div",{className:"space-y-4",children:[(n==null?void 0:n.product)&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted rounded-lg",children:[e.jsx("img",{src:V(n.product),alt:n.product.name,className:"h-12 w-12 rounded object-cover"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:n.product.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["List Price: $",(W=n.product.price)==null?void 0:W.toFixed(2)]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ke,{htmlFor:"counter-amount",children:"Your Counter Price ($)"}),e.jsx(ee,{id:"counter-amount",type:"number",step:"0.01",min:"0",value:k,onChange:t=>F(t.target.value),placeholder:"Enter counter price","data-testid":"input-counter-amount"})]})]})}),e.jsxs(Ue,{children:[e.jsx(m,{variant:"outline",onClick:()=>v(!1),children:"Cancel"}),e.jsx(m,{onClick:xe,disabled:L.isPending,"data-testid":"button-submit-counter",children:L.isPending?"Sending...":"Send Counter Offer"})]})]})}),e.jsx(ye,{open:!!a,onOpenChange:t=>!w&&!t&&p(null),children:e.jsxs(ve,{children:[e.jsxs(Ce,{children:[e.jsx(we,{children:(a==null?void 0:a.action)==="accept"?"Accept Offer?":"Decline Offer?"}),e.jsx(Se,{children:(a==null?void 0:a.action)==="accept"?`Accept this offer of $${((a==null?void 0:a.offer.offeredPrice)||(a==null?void 0:a.offer.offerAmount)||0).toFixed(2)}? An order will be created automatically.`:"Are you sure you want to decline this offer?"})]}),e.jsxs(Pe,{children:[e.jsx(Ae,{disabled:w,"data-testid":"button-cancel-action",children:"Cancel"}),e.jsxs(De,{onClick:ue,disabled:w,"data-testid":"button-confirm-action",children:[w?e.jsx(ke,{className:"h-4 w-4 animate-spin mr-2"}):null,(a==null?void 0:a.action)==="accept"?"Accept":"Decline"]})]})]})})]})}export{Ot as default};
