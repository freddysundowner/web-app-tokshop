import{a as J,g as V,u as Z,r as M,d as ee,j as e,B as r,x as _,A as te,h as se,i as ae,k as re,l as ne,m as ce,n as ie,o as le,q as C,y}from"./index-GnvmivW0.js";import{u as w}from"./useMutation-DAKVWGzI.js";import{u as oe,g as de}from"./use-api-config-kum11Yvc.js";import{B as me}from"./badge-CL9MXKGS.js";import{C as v,b as B}from"./card-Bsqf9o7h.js";import{A as xe,a as ue,b as he}from"./avatar-T6GBhCEI.js";import{S as pe,f as ge}from"./skeleton-DfVG0-vC.js";import{T as je,a as fe,b as q,c as n,d as be,e as c}from"./table-DMJOUqQh.js";import{T as k}from"./tag-jpmwmyGV.js";import{C as K}from"./circle-alert-COJng_1I.js";import{R as Q,C as Ne}from"./refresh-cw-DXFTvLUy.js";import{P as Ce}from"./package-DWwkENv3.js";import{C as z}from"./circle-check-big-CLZG244L.js";import{C as H}from"./clock-C8Dw1EBc.js";import{C as ye}from"./chevron-left-BnuQCvWV.js";import{C as we}from"./chevron-right-CXw-mF7y.js";import"./constructNow-BkTMlMS8.js";import"./en-US-Cc-9gH5A.js";import"./endOfMonth-DAoz7cdb.js";const L={pending:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400",accepted:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400",rejected:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",countered:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400",expired:"bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400",completed:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400"},ve={pending:H,accepted:z,rejected:Ne,countered:Q,expired:K,completed:z};function ke(a){return{pending:"Pending",accepted:"Accepted",rejected:"Declined",countered:"Counter",expired:"Expired",completed:"Completed"}[a]||a}const R=10;function Ue(){var T;const{user:a}=J(),{toast:i}=V(),[,p]=Z(),[s,l]=M.useState(null),[m,A]=M.useState(1),{externalApiUrl:U}=oe(),g=(a==null?void 0:a._id)||(a==null?void 0:a.id),{data:o,isLoading:j,error:Y,refetch:P}=ee({queryKey:["/api/offers",{user:g,role:"buyer",page:m,limit:R}],queryFn:async()=>{const t=await fetch(`/api/offers?user=${g}&role=buyer&page=${m}&limit=${R}`);if(!t.ok)throw new Error("Failed to fetch offers");return t.json()},enabled:!!g}),f=w({mutationFn:async t=>y("POST","/api/offers/accept",{offerId:t,usertype:"buyer"}),onSuccess:()=>{i({title:"Counter offer accepted",description:"You can now proceed to checkout."}),C.invalidateQueries({queryKey:["/api/offers"]})},onError:t=>{i({title:"Error",description:t.message||"Failed to accept counter offer",variant:"destructive"})}}),b=w({mutationFn:async t=>y("POST","/api/offers/reject",{offerId:t,usertype:"buyer"}),onSuccess:()=>{i({title:"Counter offer declined",description:"The offer has been withdrawn."}),C.invalidateQueries({queryKey:["/api/offers"]})},onError:t=>{i({title:"Error",description:t.message||"Failed to decline counter offer",variant:"destructive"})}}),S=w({mutationFn:async t=>y("POST","/api/offers/cancel",{offerId:t}),onSuccess:()=>{i({title:"Offer cancelled",description:"Your offer has been withdrawn."}),C.invalidateQueries({queryKey:["/api/offers"]})},onError:t=>{i({title:"Error",description:t.message||"Failed to cancel offer",variant:"destructive"})}}),G=()=>{s&&(s.action==="accept"?f.mutate(s.offer._id,{onSettled:()=>l(null)}):s.action==="reject"?b.mutate(s.offer._id,{onSettled:()=>l(null)}):s.action==="cancel"&&S.mutate(s.offer._id,{onSettled:()=>l(null)}))},x=f.isPending||b.isPending||S.isPending,O=t=>t.images&&t.images.length>0&&de(t.images[0],U)||"https://placehold.co/100x100/e2e8f0/64748b?text=No+Image";if(j)return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(k,{className:"h-5 w-5"}),e.jsx("h1",{className:"text-xl font-bold",children:"My Offers"})]}),e.jsx("div",{className:"space-y-2",children:[1,2,3].map(t=>e.jsx(pe,{className:"h-12 w-full"},t))})]});if(Y)return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(k,{className:"h-5 w-5"}),e.jsx("h1",{className:"text-xl font-bold",children:"My Offers"})]}),e.jsx(v,{children:e.jsxs(B,{className:"p-6 text-center",children:[e.jsx(K,{className:"h-10 w-10 mx-auto text-muted-foreground mb-3"}),e.jsx("p",{className:"text-muted-foreground mb-3",children:"Failed to load offers"}),e.jsx(r,{size:"sm",onClick:()=>P(),"data-testid":"button-retry",children:"Try Again"})]})})]});const N=(o==null?void 0:o.offers)||[],d=o==null?void 0:o.pagination,W=(d==null?void 0:d.total)||N.length,u=(d==null?void 0:d.pages)||1,h=f.isPending||b.isPending;return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-5 w-5"}),e.jsx("h1",{className:"text-xl font-bold",children:"My Offers"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",W,")"]})]}),e.jsx(r,{variant:"ghost",size:"sm",onClick:()=>P(),"data-testid":"button-refresh",children:e.jsx(Q,{className:"h-4 w-4"})})]}),N.length===0?e.jsx(v,{children:e.jsxs(B,{className:"p-6 text-center",children:[e.jsx(Ce,{className:"h-10 w-10 mx-auto text-muted-foreground mb-3"}),e.jsx("h3",{className:"font-semibold mb-1",children:"No offers yet"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"When you make offers on products, they'll appear here."}),e.jsx(r,{size:"sm",onClick:()=>p("/"),"data-testid":"button-browse",children:"Browse Products"})]})}):e.jsx(v,{children:e.jsxs(je,{children:[e.jsx(fe,{children:e.jsxs(q,{children:[e.jsx(n,{className:"w-[300px]",children:"Product"}),e.jsx(n,{children:"Seller"}),e.jsx(n,{className:"text-right",children:"List"}),e.jsx(n,{className:"text-right",children:"Offer"}),e.jsx(n,{className:"text-right",children:"Counter"}),e.jsx(n,{children:"Status"}),e.jsx(n,{children:"When"}),e.jsx(n,{className:"text-right",children:"Actions"})]})}),e.jsx(be,{children:N.map(t=>{var D,F,E,$,I;const X=ve[t.status]||H;return e.jsxs(q,{"data-testid":`row-offer-${t._id}`,children:[e.jsx(c,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:O(t.product),alt:t.product.name,className:"h-10 w-10 rounded object-cover bg-muted cursor-pointer",onClick:()=>p(`/product/${t.product._id}`)}),e.jsx("span",{className:"font-medium truncate max-w-[200px] cursor-pointer hover:text-primary",onClick:()=>p(`/product/${t.product._id}`),"data-testid":"text-product-name",children:t.product.name})]})}),e.jsx(c,{children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs(xe,{className:"h-5 w-5",children:[e.jsx(ue,{src:(D=t.seller)==null?void 0:D.profilePhoto}),e.jsx(he,{className:"text-[10px]",children:(($=(E=(F=t.seller)==null?void 0:F.userName)==null?void 0:E[0])==null?void 0:$.toUpperCase())||"S"})]}),e.jsx("span",{className:"text-sm text-muted-foreground truncate max-w-[100px]",children:((I=t.seller)==null?void 0:I.userName)||"Seller"})]})}),e.jsxs(c,{className:"text-right text-muted-foreground",children:["$",t.product.price.toFixed(2)]}),e.jsxs(c,{className:"text-right font-medium",children:["$",t.offeredPrice.toFixed(2)]}),e.jsx(c,{className:"text-right",children:t.counterPrice?e.jsxs("span",{className:"font-medium text-blue-600 dark:text-blue-400",children:["$",t.counterPrice.toFixed(2)]}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(c,{children:e.jsxs(me,{className:`${L[t.status]||L.pending} text-xs`,children:[e.jsx(X,{className:"h-3 w-3 mr-1"}),ke(t.status)]})}),e.jsx(c,{className:"text-xs text-muted-foreground",children:t.createdAt?ge(new Date(t.createdAt),{addSuffix:!0}):"-"}),e.jsx(c,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[t.status==="pending"&&e.jsx(r,{size:"sm",variant:"ghost",className:"h-7 text-xs text-destructive hover:text-destructive",onClick:()=>l({offer:t,action:"cancel"}),disabled:h,"data-testid":"button-cancel-offer",children:"Cancel"}),t.status==="countered"&&e.jsxs(e.Fragment,{children:[e.jsx(r,{size:"sm",variant:"default",className:"h-7 text-xs",onClick:()=>l({offer:t,action:"accept"}),disabled:h,"data-testid":"button-accept-counter",children:h?e.jsx(_,{className:"h-3 w-3 animate-spin"}):"Accept"}),e.jsx(r,{size:"sm",variant:"ghost",className:"h-7 text-xs",onClick:()=>l({offer:t,action:"reject"}),disabled:h,"data-testid":"button-decline-counter",children:"Decline"})]})]})})]},t._id)})})]})}),u>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Page ",m," of ",u]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>A(t=>Math.max(1,t-1)),disabled:m===1||j,"data-testid":"button-prev-page",children:[e.jsx(ye,{className:"h-4 w-4 mr-1"}),"Previous"]}),e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>A(t=>Math.min(u,t+1)),disabled:m===u||j,"data-testid":"button-next-page",children:["Next",e.jsx(we,{className:"h-4 w-4 ml-1"})]})]})]}),e.jsx(te,{open:!!s,onOpenChange:t=>!x&&!t&&l(null),children:e.jsxs(se,{children:[e.jsxs(ae,{children:[e.jsx(re,{children:(s==null?void 0:s.action)==="accept"?"Accept Counter Offer?":(s==null?void 0:s.action)==="cancel"?"Cancel Offer?":"Decline Counter Offer?"}),e.jsx(ne,{children:(s==null?void 0:s.action)==="accept"?`Accept the seller's counter of $${(T=s==null?void 0:s.offer.counterPrice)==null?void 0:T.toFixed(2)}?`:(s==null?void 0:s.action)==="cancel"?"This will withdraw your offer. You can make a new offer later if you change your mind.":"This will withdraw your offer."})]}),e.jsxs(ce,{children:[e.jsx(ie,{disabled:x,"data-testid":"button-cancel",children:"Go Back"}),e.jsxs(le,{onClick:G,disabled:x,"data-testid":"button-confirm",children:[x?e.jsx(_,{className:"h-4 w-4 animate-spin mr-2"}):null,(s==null?void 0:s.action)==="accept"?"Accept":(s==null?void 0:s.action)==="cancel"?"Cancel Offer":"Decline"]})]})]})})]})}export{Ue as default};
