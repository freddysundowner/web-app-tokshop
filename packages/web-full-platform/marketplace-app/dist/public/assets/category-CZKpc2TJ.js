import{p as V,r as d,g as z,a1 as G,d as I,a8 as H,j as t,L as w,B as _,e as M,y as R}from"./index-GnvmivW0.js";import{u as T}from"./useMutation-DAKVWGzI.js";import{u as J}from"./useInfiniteQuery-BODxHCl1.js";import{S as W}from"./show-card-DLyViQGC.js";import{u as X,g as Y}from"./use-api-config-kum11Yvc.js";import{C as Z}from"./chevron-right-CXw-mF7y.js";import"./avatar-T6GBhCEI.js";import"./user-badge-QQMJS_dE.js";import"./circle-check-big-CLZG244L.js";import"./star-Dvv0yNqt.js";import"./en-US-Cc-9gH5A.js";import"./isTomorrow-DSpd_Oy4.js";import"./constructNow-BkTMlMS8.js";import"./isSameDay-bd8GA9bu.js";import"./format-Crz72tIO.js";function fe(){var E,U,L,S;const[,m]=V("/category/:id"),i=m==null?void 0:m.id,[g,c]=d.useState(!1),{toast:u}=z(),j=G(),{externalApiUrl:$}=X(),{data:n}=I({queryKey:["/api/auth/session"]}),a=((E=n==null?void 0:n.data)==null?void 0:E._id)||((U=n==null?void 0:n.data)==null?void 0:U.id),{data:f}=I({queryKey:["/api/categories"]}),y=(f==null?void 0:f.categories)||[];let s=y.find(e=>e._id===i),l;if(!s)for(const e of y){const r=(L=e.subCategories)==null?void 0:L.find(o=>o._id===i);if(r){s=r,l=e;break}}const{data:x,fetchNextPage:b,hasNextPage:N,isFetchingNextPage:h,isLoading:K}=J({queryKey:["/api/rooms",i],queryFn:async({pageParam:e=1})=>{const r=new URLSearchParams({page:String(e),limit:"20",status:"active"});return i&&r.set("category",i),(await fetch(`/api/rooms?${r}`)).json()},getNextPageParam:(e,r)=>{const o=r.length,A=e.totalDoc||0,C=Math.max(e.limits||20,1),O=Math.ceil(A/C);return o<O?o+1:void 0},initialPageParam:1,enabled:!!i}),P=((S=x==null?void 0:x.pages)==null?void 0:S.flatMap(e=>e.rooms||[]))||[],F=d.useRef(null);d.useEffect(()=>{const e=new IntersectionObserver(o=>{o[0].isIntersecting&&N&&!h&&b()},{threshold:0,rootMargin:"100px"}),r=F.current;return r&&e.observe(r),()=>{r&&e.unobserve(r)}},[N,h,b]);const k=(s==null?void 0:s.subCategories)||[],q=!!l;H((s==null?void 0:s.name)||"Category");const p=T({mutationFn:async()=>{if(!a||!i)throw new Error("User not logged in");return await R("PUT",`/api/category/follow/${i}`,{userid:a})},onSuccess:()=>{c(!0),j.invalidateQueries({queryKey:["/api/categories"]})},onError:e=>{u({title:"Error",description:e.message||"Failed to follow category",variant:"destructive"})}}),v=T({mutationFn:async()=>{if(!a||!i)throw new Error("User not logged in");return await R("PUT",`/api/category/unfollow/${i}`,{userid:a})},onSuccess:()=>{c(!1),j.invalidateQueries({queryKey:["/api/categories"]})},onError:e=>{u({title:"Error",description:e.message||"Failed to unfollow category",variant:"destructive"})}});d.useEffect(()=>{var e;if(s&&a){const r=((e=s.followers)==null?void 0:e.includes(a))||!1;c(r)}else c(!1);window.scrollTo({top:0,behavior:"smooth"})},[i,s,a]);const Q=()=>{if(!a){u({title:"Login Required",description:"Please log in to follow categories",variant:"destructive"});return}g?v.mutate():p.mutate()},B=e=>e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toString();return s?t.jsx("div",{className:"flex flex-col min-h-screen bg-background","data-testid":"page-category",children:t.jsx("main",{className:"flex-1 overflow-y-auto bg-white dark:bg-background",children:t.jsx("div",{className:"flex justify-center w-full",children:t.jsxs("div",{className:"w-full lg:w-[90%] px-2 py-3 lg:p-6",children:[q&&l&&t.jsxs("div",{className:"flex items-center gap-2 mb-3 text-sm","data-testid":"breadcrumb",children:[t.jsx(w,{href:`/category/${l._id}`,className:"text-primary hover:underline",children:l.name}),t.jsx(Z,{className:"h-4 w-4 text-muted-foreground"}),t.jsx("span",{className:"text-muted-foreground",children:s==null?void 0:s.name})]}),t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h1",{className:"text-2xl lg:text-3xl font-bold text-foreground","data-testid":"heading-category",children:s==null?void 0:s.name}),t.jsx(_,{className:M("rounded-full font-semibold px-4 lg:px-6 h-9 lg:h-10",g?"bg-muted text-foreground hover:bg-muted/80":"bg-primary text-primary-foreground hover:bg-primary/90"),onClick:Q,disabled:p.isPending||v.isPending,"data-testid":"button-follow-category",children:p.isPending||v.isPending?"Loading...":g?"Following":"Follow"})]}),!q&&k.length>0&&t.jsx("div",{className:"mb-6 overflow-x-auto scrollbar-hide","data-testid":"subcategories-container",children:t.jsx("div",{className:"flex gap-3",children:k.map(e=>{const r=e.icon?Y(e.icon,$):"";return t.jsx(w,{href:`/category/${e._id}`,className:M("relative flex-shrink-0 h-16 lg:h-20 rounded-lg overflow-hidden transition-all","hover:ring-2 hover:ring-primary"),"data-testid":`subcategory-${e._id}`,children:t.jsxs("div",{className:"relative h-full w-32 lg:w-40",children:[r?t.jsx("img",{src:r,alt:e.name,className:"absolute inset-0 w-full h-full object-cover"}):t.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/20 to-primary/40"}),t.jsx("div",{className:"absolute inset-0 bg-black/30"}),t.jsxs("div",{className:"relative h-full flex flex-col justify-between p-2.5",children:[(e.viewersCount??0)>0&&t.jsxs("div",{className:"flex items-center gap-1 self-start",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-red-600"}),t.jsxs("span",{className:"text-white text-xs font-semibold",children:[B(e.viewersCount??0)," viewers"]})]}),t.jsx("div",{className:"text-white font-bold text-sm text-left leading-tight",children:e.name})]})]})},e._id)})})}),K?t.jsx("div",{className:"flex items-center justify-center h-64",children:t.jsx("p",{className:"text-muted-foreground",children:"Loading shows..."})}):P.length===0?t.jsx("div",{className:"flex items-center justify-center h-64",children:t.jsx("p",{className:"text-muted-foreground",children:"No live shows in this category"})}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-2 lg:gap-4","data-testid":"live-shows-grid",children:P.map(e=>t.jsx(W,{show:e,currentUserId:a||"",variant:"grid",categoryName:s==null?void 0:s.name},e._id))}),t.jsx("div",{ref:F,className:"h-20 flex items-center justify-center mt-4",children:h&&t.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading more shows..."})})]})]})})})}):t.jsx("div",{className:"flex items-center justify-center min-h-screen",children:t.jsxs("div",{className:"text-center",children:[t.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Category not found"}),t.jsx(w,{href:"/browse",children:t.jsx(_,{children:"Back to Browse"})})]})})}export{fe as default};
