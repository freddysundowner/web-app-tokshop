import{c as A,e as W,a as H,r as z,q as U,k as $,j as e}from"./index-DOZKoalF.js";import{D as Y,a as G,b as J,c as V}from"./dialog-D_mWFmtX.js";import{B as u}from"./button-bCrgsaso.js";import{S as f}from"./separator-B5Em_GJT.js";import{u as _}from"./useQuery-48pQeuS3.js";import{u as X}from"./useMutation-BBndlB0x.js";import{C as F}from"./chevron-right-SEiIbCON.js";import{P as Z}from"./plus-CGXGABxL.js";import{C as E}from"./credit-card-dtIe0EYE.js";import{M as ee}from"./map-pin-CsYpw2VJ.js";import{L as I}from"./loader-circle-Bz7fq4IJ.js";import"./index-D0GAShZH.js";import"./index-CxUEmdCc.js";import"./index-CXm_CZR6.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=A("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);function je({open:d,onOpenChange:k,product:s,onOpenPaymentMethods:M,onOpenShippingAddresses:L}){var P,q,Q;const{toast:x}=W(),{user:a}=H(),[n,w]=z.useState(1),[j,C]=z.useState(!1),m=(s==null?void 0:s.quantity)||1,T=m>1,y=(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.id),{data:h}=_({queryKey:[`/api/users/paymentmethod/default/${y}`],enabled:d&&!!y}),r=h!=null&&h.data?h.data:h||null,t=a==null?void 0:a.address,{data:i,isLoading:B}=_({queryKey:["/api/shipping/estimate",s==null?void 0:s._id,n,t==null?void 0:t.id],queryFn:async()=>{if(!(s!=null&&s.shipping_profile)||!t)return{amount:"0.00"};const l=(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.id),c=s._id||s.id;let o="";return typeof s.owner=="string"?o=s.owner:s.owner&&(o=s.owner._id||s.owner.id||""),!o&&s.ownerId&&(o=typeof s.ownerId=="string"?s.ownerId:s.ownerId._id||s.ownerId.id||""),await $("POST","/api/shipping/estimate",{weight:s.shipping_profile.weight,unit:s.shipping_profile.scale||"oz",product:c,owner:o,customer:l,tokshow:s.tokshow,buying_label:!0})},enabled:d&&!!((P=s==null?void 0:s.shipping_profile)!=null&&P.weight)&&!!t&&!!a}),{data:b,isLoading:D}=_({queryKey:["/api/tax/estimate",s==null?void 0:s.id,n],enabled:d&&!!(s!=null&&s.id)});z.useEffect(()=>{d&&(w(1),C(!1))},[d]);const K=()=>{n<m&&w(n+1)},O=()=>{n>1&&w(n-1)},g=((s==null?void 0:s.price)||0)*n,S=parseFloat((i==null?void 0:i.amount)||"0"),N=parseFloat((b==null?void 0:b.tax)||"0"),v=g+S+N,p=X({mutationFn:async()=>{const l=s._id||s.id;let c="";typeof s.owner=="string"?c=s.owner:s.owner&&(c=s.owner._id||s.owner.id||""),!c&&s.ownerId&&(c=typeof s.ownerId=="string"?s.ownerId:s.ownerId._id||s.ownerId.id||"");const o={product:l,status:"processing",shippingFee:parseFloat((i==null?void 0:i.amount)||"0"),servicelevel:(i==null?void 0:i.servicelevel)||"",rate_id:(i==null?void 0:i.rate_id)||"",bundleId:(i==null?void 0:i.bundleId)||"",totalWeightOz:parseFloat((i==null?void 0:i.totalWeightOz)||"0"),seller_shipping_fee_pay:parseFloat((i==null?void 0:i.seller_shipping_fee_pay)||"0"),subtotal:g,tax:parseFloat(N.toString()||"0"),seller:c,buyer:y,quantity:n,total:parseFloat(v.toFixed(2)),color:"",size:"",tokshow:s.tokshow||""};return await $("POST",`/api/orders/${l}`,o)},onSuccess:l=>{x({title:"Purchase Successful!",description:"Your order has been placed"}),U.invalidateQueries({queryKey:["/api/orders"]}),k(!1)},onError:l=>{var o;const c=((o=l==null?void 0:l.response)==null?void 0:o.error)||(l==null?void 0:l.message)||"Failed to complete purchase";x({title:"Purchase Failed",description:c,variant:"destructive"})}}),R=()=>{if(!r){x({title:"No Payment Method",description:"Please add a payment method first",variant:"destructive"});return}if(!t){x({title:"No Address",description:"Please add a shipping address first",variant:"destructive"});return}if(n>m){x({title:"Quantity Error",description:"Quantity exceeds available stock",variant:"destructive"});return}p.mutate()};return e.jsx(Y,{open:d,onOpenChange:k,children:e.jsxs(G,{className:"bg-zinc-900 border-zinc-800 text-white max-w-lg max-h-[90vh] overflow-y-auto [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]",children:[e.jsx(J,{children:e.jsx(V,{className:"text-white text-xl",children:"Buy Now"})}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"flex gap-4",children:[((q=s==null?void 0:s.images)==null?void 0:q[0])&&e.jsx("div",{className:"w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden bg-zinc-800",children:e.jsx("img",{src:s.images[0],alt:s.name,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-base leading-tight mb-1",children:s==null?void 0:s.name}),m>0&&e.jsxs("p",{className:"text-sm text-zinc-400",children:[m," available"]})]})]}),e.jsx(f,{className:"bg-zinc-800"}),T&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>C(!j),className:"w-full flex items-center justify-between py-2 text-sm","data-testid":"button-toggle-quantity",children:[e.jsxs("span",{className:"font-medium",children:["Quantity: ",n]}),e.jsx(F,{className:`h-4 w-4 text-zinc-400 transition-transform ${j?"rotate-90":""}`})]}),j&&e.jsxs("div",{className:"flex items-center gap-4 mt-2",children:[e.jsx(u,{size:"icon",variant:"outline",className:"h-9 w-9 border-zinc-700 bg-zinc-800 text-white hover:bg-zinc-700",onClick:O,disabled:n<=1,"data-testid":"button-decrement-quantity",children:e.jsx(se,{className:"h-4 w-4",style:{color:"white",stroke:"white"}})}),e.jsx("div",{className:"flex-1 text-center",children:e.jsx("span",{className:"text-lg font-bold",children:n})}),e.jsx(u,{size:"icon",variant:"outline",className:"h-9 w-9 border-zinc-700 bg-zinc-800 text-white hover:bg-zinc-700",onClick:K,disabled:n>=m,"data-testid":"button-increment-quantity",children:e.jsx(Z,{className:"h-4 w-4",style:{color:"white",stroke:"white"}})})]})]}),e.jsx(f,{className:"bg-zinc-800"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold mb-2",children:"Payment Method"}),e.jsxs("button",{onClick:M,className:"w-full flex items-center justify-between py-3 hover:bg-zinc-800/50 rounded-lg px-2 transition-colors","data-testid":"button-payment-method",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(E,{className:"h-5 w-5 text-zinc-400"}),r?e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"text-sm",children:[(Q=r.brand)==null?void 0:Q.toUpperCase()," •••• ",r.last4]}),r.exp_month&&r.exp_year&&e.jsxs("p",{className:"text-xs text-zinc-400",children:["Expires ",String(r.exp_month).padStart(2,"0"),"/",r.exp_year]})]}):e.jsx("span",{className:"text-sm text-zinc-400",children:"Add payment method"})]}),e.jsx(F,{className:"h-4 w-4 text-zinc-400"})]})]}),e.jsx(f,{className:"bg-zinc-800"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold mb-2",children:"Shipping Address"}),e.jsxs("button",{onClick:L,className:"w-full flex items-center justify-between py-3 hover:bg-zinc-800/50 rounded-lg px-2 transition-colors","data-testid":"button-shipping-address",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ee,{className:"h-5 w-5 text-zinc-400"}),t?e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"text-sm",children:[(t==null?void 0:t.addrress1)||(t==null?void 0:t.address1)||"Address on file",t.city&&`, ${t.city}`]}),e.jsxs("p",{className:"text-xs text-zinc-400",children:[t.state&&`${t.state} `,t.zipcode]})]}):e.jsx("span",{className:"text-sm text-zinc-400",children:"Add shipping address"})]}),e.jsx(F,{className:"h-4 w-4 text-zinc-400"})]})]}),e.jsx(f,{className:"bg-zinc-800"}),e.jsxs("div",{className:"space-y-2 bg-zinc-800/30 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-zinc-400",children:"Subtotal"}),e.jsxs("span",{className:"font-medium",children:["$",g.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-zinc-400",children:"Shipping"}),B?e.jsx(I,{className:"h-4 w-4 animate-spin"}):e.jsxs("span",{className:"font-medium",children:["$",S.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-zinc-400",children:"Tax"}),D?e.jsx(I,{className:"h-4 w-4 animate-spin"}):e.jsxs("span",{className:"font-medium",children:["$",N.toFixed(2)]})]}),e.jsx(f,{className:"bg-zinc-700 my-2"}),e.jsxs("div",{className:"flex justify-between text-base font-bold",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["$",v.toFixed(2)]})]})]}),e.jsx(u,{className:"w-full h-12 text-base font-bold bg-primary hover:bg-primary/90 text-primary-foreground",onClick:R,disabled:p.isPending||!r||!t,"data-testid":"button-confirm-buy-now",children:p.isPending?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"h-5 w-5 mr-2 animate-spin"}),"Processing..."]}):`Buy Now - $${v.toFixed(2)}`})]})]})})}export{je as BuyNowDialog,je as default};
