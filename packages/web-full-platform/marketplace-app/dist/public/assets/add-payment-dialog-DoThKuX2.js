import{a2 as d,b as Pe,r as B,j as u,B as J,g as ke,a as Oe,y as X}from"./index-GnvmivW0.js";import{D as Re,a as Ae,b as Ne,c as Le,d as _e,e as oe}from"./dialog-D1L4tMGI.js";import{P as l}from"./index-QZHL2phQ.js";var ae="clover",Te=function(e){return e===3?"v3":e},se="https://js.stripe.com",Ie="".concat(se,"/").concat(ae,"/stripe.js"),Ue=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,De=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/;var We=function(e){return Ue.test(e)||De.test(e)},Me=function(){for(var e=document.querySelectorAll('script[src^="'.concat(se,'"]')),t=0;t<e.length;t++){var n=e[t];if(We(n.src))return n}return null},H=function(e){var t="",n=document.createElement("script");n.src="".concat(Ie).concat(t);var o=document.head||document.body;if(!o)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return o.appendChild(n),n},Fe=function(e,t){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"8.5.3",startTime:t})},A=null,I=null,U=null,qe=function(e){return function(t){e(new Error("Failed to load Stripe.js",{cause:t}))}},Be=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},Je=function(e){return A!==null?A:(A=new Promise(function(t,n){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe){t(window.Stripe);return}try{var o=Me();if(!(o&&e)){if(!o)o=H(e);else if(o&&U!==null&&I!==null){var a;o.removeEventListener("load",U),o.removeEventListener("error",I),(a=o.parentNode)===null||a===void 0||a.removeChild(o),o=H(e)}}U=Be(t,n),I=qe(n),o.addEventListener("load",U),o.addEventListener("error",I)}catch(c){n(c);return}}),A.catch(function(t){return A=null,Promise.reject(t)}))},$e=function(e,t,n){if(e===null)return null;var o=t[0],a=o.match(/^pk_test/),c=Te(e.version),f=ae;a&&c!==f&&console.warn("Stripe.js@".concat(c," was loaded on the page, but @stripe/stripe-js@").concat("8.5.3"," expected Stripe.js@").concat(f,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var s=e.apply(void 0,t);return Fe(s,n),s},N,ie=!1,ce=function(){return N||(N=Je(null).catch(function(e){return N=null,Promise.reject(e)}),N)};Promise.resolve().then(function(){return ce()}).catch(function(r){ie||console.warn(r)});var Ve=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];ie=!0;var o=Date.now();return ce().then(function(a){return $e(a,t,o)})};function Q(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(o){return Object.getOwnPropertyDescriptor(r,o).enumerable})),t.push.apply(t,n)}return t}function Z(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Q(Object(t),!0).forEach(function(n){ue(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Q(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function D(r){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?D=function(e){return typeof e}:D=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},D(r)}function ue(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function Ye(r,e){if(r==null)return{};var t={},n=Object.keys(r),o,a;for(a=0;a<n.length;a++)o=n[a],!(e.indexOf(o)>=0)&&(t[o]=r[o]);return t}function ze(r,e){if(r==null)return{};var t=Ye(r,e),n,o;if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(r);for(o=0;o<a.length;o++)n=a[o],!(e.indexOf(n)>=0)&&Object.prototype.propertyIsEnumerable.call(r,n)&&(t[n]=r[n])}return t}function le(r,e){return Ge(r)||Ke(r,e)||Xe(r,e)||He()}function Ge(r){if(Array.isArray(r))return r}function Ke(r,e){var t=r&&(typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"]);if(t!=null){var n=[],o=!0,a=!1,c,f;try{for(t=t.call(r);!(o=(c=t.next()).done)&&(n.push(c.value),!(e&&n.length===e));o=!0);}catch(s){a=!0,f=s}finally{try{!o&&t.return!=null&&t.return()}finally{if(a)throw f}}return n}}function Xe(r,e){if(r){if(typeof r=="string")return ee(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return ee(r,e)}}function ee(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function He(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var h=function(e,t,n){var o=!!n,a=d.useRef(n);d.useEffect(function(){a.current=n},[n]),d.useEffect(function(){if(!o||!e)return function(){};var c=function(){a.current&&a.current.apply(a,arguments)};return e.on(t,c),function(){e.off(t,c)}},[o,t,e,a])},$=function(e){var t=d.useRef(e);return d.useEffect(function(){t.current=e},[e]),t.current},R=function(e){return e!==null&&D(e)==="object"},Qe=function(e){return R(e)&&typeof e.then=="function"},Ze=function(e){return R(e)&&typeof e.elements=="function"&&typeof e.createToken=="function"&&typeof e.createPaymentMethod=="function"&&typeof e.confirmCardPayment=="function"},te="[object Object]",et=function r(e,t){if(!R(e)||!R(t))return e===t;var n=Array.isArray(e),o=Array.isArray(t);if(n!==o)return!1;var a=Object.prototype.toString.call(e)===te,c=Object.prototype.toString.call(t)===te;if(a!==c)return!1;if(!a&&!n)return e===t;var f=Object.keys(e),s=Object.keys(t);if(f.length!==s.length)return!1;for(var S={},y=0;y<f.length;y+=1)S[f[y]]=!0;for(var p=0;p<s.length;p+=1)S[s[p]]=!0;var i=Object.keys(S);if(i.length!==f.length)return!1;var E=e,j=t,x=function(k){return r(E[k],j[k])};return i.every(x)},de=function(e,t,n){return R(e)?Object.keys(e).reduce(function(o,a){var c=!R(t)||!et(e[a],t[a]);return n.includes(a)?(c&&console.warn("Unsupported prop change: options.".concat(a," is not a mutable property.")),o):c?Z(Z({},o||{}),{},ue({},a,e[a])):o},null):null},pe="Invalid prop `stripe` supplied to `Elements`. We recommend using the `loadStripe` utility from `@stripe/stripe-js`. See https://stripe.com/docs/stripe-js/react#elements-props-stripe for details.",re=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:pe;if(e===null||Ze(e))return e;throw new Error(t)},tt=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:pe;if(Qe(e))return{tag:"async",stripePromise:Promise.resolve(e).then(function(o){return re(o,t)})};var n=re(e,t);return n===null?{tag:"empty"}:{tag:"sync",stripe:n}},rt=function(e){!e||!e._registerWrapper||!e.registerAppInfo||(e._registerWrapper({name:"react-stripe-js",version:"5.4.1"}),e.registerAppInfo({name:"react-stripe-js",version:"5.4.1",url:"https://stripe.com/docs/stripe-js/react"}))},W=d.createContext(null);W.displayName="ElementsContext";var fe=function(e,t){if(!e)throw new Error("Could not find Elements context; You need to wrap the part of your app that ".concat(t," in an <Elements> provider."));return e},me=function(e){var t=e.stripe,n=e.options,o=e.children,a=d.useMemo(function(){return tt(t)},[t]),c=d.useState(function(){return{stripe:a.tag==="sync"?a.stripe:null,elements:a.tag==="sync"?a.stripe.elements(n):null}}),f=le(c,2),s=f[0],S=f[1];d.useEffect(function(){var i=!0,E=function(x){S(function(P){return P.stripe?P:{stripe:x,elements:x.elements(n)}})};return a.tag==="async"&&!s.stripe?a.stripePromise.then(function(j){j&&i&&E(j)}):a.tag==="sync"&&!s.stripe&&E(a.stripe),function(){i=!1}},[a,s,n]);var y=$(t);d.useEffect(function(){y!==null&&y!==t&&console.warn("Unsupported prop change on Elements: You cannot change the `stripe` prop after setting it.")},[y,t]);var p=$(n);return d.useEffect(function(){if(s.elements){var i=de(n,p,["clientSecret","fonts"]);i&&s.elements.update(i)}},[n,p,s.elements]),d.useEffect(function(){rt(s.stripe)},[s.stripe]),d.createElement(W.Provider,{value:s},o)};me.propTypes={stripe:l.any,options:l.object};var nt=function(e){var t=d.useContext(W);return fe(t,e)},ot=function(){var e=nt("calls useElements()"),t=e.elements;return t};l.func.isRequired;var ve=d.createContext(null);ve.displayName="CheckoutContext";l.any,l.shape({clientSecret:l.oneOfType([l.string,l.instanceOf(Promise)]).isRequired,elementsOptions:l.object}).isRequired;var V=function(e){var t=d.useContext(ve),n=d.useContext(W);if(t){if(n)throw new Error("You cannot wrap the part of your app that ".concat(e," in both <CheckoutProvider> and <Elements> providers."));return t}else return fe(n,e)},at=["mode"],st=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},g=function(e,t){var n="".concat(st(e),"Element"),o=function(s){var S=s.id,y=s.className,p=s.options,i=p===void 0?{}:p,E=s.onBlur,j=s.onFocus,x=s.onReady,P=s.onChange,k=s.onEscape,L=s.onClick,M=s.onLoadError,he=s.onLoaderStart,ye=s.onNetworksChange,ge=s.onConfirm,be=s.onCancel,Se=s.onShippingAddressChange,Ee=s.onShippingRateChange,xe=s.onSavedPaymentMethodRemove,Ce=s.onSavedPaymentMethodUpdate,_=V("mounts <".concat(n,">")),T="elements"in _?_.elements:null,O="checkoutState"in _?_.checkoutState:null,C=(O==null?void 0:O.type)==="success"||(O==null?void 0:O.type)==="loading"?O.sdk:null,je=d.useState(null),Y=le(je,2),v=Y[0],we=Y[1],w=d.useRef(null),F=d.useRef(null);h(v,"blur",E),h(v,"focus",j),h(v,"escape",k),h(v,"click",L),h(v,"loaderror",M),h(v,"loaderstart",he),h(v,"networkschange",ye),h(v,"confirm",ge),h(v,"cancel",be),h(v,"shippingaddresschange",Se),h(v,"shippingratechange",Ee),h(v,"savedpaymentmethodremove",xe),h(v,"savedpaymentmethodupdate",Ce),h(v,"change",P);var q;x&&(e==="expressCheckout"?q=x:q=function(){x(v)}),h(v,"ready",q),d.useLayoutEffect(function(){if(w.current===null&&F.current!==null&&(T||C)){var m=null;if(C)switch(e){case"paymentForm":m=C.createPaymentFormElement();break;case"payment":m=C.createPaymentElement(i);break;case"address":if("mode"in i){var G=i.mode,K=ze(i,at);if(G==="shipping")m=C.createShippingAddressElement(K);else if(G==="billing")m=C.createBillingAddressElement(K);else throw new Error("Invalid options.mode. mode must be 'billing' or 'shipping'.")}else throw new Error("You must supply options.mode. mode must be 'billing' or 'shipping'.");break;case"expressCheckout":m=C.createExpressCheckoutElement(i);break;case"currencySelector":m=C.createCurrencySelectorElement();break;case"taxId":m=C.createTaxIdElement(i);break;default:throw new Error("Invalid Element type ".concat(n,". You must use either the <PaymentElement />, <AddressElement options={{mode: 'shipping'}} />, <AddressElement options={{mode: 'billing'}} />, or <ExpressCheckoutElement />."))}else T&&(m=T.create(e,i));w.current=m,we(m),m&&m.mount(F.current)}},[T,C,i]);var z=$(i);return d.useEffect(function(){if(w.current){var m=de(i,z,["paymentRequest"]);m&&"update"in w.current&&w.current.update(m)}},[i,z]),d.useLayoutEffect(function(){return function(){if(w.current&&typeof w.current.destroy=="function")try{w.current.destroy(),w.current=null}catch{}}},[]),d.createElement("div",{id:S,className:y,ref:F})},a=function(s){V("mounts <".concat(n,">"));var S=s.id,y=s.className;return d.createElement("div",{id:S,className:y})},c=t?a:o;return c.propTypes={id:l.string,className:l.string,onChange:l.func,onBlur:l.func,onFocus:l.func,onReady:l.func,onEscape:l.func,onClick:l.func,onLoadError:l.func,onLoaderStart:l.func,onNetworksChange:l.func,onConfirm:l.func,onCancel:l.func,onShippingAddressChange:l.func,onShippingRateChange:l.func,onSavedPaymentMethodRemove:l.func,onSavedPaymentMethodUpdate:l.func,options:l.object},c.displayName=n,c.__elementType=e,c},b=typeof window>"u",it=d.createContext(null);it.displayName="EmbeddedCheckoutProviderContext";var ct=function(){var e=V("calls useStripe()"),t=e.stripe;return t};g("auBankAccount",b);var ne=g("card",b);g("cardNumber",b);g("cardExpiry",b);g("cardCvc",b);g("iban",b);g("payment",b);g("expressCheckout",b);g("paymentRequestButton",b);g("linkAuthentication",b);g("address",b);g("shippingAddress",b);g("paymentMethodMessaging",b);g("taxId",b);function ut({onSuccess:r,onClose:e}){const t=ct(),n=ot(),{toast:o}=ke(),{user:a}=Oe(),[c,f]=B.useState(!1),s=async S=>{if(S.preventDefault(),!t||!n||!a)return;const y=n.getElement(ne);if(y){f(!0);try{const p=a,i=p.email;if(!i)throw new Error("User email not found. Please contact support.");const j=await(await X("POST","/stripe/setupitent",{email:i})).json(),{clientSecret:x,customer_id:P}=j;if(!x)throw new Error("Failed to initialize payment setup. Please try again.");if(!P)throw new Error("Customer ID not found. Please contact support.");const{error:k,setupIntent:L}=await t.confirmCardSetup(x,{payment_method:{card:y}});if(k)throw new Error(k.message);if(!L||!L.payment_method)throw new Error("Failed to set up payment method");const M={customer_id:P,userid:p.id||p._id};await X("POST","/stripe/savepaymentmethod",M),o({title:"Card Added",description:"Your payment method has been saved successfully."}),r&&r(),e()}catch(p){console.error("Failed to add payment method:",p);let i="Failed to add payment method. Please try again.";if(p!=null&&p.text)try{const E=JSON.parse(p.text);i=E.error||E.message||i}catch{typeof p.text=="string"&&(i=p.text)}else p!=null&&p.message&&(i=p.message);o({title:"Error",description:i,variant:"destructive"})}finally{f(!1)}}};return u.jsxs("form",{onSubmit:s,children:[u.jsx("div",{className:"space-y-4 py-4",children:u.jsxs("div",{className:"space-y-2",children:[u.jsx("label",{className:"text-sm font-medium leading-none",children:"Card Details"}),u.jsx("div",{className:"border rounded-md p-3 bg-background",children:u.jsx(ne,{options:{style:{base:{fontSize:"16px",color:"hsl(var(--foreground))","::placeholder":{color:"hsl(var(--muted-foreground))"}},invalid:{color:"hsl(var(--destructive))"}}}})})]})}),u.jsxs(oe,{className:"flex-col sm:flex-row gap-2",children:[u.jsx(J,{type:"button",variant:"outline",onClick:e,disabled:c,"data-testid":"button-cancel",className:"w-full sm:w-auto",children:"Cancel"}),u.jsx(J,{type:"submit",disabled:!t||c,"data-testid":"button-add-card",className:"w-full sm:w-auto bg-primary hover:bg-primary/90 text-primary-foreground",children:c?"Adding...":"Add Card"})]})]})}function ft({open:r,onOpenChange:e,onSuccess:t}){const{settings:n}=Pe(),[o,a]=B.useState(null);B.useEffect(()=>{n.stripe_publishable_key&&a(Ve(n.stripe_publishable_key))},[n.stripe_publishable_key]);const c={mode:"setup",currency:"usd",appearance:{theme:"stripe"}},f=n.stripe_publishable_key&&n.stripe_publishable_key.trim().length>0;return u.jsx(Re,{open:r,onOpenChange:e,children:u.jsxs(Ae,{className:"sm:max-w-md","data-testid":"dialog-add-payment",children:[u.jsxs(Ne,{children:[u.jsx(Le,{children:"Add Payment Method"}),u.jsx(_e,{children:"Enter your card details to add a new payment method."})]}),f?o?u.jsx(me,{stripe:o,options:c,children:u.jsx(ut,{onSuccess:t,onClose:()=>e(!1)})}):u.jsx("div",{className:"py-8 text-center text-muted-foreground",children:"Loading payment form..."}):u.jsxs("div",{className:"py-8 px-4 space-y-4",children:[u.jsxs("div",{className:"text-center",children:[u.jsx("div",{className:"w-12 h-12 rounded-full bg-destructive/10 flex items-center justify-center mx-auto mb-4",children:u.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-destructive",children:[u.jsx("circle",{cx:"12",cy:"12",r:"10"}),u.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),u.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})}),u.jsx("h3",{className:"font-semibold text-foreground mb-2",children:"Payment System Not Configured"}),u.jsx("p",{className:"text-sm text-muted-foreground",children:"Stripe payment processing is not configured. Please contact the administrator to set up payment processing."})]}),u.jsx(oe,{children:u.jsx(J,{type:"button",variant:"outline",onClick:()=>e(!1),"data-testid":"button-close",className:"w-full",children:"Close"})})]})]})})}export{ft as AddPaymentDialog,ft as default};
