import{aH as _,aI as g,aJ as C,aK as L,aL as U,aM as E,aN as M,aO as j,aP as p,aQ as A,aR as F,aS as R,aT as P,aU as v,C as D,z as ee,D as se,E as te,aV as ne,aW as oe}from"./index-GnvmivW0.js";function de(t,n,e){try{const s=_(g(),"chats"),r=U(s,j("userIds","array-contains",t)),c=new Map,o=new Map,f=async d=>{const a=d.docs.map(async m=>{var x,H;const i=m.data(),$=m.id,w=((x=i.userIds)==null?void 0:x.find(l=>l!==t))||"",y=(H=i.users)==null?void 0:H.find(l=>l.id===w),V=(y==null?void 0:y.userName)||(y==null?void 0:y.firstName)||"Unknown User",z=(y==null?void 0:y.profilePhoto)||"";if((await q(t,w)).isBlockedByOther)return null;if(w&&!c.has(w)){const l=p(g(),"presence",w),k=M(l,B=>{var N;const S=B.exists()&&((N=B.data())==null?void 0:N.online)===!0;o.set(w,S),f(d)});c.set(w,k)}const K=`last_read_${t}`,G=i[K]||0,X=_(g(),"chats",$,"messages"),Y=U(X,E("date","desc")),O=(await A(Y)).docs.map(l=>({id:l.id,...l.data()})).filter(l=>l.sender===t||l.sender===w).filter(l=>{const k=typeof l.date=="string"?parseInt(l.date):l.date;return l.sender!==t&&k>G&&!l.seen}).length,Z=l=>{if(!l)return"";let k;l instanceof F?k=l.toDate():typeof l=="string"?k=new Date(parseInt(l)):k=new Date;const S=new Date().getTime()-k.getTime(),N=Math.floor(S/6e4),W=Math.floor(S/36e5),Q=Math.floor(S/864e5);return N<1?"Just now":N<60?`${N}m ago`:W<24?`${W}h ago`:Q<7?`${Q}d ago`:k.toLocaleDateString()},I=i.lastMessage?J(i.lastMessage)?"ðŸ“· Photo":i.lastMessage:"";return{id:$,userName:V,userAvatar:z,lastMessage:I,timestamp:Z(i.lastMessageTime),unread:O>0,unreadCount:O,online:o.get(w)||!1,otherUserId:w}}),b=(await Promise.all(a)).filter(m=>m!==null).filter(m=>m.otherUserId);n(b)},u=M(r,f,d=>{console.error("Error subscribing to chats:",d),e&&e(d)});return()=>{u(),c.forEach(d=>d()),c.clear(),o.clear()}}catch(s){return console.error("Error setting up chat subscription:",s),e&&e(s),()=>{}}}function me(t,n,e){try{const s=_(g(),"chats",t,"messages"),r=U(s,E("date","asc"));return M(r,o=>{const f=o.docs.map(u=>({id:u.id,...u.data()}));n(f)},o=>{console.error("Error subscribing to messages:",o),e&&e(o)})}catch(s){return console.error("Error setting up messages subscription:",s),e&&e(s),()=>{}}}function ge(t,n,e){try{const s=_(g(),"chats",t,"room_messages"),r=U(s,E("timestamp","asc"));return M(r,o=>{const u=o.docs.map(d=>{const a=d.data(),h=a.name||a.senderName||"Unknown",b=a.senderId||a.sender||"",m=a.image_url||a.senderProfileUrl||"";let i=0;return a.timestamp?a.timestamp.seconds?i=a.timestamp.seconds*1e3:typeof a.timestamp=="number"&&(i=a.timestamp):a.date&&(i=typeof a.date=="string"?parseInt(a.date):a.date),i===0&&(i=Date.now()),{id:d.id,message:a.message||"",sender:b,senderName:h,senderProfileUrl:m,date:i.toString(),seen:a.seen||!1,mentions:a.mentions||[]}}).sort((d,a)=>{const h=parseInt(d.date)||Date.now(),b=parseInt(a.date)||Date.now();return h-b});n(u)},o=>{console.error("Error subscribing to room messages:",o),e&&e(o)})}catch(s){return console.error("Error setting up room messages subscription:",s),e&&e(s),()=>{}}}async function ue(t,n,e,s,r="",c=[]){try{const o=_(g(),"chats",t,"room_messages"),f={message:n,senderId:e,name:s,image_url:r,timestamp:C(),seen:!1,mentions:c};return await L(o,f),{success:!0}}catch(o){return console.error("Error sending room message:",o),{success:!1,error:o}}}async function he(t,n,e,s,r){var c,o;try{const f=p(g(),"chats",t),u=await P(f);if(!u.exists())return{success:!1,error:"Chat not found"};const d=u.data(),a=(c=d.userIds)==null?void 0:c.find(i=>i!==e);if(a){const i=await q(e,a);if(i.hasBlockedOther||i.isBlockedByOther)return{success:!1,error:"Cannot send message - user is blocked"}}const h=_(g(),"chats",t,"messages"),b={message:n,sender:e,senderName:s,senderProfileUrl:r,date:Date.now().toString(),seen:!1};await L(h,b);const m=((o=d.users)==null?void 0:o.map(i=>i.id===e?{...i,profilePhoto:r||i.profilePhoto}:i))||[];return await R(f,{lastMessage:J(n)?"ðŸ“· Photo":n,lastMessageTime:C(),lastSender:e,users:m}),{success:!0}}catch(f){return console.error("Error sending message:",f),{success:!1,error:f}}}async function pe(t,n){try{const e=p(g(),"chats",t),s={[`last_read_${n}`]:Date.now()};return await R(e,s),{success:!0}}catch(e){return console.error("Error marking messages as read:",e),{success:!1,error:e}}}async function we(t,n,e,s){try{const r=_(g(),"chats"),c=U(r,j("userIds","array-contains",t)),o=await A(c);for(const u of o.docs){const d=u.data();if(d.userIds&&d.userIds.includes(n)){const a=d.users||[];let h=!1;const b=a.map(m=>m.id===t&&e&&!m.userName&&e.userName?(h=!0,{...m,...e}):m.id===n&&s&&!m.userName&&s.userName?(h=!0,{...m,...s}):m);if(a.length<2){h=!0;const m=[a.find(i=>i.id===t)||{id:t,firstName:(e==null?void 0:e.firstName)||"",lastName:(e==null?void 0:e.lastName)||"",userName:(e==null?void 0:e.userName)||"",profilePhoto:(e==null?void 0:e.profilePhoto)||""},a.find(i=>i.id===n)||{id:n,firstName:(s==null?void 0:s.firstName)||"",lastName:(s==null?void 0:s.lastName)||"",userName:(s==null?void 0:s.userName)||"",profilePhoto:(s==null?void 0:s.profilePhoto)||""}];await R(p(g(),"chats",u.id),{users:m})}else h&&await R(p(g(),"chats",u.id),{users:b});return u.id}}return(await L(r,{lastMessage:"",lastMessageTime:C(),lastSender:"",chat_disabled:!1,userIds:[t,n],users:[{id:t,firstName:(e==null?void 0:e.firstName)||"",lastName:(e==null?void 0:e.lastName)||"",userName:(e==null?void 0:e.userName)||"",profilePhoto:(e==null?void 0:e.profilePhoto)||""},{id:n,firstName:(s==null?void 0:s.firstName)||"",lastName:(s==null?void 0:s.lastName)||"",userName:(s==null?void 0:s.userName)||"",profilePhoto:(s==null?void 0:s.profilePhoto)||""}],[`last_read_${t}`]:0,[`last_read_${n}`]:0})).id}catch(r){throw console.error("Error getting or creating chat:",r),r}}async function be(t,n){try{const e=Date.now(),s=`${n}_${e}_${t.name}`,r=D(ee(),`chat_images/${s}`);return await se(r,t),await te(r)}catch(e){throw console.error("Error uploading image:",e),e}}function J(t){return t.toLowerCase().includes("firebasestorage")||t.toLowerCase().endsWith(".jpg")||t.toLowerCase().endsWith(".jpeg")||t.toLowerCase().endsWith(".png")||t.toLowerCase().endsWith(".gif")||t.toLowerCase().endsWith(".webp")}async function ye(t,n){try{const e=p(g(),"blocked_users",t);return await v(e,{blockedUsers:ne(n)},{merge:!0}),!0}catch(e){return console.error("Error blocking user:",e),!1}}async function ke(t,n){try{const e=p(g(),"blocked_users",t);return await R(e,{blockedUsers:oe(n)}),!0}catch(e){return console.error("Error unblocking user:",e),!1}}async function q(t,n){var e,s,r,c;try{const o=p(g(),"blocked_users",t),f=await P(o),u=f.exists()&&((s=(e=f.data())==null?void 0:e.blockedUsers)==null?void 0:s.includes(n)),d=p(g(),"blocked_users",n),a=await P(d),h=a.exists()&&((c=(r=a.data())==null?void 0:r.blockedUsers)==null?void 0:c.includes(t));return{hasBlockedOther:u,isBlockedByOther:h}}catch(o){return console.error("Error checking block status:",o),{hasBlockedOther:!1,isBlockedByOther:!1}}}async function T(t,n){try{const e=p(g(),"presence",t);if(await v(e,{online:n,lastSeen:C(),lastUpdate:Date.now()},{merge:!0}),n&&typeof window<"u"){const s=setInterval(async()=>{try{await v(e,{lastUpdate:Date.now()},{merge:!0})}catch(o){console.error("Heartbeat error:",o),clearInterval(s)}},3e4);window.__presenceHeartbeat=s;const r=()=>{document.hidden?T(t,!1):T(t,!0)},c=()=>{const o=JSON.stringify({userId:t,online:!1,timestamp:Date.now()});navigator.sendBeacon("/api/presence/offline",o),T(t,!1)};document.addEventListener("visibilitychange",r),window.addEventListener("beforeunload",c),window.__presenceCleanup=()=>{clearInterval(s),document.removeEventListener("visibilitychange",r),window.removeEventListener("beforeunload",c)}}else!n&&typeof window<"u"&&(window.__presenceHeartbeat&&(clearInterval(window.__presenceHeartbeat),delete window.__presenceHeartbeat),window.__presenceCleanup&&(window.__presenceCleanup(),delete window.__presenceCleanup))}catch(e){console.error("Error updating online status:",e)}}async function _e(t,n,e){try{const s=p(g(),"chats",t);await R(s,{[`typing_${n}`]:e})}catch(s){console.error("Error updating typing status:",s)}}function Ne(t,n,e){try{const s=p(g(),"presence",t);return M(s,c=>{if(c.exists()){const o=c.data(),f=o.lastSeen instanceof F?re(o.lastSeen.toDate()):"";n({online:o.online||!1,lastSeen:f,typing:!1})}else n({online:!1,lastSeen:"",typing:!1})},c=>{console.error("Error subscribing to presence:",c)})}catch(s){return console.error("Error setting up presence subscription:",s),()=>{}}}function Me(t,n,e,s){try{const r=p(g(),"chats",t);return M(r,o=>{if(o.exists()){const f=o.data(),u=`typing_${n}`;e(f[u]||!1)}},o=>{console.error("Error subscribing to typing status:",o)})}catch(r){return console.error("Error setting up typing subscription:",r),()=>{}}}function re(t){const n=new Date,e=n.getTime()-t.getTime(),s=Math.floor(e/6e4),r=Math.floor(e/36e5);if(s<1)return"just now";if(s<60)return`${s}m ago`;if(r<24)return`${r}h ago`;const c=new Date(n);return c.setDate(c.getDate()-1),t.toDateString()===c.toDateString()?"yesterday":t.toLocaleDateString()}export{ge as a,de as b,me as c,q as d,Ne as e,Me as f,we as g,_e as h,he as i,be as j,ye as k,ke as l,pe as m,J as n,ue as s,T as u};
