import{e as Q,a as G,r as l,j as e,k as T}from"./index-DOZKoalF.js";import{D as W,a as X,b as ee,c as te,d as fe,e as pe}from"./dialog-D_mWFmtX.js";import{B as N}from"./button-bCrgsaso.js";import{u as ne}from"./useQuery-48pQeuS3.js";import{A as ge}from"./add-payment-dialog-B6ASp9Xp.js";import{L as $}from"./loader-circle-Bz7fq4IJ.js";import{C as ie}from"./credit-card-dtIe0EYE.js";import{C as re}from"./circle-check-1L9G8IjR.js";import{T as oe}from"./trash-2-DlPQcTq2.js";import{I as q}from"./input-CsVTZWQJ.js";import{L as z}from"./label-CmdcELDJ.js";import{S as K,a as R,b as Z,c as J,d as U}from"./select-fROaTUpr.js";import{C as ye,S as V,a as de}from"./city-BO9769IJ.js";import{M as le}from"./map-pin-CsYpw2VJ.js";function je({open:S,onOpenChange:y,onSuccess:F,address:s}){const{toast:x}=Q(),{user:j}=G(),u=j,[f,E]=l.useState(!1),p=!!s,[w,A]=l.useState(""),[g,k]=l.useState(""),[v,h]=l.useState(""),[c,b]=l.useState(""),[L,_]=l.useState(""),[C,D]=l.useState(""),[i,n]=l.useState(""),[o,a]=l.useState(""),[m,P]=l.useState(""),[ce,se]=l.useState(""),[Y,me]=l.useState([]),[B,I]=l.useState([]),[ae,M]=l.useState([]);l.useEffect(()=>{const t=ye.getAllCountries();if(me(t),s){se(s.name||""),A(s.addrress1||s.address1||""),k(s.addrress2||s.address2||""),n(s.city||""),_(s.state||""),a(s.zipcode||s.zip||""),P(s.phone||"");const d=t.find(r=>r.isoCode===s.countryCode||r.name===s.country);if(d){h(d.name),b(d.isoCode);const r=V.getStatesOfCountry(d.isoCode);I(r);const H=r.find(O=>O.name===s.state||O.isoCode===s.stateCode);if(H){D(H.isoCode);const O=de.getCitiesOfState(d.isoCode,H.isoCode);M(O)}}}else{const d=t.find(r=>r.isoCode==="US");if(d&&!v){h(d.name),b(d.isoCode);const r=V.getStatesOfCountry(d.isoCode);I(r)}}},[s]),l.useEffect(()=>{if(c){const t=V.getStatesOfCountry(c);I(t),s||(_(""),D(""),n(""),M([]))}},[c]),l.useEffect(()=>{if(c&&C){const t=de.getCitiesOfState(c,C);M(t),s||n("")}},[c,C]);const ue=async()=>{if(!w||!v||!L||!i||!o||!m){x({title:"Missing Information",description:"Please fill in all required fields.",variant:"destructive"});return}E(!0);try{const t={name:ce||(u==null?void 0:u.firstName)||"Default",addrress1:w,addrress2:g,country:v,city:i,countryCode:c,zipcode:o,state:L,stateCode:C,userId:u==null?void 0:u.id,phone:m.trim().replace(/\s/g,""),email:(u==null?void 0:u.email)||"",primary:(s==null?void 0:s.primary)||!1,applying:!1};p&&s._id?(await T("PUT",`/api/address/${s._id}`,t),x({title:"Address Updated",description:"Your shipping address has been updated successfully."})):(await T("POST","/api/address",t),x({title:"Address Added",description:"Your shipping address has been saved successfully."})),A(""),k("");const d=Y.find(r=>r.isoCode==="US");if(d){h(d.name),b(d.isoCode);const r=V.getStatesOfCountry(d.isoCode);I(r)}_(""),D(""),n(""),M([]),a(""),P(""),se(""),F&&F(),y(!1)}catch(t){console.error("Failed to add/update address:",t);let d=p?"Failed to update address. Please try again.":"Failed to add address. Please try again.";if(t!=null&&t.text)try{const r=JSON.parse(t.text);d=r.error||r.message||d}catch{typeof t.text=="string"&&(d=t.text)}else t!=null&&t.message&&(d=t.message);x({title:"Error",description:d,variant:"destructive"})}finally{E(!1)}},he=t=>{const d=Y.find(r=>r.isoCode===t);d&&(h(d.name),b(d.isoCode))},xe=t=>{const d=B.find(r=>r.isoCode===t);d&&(_(d.name),D(d.isoCode))};return e.jsx(W,{open:S,onOpenChange:y,children:e.jsxs(X,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto","data-testid":"dialog-add-address",children:[e.jsxs(ee,{children:[e.jsx(te,{children:p?"Edit Address":"Add New Address"}),e.jsx(fe,{children:p?"Update your shipping address.":"Add a new shipping or billing address."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"street-address",children:"Street Address"}),e.jsx(q,{id:"street-address",placeholder:"123 Main Street",value:w,onChange:t=>A(t.target.value),"data-testid":"input-street-address"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"street-address-2",children:"Street Address 2 (Optional)"}),e.jsx(q,{id:"street-address-2",placeholder:"Apt, Suite, Unit, etc.",value:g,onChange:t=>k(t.target.value),"data-testid":"input-street-address-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"country",children:"Country"}),e.jsxs(K,{value:c,onValueChange:he,children:[e.jsx(R,{id:"country","data-testid":"select-country",children:e.jsx(Z,{placeholder:"Select country"})}),e.jsx(J,{className:"z-[9999] max-h-[200px]",children:Y.map(t=>e.jsx(U,{value:t.isoCode,children:t.name},t.isoCode))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"state",children:"State/Province"}),e.jsxs(K,{value:C,onValueChange:xe,disabled:!c,children:[e.jsx(R,{id:"state","data-testid":"select-state",children:e.jsx(Z,{placeholder:"Select state/province"})}),e.jsx(J,{className:"z-[9999] max-h-[200px]",children:B.length>0?B.map(t=>e.jsx(U,{value:t.isoCode,children:t.name},t.isoCode)):e.jsx(U,{value:"none",disabled:!0,children:"No states available"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"city",children:"City"}),e.jsxs(K,{value:i,onValueChange:t=>n(t),disabled:!C,children:[e.jsx(R,{id:"city","data-testid":"select-city",children:e.jsx(Z,{placeholder:"Select city"})}),e.jsx(J,{className:"z-[9999] max-h-[200px]",children:ae.length>0?ae.map(t=>e.jsx(U,{value:t.name,children:t.name},t.name)):e.jsx(U,{value:"none",disabled:!0,children:"No cities available"})})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"zip",children:"ZIP/Postal Code"}),e.jsx(q,{id:"zip",placeholder:"10001",value:o,onChange:t=>a(t.target.value),"data-testid":"input-zip"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"phone",children:"Phone Number"}),e.jsx(q,{id:"phone",placeholder:"+1 (555) 123-4567",value:m,onChange:t=>P(t.target.value),"data-testid":"input-phone"})]})]}),e.jsxs(pe,{className:"flex-col sm:flex-row gap-2",children:[e.jsx(N,{variant:"outline",onClick:()=>y(!1),disabled:f,"data-testid":"button-cancel",className:"w-full sm:w-auto",children:"Cancel"}),e.jsx(N,{onClick:ue,disabled:f,"data-testid":"button-add-address",className:"w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-black",children:f?p?"Updating...":"Adding...":p?"Update Address":"Add Address"})]})]})})}function Le({open:S,onOpenChange:y,onSuccess:F}){const{user:s,refreshUserData:x}=G(),{toast:j}=Q(),[u,f]=l.useState(!1),[E,p]=l.useState(null),[w,A]=l.useState(null),g=(s==null?void 0:s.id)||(s==null?void 0:s._id),{data:k,isLoading:v,refetch:h}=ne({queryKey:[`/api/users/paymentmethod/${g}`],enabled:!!g&&S});l.useEffect(()=>{S&&g&&h()},[S,g,h]);const c=()=>{f(!0)},b=async()=>{f(!1),await h(),await x()},L=async i=>{if(s){A(i);try{await T("PUT","/stripe/default",{paymentMethodId:i,userid:g}),j({title:"Default Payment Set",description:"This payment method is now your default."}),await h(),await x()}catch(n){console.error("Failed to set default payment method:",n);let o="Failed to set default payment method. Please try again.";n!=null&&n.message&&(o=n.message),j({title:"Error",description:o,variant:"destructive"})}finally{A(null)}}},_=async i=>{if(s){p(i);try{await T("DELETE","/stripe/remove",{paymentMethodId:i,userid:g}),j({title:"Payment Method Deleted",description:"Your payment method has been removed."}),await h(),await x()}catch(n){console.error("Failed to delete payment method:",n);let o="Failed to delete payment method. Please try again.";n!=null&&n.message&&(o=n.message),j({title:"Error",description:o,variant:"destructive"})}finally{p(null)}}},C=Array.isArray(k)?k:[],D=C.length>0;return e.jsxs(e.Fragment,{children:[e.jsx(W,{open:S,onOpenChange:y,children:e.jsxs(X,{className:"sm:max-w-[500px]","data-testid":"dialog-payment-methods",children:[e.jsx(ee,{children:e.jsx(te,{children:"Payment Methods"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[v&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx($,{className:"h-8 w-8 mx-auto mb-3 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading payment methods..."})]}),!v&&D&&C.map(i=>e.jsxs("div",{className:"flex items-start gap-3 border rounded-lg p-4 bg-muted/30",children:[e.jsx(ie,{className:"h-5 w-5 mt-0.5 text-muted-foreground"}),e.jsxs("div",{className:"flex-1",children:[i.primary&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-green-500"}),e.jsx("p",{className:"font-medium text-sm",children:"Default Payment"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(()=>{const n=i.name||i.brand||i.card_type||i.type||"",o=i.last4||i.lastFour||i.last_four||"",a=n?n.charAt(0).toUpperCase()+n.slice(1):"";return a&&o?`${a} ****${o}`:o?`Card ****${o}`:a?`${a} card on file`:"Payment method on file"})()}),i.expiry&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Expires ",i.expiry]}),!i.primary&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>L(i._id),disabled:w===i._id,className:"mt-2 h-7 text-xs","data-testid":`button-set-default-${i._id}`,children:w===i._id?e.jsxs(e.Fragment,{children:[e.jsx($,{className:"h-3 w-3 mr-1 animate-spin"}),"Setting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-3 w-3 mr-1"}),"Set as Default"]})})]}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>_(i._id),disabled:E===i._id,className:"text-destructive hover:text-destructive hover:bg-destructive/10","data-testid":`button-delete-payment-${i._id}`,children:E===i._id?e.jsx($,{className:"h-4 w-4 animate-spin"}):e.jsx(oe,{className:"h-4 w-4"})})]},i._id)),!v&&!D&&e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ie,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No payment methods added yet"})]}),e.jsx("button",{onClick:c,className:"text-sm text-primary hover:underline","data-testid":"link-add-new-payment",children:"Add new payment method"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(N,{variant:"default",className:"flex-1 bg-black text-white hover:bg-black/90 dark:bg-white dark:text-black dark:hover:bg-white/90 rounded-full",onClick:()=>y(!1),"data-testid":"button-cancel-payment-list",children:"Cancel"}),e.jsx(N,{variant:"default",className:"flex-1 bg-yellow-400 text-black hover:bg-yellow-500 dark:bg-yellow-400 dark:text-black dark:hover:bg-yellow-500 rounded-full",onClick:()=>{y(!1),F&&F()},"data-testid":"button-save-payment-list",children:"Save"})]})]})}),e.jsx(ge,{open:u,onOpenChange:f,onSuccess:b})]})}function $e({open:S,onOpenChange:y,onSuccess:F}){const{user:s,refreshUserData:x}=G(),{toast:j}=Q(),[u,f]=l.useState(!1),[E,p]=l.useState(null),[w,A]=l.useState(null),[g,k]=l.useState(null),v=(s==null?void 0:s._id)||(s==null?void 0:s.id),{data:h,isLoading:c,refetch:b}=ne({queryKey:[`/api/address/all/${v}`],enabled:!!v&&S}),L=a=>{p(a),f(!0)},_=()=>{p(null),f(!0)},C=async()=>{f(!1),await b(),await x()},D=async a=>{if(s){k(a);try{await T("PATCH",`/api/address/${a}`,{primary:!0,userId:v}),j({title:"Default Address Set",description:"This address is now your default."}),await b(),await x()}catch(m){console.error("Failed to set default address:",m);let P="Failed to set default address. Please try again.";m!=null&&m.message&&(P=m.message),j({title:"Error",description:P,variant:"destructive"})}finally{k(null)}}},i=async a=>{if(s){A(a);try{await T("DELETE",`/api/address/${a}`,{}),j({title:"Address Deleted",description:"Your address has been removed."}),await b(),await x()}catch(m){console.error("Failed to delete address:",m);let P="Failed to delete address. Please try again.";m!=null&&m.message&&(P=m.message),j({title:"Error",description:P,variant:"destructive"})}finally{A(null)}}},n=Array.isArray(h)?h:[],o=n.length>0;return e.jsxs(e.Fragment,{children:[e.jsx(W,{open:S,onOpenChange:y,children:e.jsxs(X,{className:"sm:max-w-[500px]","data-testid":"dialog-addresses",children:[e.jsx(ee,{children:e.jsx(te,{children:"Shipping Addresses"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[c&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx($,{className:"h-8 w-8 mx-auto mb-3 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading addresses..."})]}),!c&&o&&n.map(a=>e.jsxs("div",{className:"flex items-start gap-3 border rounded-lg p-4 bg-muted/30",children:[e.jsx(le,{className:"h-5 w-5 mt-0.5 text-muted-foreground"}),e.jsxs("div",{className:"flex-1",children:[a.primary&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-green-500"}),e.jsx("p",{className:"font-medium text-sm",children:"Default Address"})]}),e.jsx("p",{className:"text-sm font-medium",children:a.name||"Address"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.addrress1||a.address1}),a.addrress2&&e.jsx("p",{className:"text-sm text-muted-foreground",children:a.addrress2}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[a.city,", ",a.state," ",a.zipcode||a.zip]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.countryCode}),a.phone&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Phone: ",a.phone]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>L(a),className:"h-7 text-xs","data-testid":`button-edit-address-${a._id}`,children:"Edit"}),!a.primary&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>D(a._id),disabled:g===a._id,className:"h-7 text-xs","data-testid":`button-set-default-address-${a._id}`,children:g===a._id?e.jsxs(e.Fragment,{children:[e.jsx($,{className:"h-3 w-3 mr-1 animate-spin"}),"Setting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-3 w-3 mr-1"}),"Set as Default"]})})]})]}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>i(a._id),disabled:w===a._id,className:"text-destructive hover:text-destructive hover:bg-destructive/10","data-testid":`button-delete-address-${a._id}`,children:w===a._id?e.jsx($,{className:"h-4 w-4 animate-spin"}):e.jsx(oe,{className:"h-4 w-4"})})]},a._id)),!c&&!o&&e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(le,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No addresses added yet"})]}),e.jsx("button",{onClick:_,className:"text-sm text-primary hover:underline","data-testid":"link-add-new-address",children:"Add new shipping address"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(N,{variant:"default",className:"flex-1 bg-black text-white hover:bg-black/90 dark:bg-white dark:text-black dark:hover:bg-white/90 rounded-full",onClick:()=>y(!1),"data-testid":"button-cancel-address-list",children:"Cancel"}),e.jsx(N,{variant:"default",className:"flex-1 bg-yellow-400 text-black hover:bg-yellow-500 dark:bg-yellow-400 dark:text-black dark:hover:bg-yellow-500 rounded-full",onClick:()=>{y(!1),F&&F()},"data-testid":"button-save-address-list",children:"Save"})]})]})}),e.jsx(je,{open:u,onOpenChange:f,onSuccess:C,address:E})]})}export{je as A,Le as P,$e as a};
