import{b as te,a as re,ad as ae,u as oe,r as f,a8 as ie,j as e,e as x,x as M,L as Q}from"./index-GnvmivW0.js";import{u as ne}from"./useInfiniteQuery-BODxHCl1.js";import{A as W,a as z,b as K}from"./avatar-T6GBhCEI.js";import{C as G}from"./card-Bsqf9o7h.js";import{C as j}from"./checkbox-ZrZ7F-Dx.js";import{S as de,B as le}from"./show-card-DLyViQGC.js";import{u as H,g as T}from"./use-api-config-kum11Yvc.js";import{C as D}from"./chevron-up-Cda9uppk.js";import{C as O}from"./chevron-down-tcDKR_mK.js";import{S as ce}from"./search-DE1AZ4db.js";import{P as me}from"./package-DWwkENv3.js";import{S as ue}from"./shopping-bag-DVKU65dg.js";import"./index-Vue-pIA6.js";import"./check-DoxmrmEj.js";import"./user-badge-QQMJS_dE.js";import"./circle-check-big-CLZG244L.js";import"./star-Dvv0yNqt.js";import"./en-US-Cc-9gH5A.js";import"./isTomorrow-DSpd_Oy4.js";import"./constructNow-BkTMlMS8.js";import"./isSameDay-bd8GA9bu.js";import"./format-Crz72tIO.js";const xe=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t);function he({product:t}){var d,c,r,N,w;const{externalApiUrl:n}=H(),h=(d=t.images)!=null&&d[0]?T(t.images[0],n):"",l=((c=t.ownerId)==null?void 0:c.userName)||((r=t.ownerId)==null?void 0:r.firstName)||"Seller",m=(N=t.ownerId)!=null&&N.profilePhoto?T(t.ownerId.profilePhoto,n):"";return e.jsx(Q,{href:`/product/${t._id}`,children:e.jsxs(G,{className:"group hover-elevate active-elevate-2 cursor-pointer overflow-hidden border-border","data-testid":`card-product-${t._id}`,children:[e.jsx("div",{className:"relative aspect-square bg-muted overflow-hidden",children:h?e.jsx("img",{src:h,alt:t.name,className:"w-full h-full object-cover","data-testid":`img-product-${t._id}`}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gradient-to-br from-muted to-muted/50",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 text-muted-foreground/40",children:[e.jsx(me,{className:"h-16 w-16",strokeWidth:1.5}),e.jsx(ue,{className:"h-8 w-8 -mt-4",strokeWidth:1.5})]})})}),e.jsxs("div",{className:"p-3 space-y-2",children:[e.jsx("h3",{className:"font-medium text-sm text-foreground line-clamp-2 min-h-[2.5rem]","data-testid":`text-product-name-${t._id}`,children:t.name}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-bold text-foreground","data-testid":`text-price-${t._id}`,children:xe(t.price)}),t.quantity&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Qty: ",t.quantity]})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-1 border-t border-border",children:[e.jsxs(W,{className:"h-5 w-5",children:[e.jsx(z,{src:m,alt:l}),e.jsx(K,{className:"bg-primary text-primary-foreground text-xs",children:(w=l[0])==null?void 0:w.toUpperCase()})]}),e.jsx("p",{className:"text-xs text-muted-foreground truncate","data-testid":`text-seller-${t._id}`,children:l})]})]})]})})}function pe({user:t}){var m;const{externalApiUrl:n}=H(),h=t.profilePhoto?T(t.profilePhoto,n):"",l=t.firstName&&t.lastName?`${t.firstName} ${t.lastName}`:t.userName||"User";return e.jsx(Q,{href:`/profile/${t._id}`,children:e.jsx(G,{className:"group hover-elevate active-elevate-2 cursor-pointer p-4","data-testid":`card-user-${t._id}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(W,{className:"h-12 w-12",children:[e.jsx(z,{src:h,alt:l}),e.jsx(K,{className:"bg-primary text-primary-foreground",children:(m=l[0])==null?void 0:m.toUpperCase()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-foreground truncate","data-testid":`text-username-${t._id}`,children:l}),t.userName&&e.jsxs("p",{className:"text-xs text-muted-foreground mb-0.5",children:["@",t.userName]}),t.badgeTier&&e.jsx("div",{className:"mb-1",children:e.jsx(le,{badgeTier:t.badgeTier,size:14,showText:!0})}),t.bio&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-1",children:t.bio})]})]})})})}function Be(){var A;const{settings:t}=te(),{user:n}=re(),h=ae(),[,l]=oe(),m=f.useRef(null),d=new URLSearchParams(h),c=d.get("q")||"",r=d.get("filter")||"all",[N,w]=f.useState("relevant"),v=d.get("live")==="true",y=d.get("upcoming")==="true",S=d.get("freeShipping")==="true",C=d.get("reducedShipping")==="true",[k,J]=f.useState(!0),[P,V]=f.useState(!0),X=(n==null?void 0:n._id)||(n==null?void 0:n.id)||"";ie(c?`Search: ${c} - ${t.app_name}`:`Search - ${t.app_name}`);const{data:i,fetchNextPage:L,hasNextPage:U,isFetchingNextPage:$,isLoading:g,error:F}=ne({queryKey:["/api/products/search",c,r,v,y,S,C],staleTime:0,gcTime:0,queryFn:async({pageParam:s=1})=>{const a=new URLSearchParams({q:c,page:String(s),limit:"20",type:r});v&&(a.set("started","true"),a.set("ended","false")),y&&(a.set("started","false"),a.set("ended","false")),S&&a.set("freeShipping","true"),C&&a.set("reducedShipping","true");const o=await fetch(`/api/products/search?${a.toString()}`);if(!o.ok)throw new Error("Search failed");return o.json()},getNextPageParam:s=>{const a=s.pagination.page;let o=0;return r==="products"?o=s.results.products.pages:r==="shows"?o=s.results.shows.pages:r==="users"?o=s.results.users.pages:o=Math.max(s.results.products.pages,s.results.shows.pages,s.results.users.pages),a<o?a+1:void 0},initialPageParam:1,enabled:!!c});f.useEffect(()=>{if(!m.current||!U||$)return;const s=new IntersectionObserver(a=>{a[0].isIntersecting&&L()},{threshold:.1});return s.observe(m.current),()=>s.disconnect()},[U,$,L]);const _=(i==null?void 0:i.pages.flatMap(s=>{var a;return((a=s.results.products)==null?void 0:a.data)||[]}))||[],R=(i==null?void 0:i.pages.flatMap(s=>{var a;return((a=s.results.shows)==null?void 0:a.data)||[]}))||[],I=(i==null?void 0:i.pages.flatMap(s=>{var a;return((a=s.results.users)==null?void 0:a.data)||[]}))||[],p=((A=i==null?void 0:i.pages[0])==null?void 0:A.results)||{products:{total:0},shows:{total:0},users:{total:0}},u=s=>{d.set("filter",s),l(`/search?${d.toString()}`)},b=(s,a)=>{const o=new URLSearchParams(h);a?o.set(s,"true"):o.delete(s),l(`/search?${o.toString()}`)},Y=r==="all"||r==="products",Z=r==="all"||r==="shows",ee=r==="all"||r==="users",se=(()=>{var s,a,o,E,q,B;return r==="products"?((s=p.products)==null?void 0:s.total)||0:r==="shows"?((a=p.shows)==null?void 0:a.total)||0:r==="users"?((o=p.users)==null?void 0:o.total)||0:(((E=p.products)==null?void 0:E.total)||0)+(((q=p.shows)==null?void 0:q.total)||0)+(((B=p.users)==null?void 0:B.total)||0)})();return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"flex justify-center w-full",children:e.jsx("div",{className:"w-full lg:w-[90%]",children:e.jsxs("div",{className:"flex gap-6 px-4 md:px-6 lg:px-8 py-6",children:[e.jsxs("div",{className:"hidden md:block flex-shrink-0 w-64 space-y-6 sticky top-6 self-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-foreground mb-3",children:"Filter by"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>u("all"),className:x("w-full text-left px-3 py-2 rounded-md text-sm transition-colors",r==="all"?"bg-foreground text-background font-medium":"text-foreground hover:bg-muted"),"data-testid":"filter-all",children:"Top"}),e.jsx("button",{onClick:()=>u("products"),className:x("w-full text-left px-3 py-2 rounded-md text-sm transition-colors",r==="products"?"bg-foreground text-background font-medium":"text-foreground hover:bg-muted"),"data-testid":"filter-products",children:"Products"}),e.jsx("button",{onClick:()=>u("shows"),className:x("w-full text-left px-3 py-2 rounded-md text-sm transition-colors",r==="shows"?"bg-foreground text-background font-medium":"text-foreground hover:bg-muted"),"data-testid":"filter-shows",children:"Shows"}),e.jsx("button",{onClick:()=>u("users"),className:x("w-full text-left px-3 py-2 rounded-md text-sm transition-colors",r==="users"?"bg-foreground text-background font-medium":"text-foreground hover:bg-muted"),"data-testid":"filter-users",children:"Users"})]})]}),(r==="shows"||r==="all")&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"border-t border-border pt-6",children:[e.jsxs("button",{onClick:()=>J(!k),className:"w-full flex items-center justify-between mb-3","data-testid":"toggle-time-of-show",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Time of Show"}),k?e.jsx(D,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(O,{className:"h-4 w-4 text-muted-foreground"})]}),k&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{id:"live",checked:v,onCheckedChange:s=>b("live",s),"data-testid":"checkbox-live"}),e.jsx("label",{htmlFor:"live",className:"text-sm text-foreground cursor-pointer",children:"Live"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{id:"upcoming",checked:y,onCheckedChange:s=>b("upcoming",s),"data-testid":"checkbox-upcoming"}),e.jsx("label",{htmlFor:"upcoming",className:"text-sm text-foreground cursor-pointer",children:"Upcoming"})]})]})]}),e.jsxs("div",{className:"border-t border-border pt-6",children:[e.jsxs("button",{onClick:()=>V(!P),className:"w-full flex items-center justify-between mb-3","data-testid":"toggle-shipping",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Reduced Shipping"}),P?e.jsx(D,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(O,{className:"h-4 w-4 text-muted-foreground"})]}),P&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{id:"free",checked:S,onCheckedChange:s=>b("freeShipping",s),"data-testid":"checkbox-free"}),e.jsx("label",{htmlFor:"free",className:"text-sm text-foreground cursor-pointer",children:"FREE"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{id:"reduced",checked:C,onCheckedChange:s=>b("reducedShipping",s),"data-testid":"checkbox-reduced"}),e.jsx("label",{htmlFor:"reduced",className:"text-sm text-foreground cursor-pointer",children:"Reduced"})]})]})]})]})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("h1",{className:"text-2xl font-bold text-foreground mb-2","data-testid":"text-search-query",children:['Search results for "',c,'"']}),e.jsx("p",{className:"text-muted-foreground",children:g?"Searching...":`Found ${se} results`})]}),e.jsxs("div",{className:"flex md:hidden items-center gap-2 mb-6 border-b border-border overflow-x-auto",children:[e.jsx("button",{onClick:()=>u("all"),className:x("px-4 py-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors",r==="all"?"border-primary text-foreground":"border-transparent text-muted-foreground hover:text-foreground"),"data-testid":"button-filter-all",children:"Top"}),e.jsx("button",{onClick:()=>u("products"),className:x("px-4 py-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors",r==="products"?"border-primary text-foreground":"border-transparent text-muted-foreground hover:text-foreground"),"data-testid":"button-filter-products",children:"Products"}),e.jsx("button",{onClick:()=>u("shows"),className:x("px-4 py-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors",r==="shows"?"border-primary text-foreground":"border-transparent text-muted-foreground hover:text-foreground"),"data-testid":"button-filter-shows",children:"Shows"}),e.jsx("button",{onClick:()=>u("users"),className:x("px-4 py-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors",r==="users"?"border-primary text-foreground":"border-transparent text-muted-foreground hover:text-foreground"),"data-testid":"button-filter-users",children:"Users"})]}),g&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(M,{className:"h-8 w-8 animate-spin text-primary"})}),F&&e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-destructive",children:"Failed to load search results"})}),!g&&!F&&_.length===0&&R.length===0&&I.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ce,{className:"h-16 w-16 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-lg font-medium text-foreground mb-2",children:"No results found"}),e.jsx("p",{className:"text-muted-foreground",children:"Try adjusting your search or filters"})]}),!g&&!F&&e.jsxs("div",{className:"space-y-8",children:[Y&&_.length>0&&e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4",children:_.map(s=>e.jsx(he,{product:s},s._id))}),Z&&R.length>0&&e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:R.map(s=>e.jsx(de,{show:s,currentUserId:X},s._id))}),ee&&I.length>0&&e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4",children:I.map(s=>e.jsx(pe,{user:s},s._id))}),U&&e.jsx("div",{ref:m,className:"flex items-center justify-center py-8",children:$&&e.jsx(M,{className:"h-6 w-6 animate-spin text-primary"})})]})]})]})})})})}export{Be as default};
