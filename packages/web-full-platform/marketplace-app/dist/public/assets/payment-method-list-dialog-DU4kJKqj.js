import{a as k,g as P,r as l,d as T,j as e,x as f,B as n,y as w,q as B}from"./index-GnvmivW0.js";import{D as q,a as L,b as $,c as I}from"./dialog-D1L4tMGI.js";import{B as U}from"./badge-CL9MXKGS.js";import{AddPaymentDialog as z}from"./add-payment-dialog-DoThKuX2.js";import{C as b}from"./credit-card-B0WsppBV.js";import{T as K}from"./trash-2-V4a6hNaj.js";import"./index-QZHL2phQ.js";function V({open:o,onOpenChange:y,onSuccess:M}){const{user:s,refreshUserData:c}=k(),{toast:r}=P(),[D,m]=l.useState(!1),[x,p]=l.useState(null),[u,g]=l.useState(null),i=(s==null?void 0:s.id)||(s==null?void 0:s._id),{data:j,isLoading:h,refetch:d}=T({queryKey:[`/api/users/paymentmethod/${i}`],enabled:!!i});l.useEffect(()=>{o&&i&&d()},[o,i,d]);const _=()=>{m(!0)},C=async()=>{m(!1),await B.invalidateQueries({queryKey:[`/api/users/paymentmethod/${i}`]}),await d(),await c()},S=async t=>{if(s){g(t);try{await w("PUT","/stripe/default",{paymentMethodId:t,userid:i}),r({title:"Default Payment Set",description:"This payment method is now your default."}),await d(),await c()}catch(a){console.error("Failed to set default payment method:",a),r({title:"Error",description:(a==null?void 0:a.message)||"Failed to set default payment method.",variant:"destructive"})}finally{g(null)}}},A=async t=>{if(s){p(t);try{await w("DELETE","/stripe/remove",{paymentMethodId:t,userid:i}),r({title:"Payment Method Deleted",description:"Your payment method has been removed."}),await d(),await c()}catch(a){console.error("Failed to delete payment method:",a),r({title:"Error",description:(a==null?void 0:a.message)||"Failed to delete payment method.",variant:"destructive"})}finally{p(null)}}},v=Array.isArray(j)?j:[],N=v.length>0;return e.jsxs(e.Fragment,{children:[e.jsx(q,{open:o,onOpenChange:y,children:e.jsxs(L,{className:"sm:max-w-md gap-0 [&>*]:min-w-0","data-testid":"dialog-payment-methods",children:[e.jsx($,{children:e.jsx(I,{className:"text-2xl font-bold",children:"Payment methods"})}),e.jsx("div",{className:"max-h-[60vh] overflow-y-auto -mx-6 px-6 mt-4",children:e.jsxs("div",{className:"space-y-2",children:[h&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(f,{className:"h-8 w-8 mx-auto mb-3 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading payment methods..."})]}),!h&&N&&v.map(t=>{const a=t.name||t.brand||t.card_type||t.type||"",E=t.last4||t.lastFour||t.last_four||"",F=a?a.charAt(0).toUpperCase()+a.slice(1):"";return e.jsxs("div",{className:"flex flex-col gap-2 p-3 rounded-lg border border-border hover-elevate min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-12 h-8 bg-muted rounded flex items-center justify-center",children:e.jsx(b,{className:"h-4 w-4 text-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-0.5",children:[e.jsxs("p",{className:"font-semibold text-sm truncate",children:[F||"Card"," â€¢ ",E]}),t.primary&&e.jsx(U,{variant:"secondary",className:"text-xs px-1.5 py-0 h-5",children:"Default"})]}),t.expiry&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Expiry: ",t.expiry]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[!t.primary&&e.jsx(n,{variant:"outline",size:"sm",onClick:()=>S(t._id),disabled:u===t._id||x===t._id,className:"flex-1 h-8 text-xs","data-testid":`button-set-default-${t._id}`,children:u===t._id?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"h-3 w-3 mr-1 animate-spin"}),"Setting..."]}):"Make default"}),e.jsx(n,{variant:"outline",size:"sm",onClick:()=>A(t._id),disabled:x===t._id||u===t._id,className:`${t.primary,"flex-1"} h-8 text-xs text-destructive hover:text-destructive hover:bg-destructive/10`,"data-testid":`button-delete-payment-${t._id}`,children:x===t._id?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"h-3 w-3 mr-1 animate-spin"}),"Deleting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-3 w-3 mr-1"}),"Delete"]})})]})]},t._id)}),!h&&!N&&e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(b,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No payment methods added yet"})]})]})}),e.jsxs("div",{className:"flex flex-col gap-3 mt-6 pt-4 border-t",children:[e.jsx(n,{variant:"outline",onClick:_,className:"w-full","data-testid":"button-add-payment",children:"Add payment"}),e.jsx(n,{variant:"ghost",onClick:()=>y(!1),className:"w-full","data-testid":"button-back",children:"Back"})]})]})}),e.jsx(z,{open:D,onOpenChange:m,onSuccess:C})]})}export{V as PaymentMethodListDialog,V as default};
