import{a as me,e as pe,r as j,p as he,q as L,j as e}from"./index-DOZKoalF.js";import{u as ue,t as xe,F as ge,a as d,b as l,e as o,c,d as p,f as b}from"./form-BJNwnS3h.js";import{u as Z}from"./useQuery-48pQeuS3.js";import{u as je}from"./useMutation-BBndlB0x.js";import{B as ee}from"./button-bCrgsaso.js";import{I as w}from"./input-CsVTZWQJ.js";import{T as ye}from"./textarea-C334aam0.js";import{S as fe,a as we,b as be,c as ve,d as te}from"./select-fROaTUpr.js";import{S as _}from"./switch-t4cqETiz.js";import{a as Ne}from"./upload-images-DzIku6Z8.js";import{D as Ce,a as ze,b as Fe,c as Se}from"./dialog-D_mWFmtX.js";import{C as ke}from"./clock-ERkwJGDp.js";import{C as _e}from"./chevron-right-SEiIbCON.js";import{L as qe}from"./loader-circle-Bz7fq4IJ.js";import"./label-CmdcELDJ.js";import"./index-BdQq_4o_.js";import"./index-DwAU5pHh.js";import"./index-CXm_CZR6.js";import"./index-CxUEmdCc.js";import"./index-AFSU6Owo.js";import"./chevron-down-Bi2HuHPT.js";import"./check-Bj3EYrSG.js";import"./chevron-up-0jCUr4SU.js";import"./index-D0GAShZH.js";function st({listingType:q="buy_now",roomId:T,existingProduct:n,onSuccess:D,onCancel:O,submitButtonText:ae="Create Product",showCancelButton:se=!1}){var J,M,H;const{user:r}=me(),{toast:v}=pe(),[N,ne]=j.useState([]),[C,V]=j.useState([]),[I,E]=j.useState(!1),i=ue({resolver:xe(he),defaultValues:{name:"",description:"",price:0,quantity:1,category:"",listingType:q,shippingProfile:"",images:[],startingPrice:1,duration:5,sudden:!1,featured:!1,whocanenter:"everyone",tokshow:T||""}}),h=i.watch("listingType"),{data:U,isLoading:Te}=Z({queryKey:["external-categories",r==null?void 0:r.id],queryFn:async()=>{const t=await fetch(`/api/categories?userId=${r==null?void 0:r.id}&status=active&page=1&limit=100`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`Failed to fetch categories: ${t.status}`);return t.json()},enabled:!!(r!=null&&r.id)}),{data:ie,isLoading:$}=Z({queryKey:["external-shipping-profiles",r==null?void 0:r.id],queryFn:async()=>{if(!(r!=null&&r.id))throw new Error("User ID required");const t=await fetch(`/api/shipping/profiles/${r.id}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`Failed to fetch shipping profiles: ${t.status}`);return t.json()},enabled:!!(r!=null&&r.id)});j.useEffect(()=>{var t,a,s,u,x;if(n&&!$){console.log("Existing product data:",n);const g=((t=n.category)==null?void 0:t._id)||n.category||"",m=n.shippingProfile||n.shipping_profile,f=typeof m=="object"&&(m!=null&&m._id)?m._id:typeof m=="string"?m:"",k=n.quantity||((a=n.auction)==null?void 0:a.quantity)||1,W=n.startingPrice||n.price||((s=n.auction)==null?void 0:s.baseprice)||0,Y=((u=n.auction)==null?void 0:u.duration)||n.duration||5,X=((x=n.auction)==null?void 0:x.sudden)||n.sudden||!1;console.log("Form values being set:",{name:n.name,quantity:k,startingPrice:W,duration:Y,sudden:X,shippingProfile:f,category:g}),i.reset({name:n.name||"",description:n.description||"",price:n.price||0,quantity:k,category:g,listingType:q,shippingProfile:f,images:n.images||[],startingPrice:W,duration:Y,sudden:X,tokshow:T||n.tokshow||""}),n.images&&n.images.length>0&&V(n.images)}},[n,i,q,T,$]);const z=je({mutationFn:async t=>{const a=!!n,s=(n==null?void 0:n._id)||(n==null?void 0:n.id),u=t.listingType==="giveaway";let x,g;u?(x=a?`/api/giveaways/${s}`:"/api/giveaways",g=a?"PUT":"POST"):(x=a?`/api/products/${s}`:`/api/products/${r==null?void 0:r.id}`,g=a?"PATCH":"POST");const m=await fetch(x,{method:g,headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!m.ok){const f=await m.json();throw new Error(f.message||`Failed to ${a?"update":"create"} ${u?"giveaway":"product"}`)}return m.json()},onSuccess:(t,a)=>{const s=a.listingType==="giveaway";L.invalidateQueries({queryKey:["external-products"]}),L.invalidateQueries({queryKey:["/api/products"]}),s&&L.invalidateQueries({queryKey:["/api/giveaways"]}),v({title:n?s?"Giveaway Updated":"Product Updated":s?"Giveaway Created":"Product Created",description:`Your ${s?"giveaway":"product"} has been ${n?"updated":"created"} successfully.`}),n||i.reset(),D==null||D()},onError:(t,a)=>{const s=a.listingType==="giveaway";v({title:n?s?"Failed to Update Giveaway":"Failed to Update Product":s?"Failed to Create Giveaway":"Failed to Create Product",description:t.message,variant:"destructive"})}}),re=async t=>{try{let a=[];if(N.length>0){E(!0),v({title:"Uploading Images",description:"Please wait while we upload your images..."});try{const u=`${r==null?void 0:r.id}_${Date.now()}`;a=(await Ne(N,u)).map(g=>g.url)}finally{E(!1)}}const s={name:t.name,description:t.description,quantity:t.quantity,category:t.category,tokshow:t.tokshow,images:a.length>0?a:(n==null?void 0:n.images)||t.images,listingType:t.listingType};h==="buy_now"?(s.price=t.price,s.shipping_profile=t.shippingProfile,s.featured=t.featured):h==="auction"?(s.startingPrice=t.startingPrice,s.price=t.startingPrice,s.duration=t.duration,s.sudden=t.sudden,s.shipping_profile=t.shippingProfile):h==="giveaway"&&(s.duration=t.duration,s.whocanenter=t.whocanenter,s.shipping_profile=t.shippingProfile),console.log("ðŸ“¦ Submitting product data:",{listingType:h,quantity:s.quantity,duration:s.duration,data:s}),z.mutate(s)}catch(a){E(!1),v({title:"Upload Failed",description:a instanceof Error?a.message:"Failed to upload images. Please try again.",variant:"destructive"})}},oe=()=>{const t=i.formState.errors,a=Object.values(t)[0];a!=null&&a.message&&v({title:"Validation Error",description:a.message,variant:"destructive"})},Q=(U==null?void 0:U.categories)||[],le=ie||[],[ce,F]=j.useState(!1),[y,G]=j.useState(null),[R,A]=j.useState([]);j.useEffect(()=>{const t=localStorage.getItem("recentCategories");if(t)try{A(JSON.parse(t))}catch(a){console.error("Failed to parse recent categories:",a)}},[]);const S=(t,a)=>{i.setValue("category",t._id);const s=[t._id,...R.filter(u=>u!==t._id)].slice(0,5);A(s),localStorage.setItem("recentCategories",JSON.stringify(s)),F(!1),G(null)},P=(t=>{const a=[];return t.forEach(s=>{a.push(s),s.subCategories&&s.subCategories.length>0&&a.push(...s.subCategories.map(u=>({...u,parentName:s.name})))}),a})(Q),B=R.map(t=>P.find(a=>a._id===t)).filter(Boolean),de=((J=P.find(t=>t._id===i.watch("category")))==null?void 0:J.name)||((M=P.find(t=>t._id===i.watch("category")))==null?void 0:M.parentName),K=async t=>{t==null||t.preventDefault(),t==null||t.stopPropagation(),await i.trigger()?re(i.getValues()):oe()};return e.jsx(ge,{...i,children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),K()},className:"space-y-3",children:[e.jsx(d,{control:i.control,name:"listingType",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Listing Type"}),e.jsx(c,{children:e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>t.onChange("buy_now"),className:`
                      px-4 py-2.5 rounded-md text-sm font-medium transition-all
                      ${t.value==="buy_now"?"bg-primary text-primary-foreground":"bg-zinc-800 text-white hover:bg-zinc-700"}
                    `,"data-testid":"button-listing-type-buy-now",children:"Buy Now"}),e.jsx("button",{type:"button",onClick:()=>t.onChange("auction"),className:`
                      px-4 py-2.5 rounded-md text-sm font-medium transition-all
                      ${t.value==="auction"?"bg-primary text-primary-foreground":"bg-zinc-800 text-white hover:bg-zinc-700"}
                    `,"data-testid":"button-listing-type-auction",children:"Auction"}),e.jsx("button",{type:"button",onClick:()=>t.onChange("giveaway"),className:`
                      px-4 py-2.5 rounded-md text-sm font-medium transition-all
                      ${t.value==="giveaway"?"bg-primary text-primary-foreground":"bg-zinc-800 text-white hover:bg-zinc-700"}
                    `,"data-testid":"button-listing-type-giveaway",children:"Giveaway"})]})}),e.jsx(p,{})]})}),e.jsx(d,{control:i.control,name:"images",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Product Images"}),e.jsx(c,{children:e.jsx("div",{className:"border-2 border-dashed border-zinc-700 rounded-lg p-4 text-center cursor-pointer hover:border-zinc-600 transition-colors",onClick:()=>{const a=document.createElement("input");a.type="file",a.accept="image/*",a.multiple=!0,a.onchange=s=>{const x=Array.from(s.target.files||[]).slice(0,3-N.length),g=[...N,...x].slice(0,3);ne(g);const m=x.map(k=>URL.createObjectURL(k)),f=[...C,...m].slice(0,3);V(f),t.onChange(f)},a.click()},children:C.length>0?e.jsxs("div",{className:"flex gap-2 flex-wrap justify-center",children:[C.map((a,s)=>e.jsx("img",{src:a,alt:"",className:"w-16 h-16 object-cover rounded"},s)),C.length<3&&e.jsx("div",{className:"w-16 h-16 border border-zinc-700 rounded flex items-center justify-center text-zinc-500 text-xs",children:"+"})]}):e.jsxs("div",{className:"text-zinc-400 text-sm",children:[e.jsx("div",{className:"mb-1",children:"ðŸ“·"}),e.jsx("div",{children:"Upload product images"}),e.jsx("div",{className:"text-xs text-zinc-500 mt-1",children:"JPG, PNG, GIF up to 5MB each"})]})})}),e.jsx(p,{})]})}),e.jsx(d,{control:i.control,name:"name",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Product Name"}),e.jsx(c,{children:e.jsx(w,{placeholder:"Enter product name",...t,className:"bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-400","data-testid":"input-product-name"})}),e.jsx(p,{})]})}),e.jsx(d,{control:i.control,name:"description",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Description"}),e.jsx(c,{children:e.jsx(ye,{placeholder:"Enter product description",...t,rows:2,className:"bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-400","data-testid":"textarea-product-description"})}),e.jsx(p,{})]})}),e.jsx(d,{control:i.control,name:"category",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Category"}),e.jsx(c,{children:e.jsx("div",{onClick:()=>F(!0),className:"bg-zinc-800 border border-zinc-700 text-white rounded-md px-3 py-2 cursor-pointer hover:bg-zinc-750 transition-colors","data-testid":"button-select-category",children:de||e.jsx("span",{className:"text-zinc-400",children:"Select category"})})}),e.jsx(p,{})]})}),e.jsx(Ce,{open:ce,onOpenChange:F,children:e.jsxs(ze,{className:"bg-zinc-900 border-zinc-800 text-white max-w-md",children:[e.jsx(Fe,{children:e.jsx(Se,{className:"text-white",children:y?y.name:"Select Category"})}),e.jsx("div",{className:"max-h-96 overflow-y-auto",children:y?e.jsxs("div",{className:"space-y-1",children:[e.jsx("button",{onClick:t=>{t.preventDefault(),t.stopPropagation(),G(null)},className:"w-full text-left px-3 py-2.5 hover:bg-zinc-800 rounded-md transition-colors text-sm text-zinc-400",children:"â† Back"}),e.jsx("button",{onClick:t=>{t.preventDefault(),t.stopPropagation(),S(y)},className:"w-full text-left px-3 py-2.5 hover:bg-zinc-800 rounded-md transition-colors",children:e.jsxs("div",{className:"text-sm text-white",children:[y.name," (All)"]})}),e.jsx("div",{className:"border-t border-zinc-800 my-2"}),(H=y.subCategories)==null?void 0:H.map(t=>e.jsx("button",{onClick:a=>{a.preventDefault(),a.stopPropagation(),S(t,y.name)},className:"w-full text-left px-3 py-2.5 hover:bg-zinc-800 rounded-md transition-colors",children:e.jsx("div",{className:"text-sm text-white",children:t.name})},t._id))]}):e.jsxs("div",{className:"space-y-1",children:[B.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"px-3 py-2 text-xs font-semibold text-zinc-400 flex items-center gap-2",children:[e.jsx(ke,{className:"h-3 w-3"}),"Recently Used"]}),B.map(t=>e.jsx("button",{onClick:a=>{a.preventDefault(),a.stopPropagation(),S(t,t.parentName)},className:"w-full text-left px-3 py-2.5 hover:bg-zinc-800 rounded-md transition-colors",children:e.jsxs("div",{className:"text-sm text-white",children:[t.parentName?`${t.parentName} > `:"",t.name]})},`recent-${t._id}`)),e.jsx("div",{className:"border-t border-zinc-800 my-2"})]}),e.jsx("button",{onClick:t=>{t.preventDefault(),t.stopPropagation(),i.setValue("category",""),F(!1)},className:"w-full text-left px-3 py-2.5 hover:bg-zinc-800 rounded-md transition-colors",children:e.jsx("div",{className:"text-sm text-zinc-400",children:"No Category"})}),Q.map(t=>e.jsxs("button",{onClick:a=>{a.preventDefault(),a.stopPropagation(),t.subCategories&&t.subCategories.length>0?G(t):S(t)},className:"w-full text-left px-3 py-2.5 hover:bg-zinc-800 rounded-md transition-colors flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-white",children:t.name}),t.subCategories&&t.subCategories.length>0&&e.jsx(_e,{className:"h-4 w-4 text-zinc-400"})]},t._id))]})})]})}),h==="auction"?e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(d,{control:i.control,name:"startingPrice",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Starting Price"}),e.jsx(c,{children:e.jsx(w,{type:"number",step:"0.01",min:"1",placeholder:"1.00",...t,onChange:a=>t.onChange(parseFloat(a.target.value)||1),className:"bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-400","data-testid":"input-product-starting-price"})}),e.jsx(p,{})]})}),e.jsx(d,{control:i.control,name:"quantity",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Quantity"}),e.jsx(c,{children:e.jsx(w,{type:"number",min:"1",placeholder:"1",...t,onChange:a=>t.onChange(parseInt(a.target.value)||1),className:"bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-400","data-testid":"input-product-quantity"})}),e.jsx(p,{})]})})]}):h==="buy_now"?e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(d,{control:i.control,name:"price",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Price"}),e.jsx(c,{children:e.jsx(w,{type:"number",step:"0.01",min:"0",placeholder:"Price",...t,onChange:a=>t.onChange(parseFloat(a.target.value)||0),className:"bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-400","data-testid":"input-product-price"})}),e.jsx(p,{})]})}),e.jsx(d,{control:i.control,name:"quantity",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Quantity"}),e.jsx(c,{children:e.jsx(w,{type:"number",min:"1",placeholder:"1",...t,onChange:a=>t.onChange(parseFloat(a.target.value)||0),className:"bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-400","data-testid":"input-product-quantity"})}),e.jsx(p,{})]})})]}):h==="giveaway"?e.jsx(d,{control:i.control,name:"quantity",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Quantity"}),e.jsx(c,{children:e.jsx(w,{type:"number",min:"1",placeholder:"1",...t,onChange:a=>t.onChange(parseInt(a.target.value)||1),className:"bg-zinc-800 border-zinc-700 text-white placeholder:text-zinc-400","data-testid":"input-giveaway-quantity"})}),e.jsx(b,{className:"text-xs text-zinc-400",children:"Number of winners for this giveaway"}),e.jsx(p,{})]})}):null,h==="auction"&&e.jsx(d,{control:i.control,name:"duration",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Duration"}),e.jsx(c,{children:e.jsx("div",{className:"flex gap-2 flex-wrap",children:[2,3,5,10,15,20,30].map(a=>e.jsxs("button",{type:"button",onClick:()=>t.onChange(a),className:`
                          w-12 h-12 rounded-full border-2 flex items-center justify-center text-sm font-medium transition-all
                          ${t.value===a?"border-yellow-500 bg-yellow-500 text-black":"border-zinc-700 bg-zinc-800 text-white hover:border-zinc-600"}
                        `,"data-testid":`button-duration-${a}`,children:[a,"s"]},a))})}),e.jsx(p,{})]})}),e.jsx(d,{control:i.control,name:"shippingProfile",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Shipping Profile"}),e.jsxs(fe,{onValueChange:t.onChange,value:t.value||"",disabled:$,"data-testid":"select-shipping-profile",children:[e.jsx(c,{children:e.jsx(we,{className:"bg-zinc-800 border-zinc-700 text-white",children:e.jsx(be,{placeholder:"Select shipping profile",className:"text-zinc-400"})})}),e.jsxs(ve,{position:"popper",className:"z-[10000]",children:[e.jsx(te,{value:"skip",children:"No Shipping Profile"}),le.map(a=>e.jsx(te,{value:a._id,children:a.name},a._id))]})]}),e.jsx(p,{})]})}),h==="auction"&&e.jsx(d,{control:i.control,name:"sudden",render:({field:t})=>e.jsxs(l,{className:"flex flex-row items-center justify-between rounded-lg border border-zinc-700 p-3 bg-zinc-800",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(o,{className:"text-sm text-white font-medium",children:"Sudden Death"}),e.jsx(b,{className:"text-xs text-zinc-300",children:"Auction ends immediately when someone bids"})]}),e.jsx(c,{children:e.jsx(_,{checked:t.value,onCheckedChange:t.onChange,"data-testid":"switch-sudden-death"})})]})}),h==="buy_now"&&e.jsx(d,{control:i.control,name:"featured",render:({field:t})=>e.jsxs(l,{className:"flex flex-row items-center justify-between rounded-lg border border-zinc-700 p-3 bg-zinc-800",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(o,{className:"text-sm text-white font-medium",children:"List to trending products"}),e.jsx(b,{className:"text-xs text-zinc-300",children:"This item will be listed to trending products"})]}),e.jsx(c,{children:e.jsx(_,{checked:t.value,onCheckedChange:t.onChange,"data-testid":"switch-featured"})})]})}),h==="giveaway"&&e.jsx(d,{control:i.control,name:"duration",render:({field:t})=>e.jsxs(l,{children:[e.jsx(o,{className:"text-white font-medium",children:"Duration (minutes)"}),e.jsx(c,{children:e.jsx(w,{type:"number",min:"1",placeholder:"Enter duration in minutes",...t,onChange:a=>t.onChange(parseInt(a.target.value)||5),className:"bg-zinc-800 border-zinc-700 text-white","data-testid":"input-giveaway-duration"})}),e.jsx(b,{className:"text-xs text-zinc-400",children:"How long the giveaway will run"}),e.jsx(p,{})]})}),h==="giveaway"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(o,{className:"text-white font-medium",children:"Who can enter"}),e.jsx(d,{control:i.control,name:"whocanenter",render:({field:t})=>e.jsxs(e.Fragment,{children:[e.jsxs(l,{className:"flex flex-row items-center justify-between rounded-lg border border-zinc-700 p-3 bg-zinc-800",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(o,{className:"text-sm text-white font-medium",children:"Everyone"}),e.jsx(b,{className:"text-xs text-zinc-300",children:"Everyone can enter this giveaway"})]}),e.jsx(c,{children:e.jsx(_,{checked:t.value==="everyone",onCheckedChange:a=>{a&&t.onChange("everyone")},"data-testid":"switch-whocanenter-everyone"})})]}),e.jsxs(l,{className:"flex flex-row items-center justify-between rounded-lg border border-zinc-700 p-3 bg-zinc-800",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(o,{className:"text-sm text-white font-medium",children:"Followers"}),e.jsx(b,{className:"text-xs text-zinc-300",children:"Only followers can enter this giveaway"})]}),e.jsx(c,{children:e.jsx(_,{checked:t.value==="followers",onCheckedChange:a=>{a&&t.onChange("followers")},"data-testid":"switch-whocanenter-followers"})})]})]})})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[se&&O&&e.jsx(ee,{type:"button",variant:"outline",onClick:O,disabled:z.isPending,className:"flex-1","data-testid":"button-cancel",children:"Cancel"}),e.jsxs(ee,{type:"button",disabled:z.isPending||I,onClick:K,className:"flex-1 bg-yellow-500 hover:bg-yellow-600 text-black font-medium","data-testid":"button-submit-product",children:[(z.isPending||I)&&e.jsx(qe,{className:"mr-2 h-4 w-4 animate-spin"}),I?"Uploading Images...":ae]})]})]})})}export{st as ProductForm,st as default};
