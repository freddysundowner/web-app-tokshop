import{c as W,f as H,a as U,r as u,q as Y,n as Q,j as e,B as p,m as _}from"./index-FVTY5sKH.js";import{D as G,a as J,b as V,c as X}from"./dialog-A2pFZcsY.js";import{S as f}from"./separator-QabP-acS.js";import{u as F}from"./useQuery-DsZx8GVA.js";import{u as Z}from"./useMutation-DKG1zDtN.js";import{C as I}from"./chevron-right-HRo85rGP.js";import{P as E}from"./plus-CFqimBvi.js";import{C as ee}from"./credit-card-BDFvtuhf.js";import{M as se}from"./map-pin-jcALPDnh.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=W("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);function $({open:d,onOpenChange:S,product:s,onOpenPaymentMethods:T,onOpenShippingAddresses:B}){var P,q,M;const{toast:m}=H(),{user:a}=U(),[n,j]=u.useState(1),[w,k]=u.useState(!1),x=(s==null?void 0:s.quantity)||1,D=x>1,b=(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.id),{data:h}=F({queryKey:[`/api/users/paymentmethod/default/${b}`],enabled:d&&!!b}),c=h!=null&&h.data?h.data:h||null,i=a==null?void 0:a.address,{data:t,isLoading:L}=F({queryKey:["/api/shipping/estimate",s==null?void 0:s._id,n,i==null?void 0:i.id],queryFn:async()=>{if(!(s!=null&&s.shipping_profile)||!i)return{amount:"0.00"};const l=(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.id),r=s._id||s.id;let o="";return typeof s.owner=="string"?o=s.owner:s.owner&&(o=s.owner._id||s.owner.id||""),!o&&s.ownerId&&(o=typeof s.ownerId=="string"?s.ownerId:s.ownerId._id||s.ownerId.id||""),await Q("POST","/api/shipping/estimate",{weight:s.shipping_profile.weight,unit:s.shipping_profile.scale||"oz",product:r,owner:o,customer:l,tokshow:s.tokshow,buying_label:!1})},enabled:d&&!!((P=s==null?void 0:s.shipping_profile)!=null&&P.weight)&&!!i&&!!a}),{data:y,isLoading:O}=F({queryKey:["/api/tax/estimate",s==null?void 0:s.id,n],enabled:d&&!!(s!=null&&s.id)});u.useEffect(()=>{d&&(j(1),k(!1))},[d]);const K=()=>{n<x&&j(n+1)},R=()=>{n>1&&j(n-1)},g=((s==null?void 0:s.price)||0)*n,C=parseFloat((t==null?void 0:t.amount)||"0"),N=parseFloat((y==null?void 0:y.tax)||"0"),v=g+C+N,z=Z({mutationFn:async()=>{const l=s._id||s.id;let r="";typeof s.owner=="string"?r=s.owner:s.owner&&(r=s.owner._id||s.owner.id||""),!r&&s.ownerId&&(r=typeof s.ownerId=="string"?s.ownerId:s.ownerId._id||s.ownerId.id||"");const o={product:l,status:"processing",shippingFee:parseFloat((t==null?void 0:t.amount)||"0"),servicelevel:(t==null?void 0:t.servicelevel)||"",rate_id:(t==null?void 0:t.rate_id)||"",bundleId:(t==null?void 0:t.bundleId)||"",totalWeightOz:parseFloat((t==null?void 0:t.totalWeightOz)||"0"),seller_shipping_fee_pay:parseFloat((t==null?void 0:t.seller_shipping_fee_pay)||"0"),subtotal:g,tax:parseFloat(N.toString()||"0"),seller:r,buyer:b,quantity:n,total:parseFloat(v.toFixed(2)),color:"",size:"",tokshow:s.tokshow||""};return await Q("POST",`/api/orders/${l}`,o)},onSuccess:l=>{m({title:"Purchase Successful!",description:"Your order has been placed"}),Y.invalidateQueries({queryKey:["/api/orders"]}),S(!1)},onError:l=>{var o;const r=((o=l==null?void 0:l.response)==null?void 0:o.error)||(l==null?void 0:l.message)||"Failed to complete purchase";m({title:"Purchase Failed",description:r,variant:"destructive"})}}),A=()=>{if(!c){m({title:"No Payment Method",description:"Please add a payment method first",variant:"destructive"});return}if(!i){m({title:"No Address",description:"Please add a shipping address first",variant:"destructive"});return}if(n>x){m({title:"Quantity Error",description:"Quantity exceeds available stock",variant:"destructive"});return}z.mutate()};return e.jsx(G,{open:d,onOpenChange:S,children:e.jsxs(J,{className:"bg-zinc-900 border-zinc-800 text-white max-w-lg max-h-[90vh] overflow-y-auto [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]",children:[e.jsx(V,{children:e.jsx(X,{className:"text-white text-xl",children:"Buy Now"})}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"flex gap-4",children:[((q=s==null?void 0:s.images)==null?void 0:q[0])&&e.jsx("div",{className:"w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden bg-zinc-800",children:e.jsx("img",{src:s.images[0],alt:s.name,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-base leading-tight mb-1",children:s==null?void 0:s.name}),x>0&&e.jsxs("p",{className:"text-sm text-zinc-400",children:[x," available"]})]})]}),e.jsx(f,{className:"bg-zinc-800"}),D&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>k(!w),className:"w-full flex items-center justify-between py-2 text-sm","data-testid":"button-toggle-quantity",children:[e.jsxs("span",{className:"font-medium",children:["Quantity: ",n]}),e.jsx(I,{className:`h-4 w-4 text-zinc-400 transition-transform ${w?"rotate-90":""}`})]}),w&&e.jsxs("div",{className:"flex items-center gap-4 mt-2",children:[e.jsx(p,{size:"icon",variant:"outline",className:"h-9 w-9 border-zinc-700 bg-zinc-800 text-white hover:bg-zinc-700",onClick:R,disabled:n<=1,"data-testid":"button-decrement-quantity",children:e.jsx(ae,{className:"h-4 w-4",style:{color:"white",stroke:"white"}})}),e.jsx("div",{className:"flex-1 text-center",children:e.jsx("span",{className:"text-lg font-bold",children:n})}),e.jsx(p,{size:"icon",variant:"outline",className:"h-9 w-9 border-zinc-700 bg-zinc-800 text-white hover:bg-zinc-700",onClick:K,disabled:n>=x,"data-testid":"button-increment-quantity",children:e.jsx(E,{className:"h-4 w-4",style:{color:"white",stroke:"white"}})})]})]}),e.jsx(f,{className:"bg-zinc-800"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold mb-2",children:"Payment Method"}),e.jsxs("button",{onClick:T,className:"w-full flex items-center justify-between py-3 hover:bg-zinc-800/50 rounded-lg px-2 transition-colors","data-testid":"button-payment-method",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ee,{className:"h-5 w-5 text-zinc-400"}),c?e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"text-sm",children:[(M=c.brand)==null?void 0:M.toUpperCase()," •••• ",c.last4]}),c.exp_month&&c.exp_year&&e.jsxs("p",{className:"text-xs text-zinc-400",children:["Expires ",String(c.exp_month).padStart(2,"0"),"/",c.exp_year]})]}):e.jsx("span",{className:"text-sm text-zinc-400",children:"Add payment method"})]}),e.jsx(I,{className:"h-4 w-4 text-zinc-400"})]})]}),e.jsx(f,{className:"bg-zinc-800"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold mb-2",children:"Shipping Address"}),e.jsxs("button",{onClick:B,className:"w-full flex items-center justify-between py-3 hover:bg-zinc-800/50 rounded-lg px-2 transition-colors","data-testid":"button-shipping-address",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(se,{className:"h-5 w-5 text-zinc-400"}),i?e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"text-sm",children:[(i==null?void 0:i.addrress1)||(i==null?void 0:i.address1)||"Address on file",i.city&&`, ${i.city}`]}),e.jsxs("p",{className:"text-xs text-zinc-400",children:[i.state&&`${i.state} `,i.zipcode]})]}):e.jsx("span",{className:"text-sm text-zinc-400",children:"Add shipping address"})]}),e.jsx(I,{className:"h-4 w-4 text-zinc-400"})]})]}),e.jsx(f,{className:"bg-zinc-800"}),e.jsxs("div",{className:"space-y-2 bg-zinc-800/30 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-zinc-400",children:"Subtotal"}),e.jsxs("span",{className:"font-medium",children:["$",g.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-zinc-400",children:"Shipping"}),L?e.jsx(_,{className:"h-4 w-4 animate-spin"}):e.jsxs("span",{className:"font-medium",children:["$",C.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-zinc-400",children:"Tax"}),O?e.jsx(_,{className:"h-4 w-4 animate-spin"}):e.jsxs("span",{className:"font-medium",children:["$",N.toFixed(2)]})]}),e.jsx(f,{className:"bg-zinc-700 my-2"}),e.jsxs("div",{className:"flex justify-between text-base font-bold",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["$",v.toFixed(2)]})]})]}),e.jsx(p,{className:"w-full h-12 text-base font-bold bg-primary hover:bg-primary/90 text-primary-foreground",onClick:A,disabled:z.isPending||!c||!i,"data-testid":"button-confirm-buy-now",children:z.isPending?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-5 w-5 mr-2 animate-spin"}),"Processing..."]}):`Buy Now - $${v.toFixed(2)}`})]})]})})}const me=Object.freeze(Object.defineProperty({__proto__:null,BuyNowDialog:$,default:$},Symbol.toStringTag,{value:"Module"}));export{$ as B,ae as M,me as b};
