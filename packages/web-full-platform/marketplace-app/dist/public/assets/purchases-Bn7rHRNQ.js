import{r as x,a as fe,b as be,e as we,j as e}from"./index-sx6K5zvX.js";import{u as Ne}from"./useQuery-BbAFWd3P.js";import{C as Y}from"./card-y7XVqkDr.js";import{B as N}from"./button-BhKWRVKT.js";import{B as G}from"./badge-CnP4rDPZ.js";import{I as ve}from"./input-D9aLazCK.js";import{S as J,a as K,b as W,c as X,d as c}from"./select-C7m4p16O.js";import{D as ye,a as ke,b as Se,c as T}from"./dropdown-menu-BOeL9IeC.js";import{D as Pe,a as Ce,b as Te,c as $e}from"./dialog-lan0uYA-.js";import{a as f,f as n,g as Z}from"./pricing-DCyf_yea.js";import{C as De}from"./pagination-B73znb0A.js";import{S as Oe}from"./search-CokuAmim.js";import{P as $}from"./package-vaCfuI3Q.js";import{E as Ie}from"./ellipsis-DYmGatb3.js";import{P as ee}from"./printer-BbqO0LIN.js";import{T as te}from"./truck-DsoUBxdC.js";import{f as D}from"./format-D46ChU1D.js";import"./index-BdQq_4o_.js";import"./index-CLz3BQaN.js";import"./index-BVScwSuZ.js";import"./index-DI5236x7.js";import"./index-yIM9ZdYr.js";import"./chevron-down-D9nmsT4r.js";import"./check-y82geyed.js";import"./chevron-up-BQLqsJm2.js";import"./index-UxBk8lm-.js";import"./chevron-right-BMekTT0X.js";import"./circle-BdzxhEiG.js";import"./index-BvxB2yyY.js";import"./chevron-left-Z_N2qaLO.js";const se={processing:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400",shipped:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400",delivered:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400",cancelled:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",ended:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400"},ae={processing:1,shipped:2,delivered:3,ended:4,cancelled:5},O=o=>o?o.split("_").map(b=>b.charAt(0).toUpperCase()+b.slice(1).toLowerCase()).join(" "):"Unknown";function ot(){var L,U,q,R;const[o,b]=x.useState(""),[u,re]=x.useState("all"),[I,ne]=x.useState("newest"),[v,y]=x.useState(1),[w,ie]=x.useState(20),[a,A]=x.useState(null),[de,k]=x.useState(!1),{user:i}=fe(),{settings:le}=be(),{toast:_}=we(),{data:g,isLoading:ce,error:S,isError:oe,refetch:me}=Ne({queryKey:["external-purchases",i==null?void 0:i.id,u,v,w],queryFn:async()=>{const t=new URLSearchParams;i!=null&&i.id&&t.set("customer",i.id),u&&u!=="all"&&t.set("status",u),t.set("page",v.toString()),t.set("limit",w.toString());const s=await fetch(`/api/orders?${t.toString()}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error(`External API error: ${s.status}`);return s.json()},enabled:!!(i!=null&&i.id),staleTime:0,refetchOnMount:!0});x.useEffect(()=>{const t=sessionStorage.getItem("openPurchaseOrder");if(t)try{const s=JSON.parse(t);A(s),k(!0),sessionStorage.removeItem("openPurchaseOrder")}catch(s){console.error("Failed to parse order from sessionStorage:",s),sessionStorage.removeItem("openPurchaseOrder")}},[]);const F=(g==null?void 0:g.orders)||[],P=(g==null?void 0:g.total)||F.length,pe=Math.ceil(P/w),C=[...F.filter(t=>!o||t._id.toLowerCase().includes(o.toLowerCase())||(t.items||[]).some(d=>{var r,l;return(l=(r=d.productId)==null?void 0:r.name)==null?void 0:l.toLowerCase().includes(o.toLowerCase())}))].sort((t,s)=>{switch(I){case"newest":return(s.createdAt?new Date(s.createdAt).getTime():0)-(t.createdAt?new Date(t.createdAt).getTime():0);case"oldest":return(t.createdAt?new Date(t.createdAt).getTime():0)-(s.createdAt?new Date(s.createdAt).getTime():0);case"total-high":return f(s)-f(t);case"total-low":return f(t)-f(s);case"status":const d=ae[t.status]||999,r=ae[s.status]||999;return d-r;default:return 0}}),M=t=>{if(!t.tracking_number){_({title:"No Tracking Available",description:"This order doesn't have a tracking number yet.",variant:"destructive"});return}const s=`https://parcelsapp.com/en/tracking/${t.tracking_number}`;window.open(s,"_blank","noopener,noreferrer")},E=t=>{A(t),k(!0)},B=t=>{var l,h,m;const s=Z(t),d=`
      <!DOCTYPE html>
      <html>
        <head>
          <title>Receipt - Order #${t._id.slice(-8)}</title>
          <style>
            body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .order-info { margin-bottom: 20px; }
            .items-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .items-table th, .items-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .items-table th { background-color: #f2f2f2; }
            .totals { margin-top: 20px; text-align: right; }
            .total-line { display: flex; justify-content: space-between; margin: 5px 0; }
            .final-total { font-weight: bold; border-top: 2px solid #000; padding-top: 5px; }
            @media print { .no-print { display: none; } }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Purchase Receipt</h1>
            <p>${le.app_name}</p>
          </div>
          
          <div class="order-info">
            <h3>Order #${t._id.slice(-8)}</h3>
            <p><strong>Date:</strong> ${t.createdAt?D(new Date(t.createdAt),"MMM d, yyyy 'at' h:mm a"):"Date unknown"}</p>
            <p><strong>Status:</strong> ${O(t.status)}</p>
            <p><strong>Customer:</strong> ${((l=t.customer)==null?void 0:l.firstName)||""} ${((h=t.customer)==null?void 0:h.lastName)||""}</p>
            <p><strong>Email:</strong> ${((m=t.customer)==null?void 0:m.email)||""}</p>
            ${t.tracking_number?`<p><strong>Tracking:</strong> ${t.tracking_number}</p>`:""}
          </div>

          <table class="items-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              ${(t.items||[]).map(p=>{var j;return`
                <tr>
                  <td>${((j=p.productId)==null?void 0:j.name)||"Unknown Product"}</td>
                  <td>${p.quantity||0}</td>
                  <td>$${(p.price||0).toFixed(2)}</td>
                  <td>$${((p.quantity||0)*(p.price||0)).toFixed(2)}</td>
                </tr>
              `}).join("")}
            </tbody>
          </table>

          <div class="totals">
            <div class="total-line">
              <span>Subtotal:</span>
              <span>${n(s.subtotal)}</span>
            </div>
            ${s.serviceFee>0?`
              <div class="total-line">
                <span>Service Fee:</span>
                <span>${n(s.serviceFee)}</span>
              </div>
            `:""}
            ${s.tax>0?`
              <div class="total-line">
                <span>Tax:</span>
                <span>${n(s.tax)}</span>
              </div>
            `:""}
            ${s.shippingFee>0?`
              <div class="total-line">
                <span>Shipping:</span>
                <span>${n(s.shippingFee)}</span>
              </div>
            `:""}
            <div class="total-line final-total">
              <span>Total:</span>
              <span>${n(s.total)}</span>
            </div>
          </div>

          <div class="no-print" style="text-align: center; margin-top: 30px;">
            <button onclick="window.print()">Print Receipt</button>
            <button onclick="window.close()" style="margin-left: 10px;">Close</button>
          </div>
        </body>
      </html>
    `,r=window.open("","_blank","width=800,height=600");r?(r.document.write(d),r.document.close(),r.onload=()=>{r.print()}):_({title:"Print Blocked",description:"Unable to open print window. Please allow popups and try again.",variant:"destructive"})},xe=t=>{re(t),y(1)},he=t=>{ne(t)},ue=t=>{y(t)},ge=t=>{ie(t),y(1)};return ce?e.jsxs("div",{className:"p-6 space-y-6","data-testid":"page-purchases",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"h-8 bg-muted rounded w-32 animate-pulse"}),e.jsx("div",{className:"h-4 bg-muted rounded w-48 mt-2 animate-pulse"})]})}),e.jsx("div",{className:"grid gap-4",children:[1,2,3].map(t=>e.jsx("div",{className:"h-32 bg-muted rounded animate-pulse"},t))})]}):oe?e.jsx("div",{className:"p-6","data-testid":"page-purchases",children:e.jsxs(Y,{className:"p-8 text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Unable to load purchases"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:(S==null?void 0:S.message)||"There was an error loading your purchases. Please try again."}),e.jsx(N,{onClick:()=>me(),"data-testid":"button-retry-purchases",children:"Try Again"})]})}):e.jsxs("div",{className:"p-6 space-y-6","data-testid":"page-purchases",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground","data-testid":"text-page-title",children:"My Purchases"}),e.jsxs("p",{className:"text-muted-foreground","data-testid":"text-page-description",children:["Track your order history and purchase status (",P," purchases)"]})]})}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(ve,{placeholder:"Search purchases...",value:o,onChange:t=>b(t.target.value),className:"pl-10","data-testid":"input-search-purchases"})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(J,{value:u,onValueChange:xe,children:[e.jsx(K,{className:"w-[140px]","data-testid":"select-status-filter",children:e.jsx(W,{placeholder:"Status"})}),e.jsxs(X,{children:[e.jsx(c,{value:"all",children:"All Status"}),e.jsx(c,{value:"processing",children:"Processing"}),e.jsx(c,{value:"shipped",children:"Shipped"}),e.jsx(c,{value:"delivered",children:"Delivered"}),e.jsx(c,{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs(J,{value:I,onValueChange:he,children:[e.jsx(K,{className:"w-[140px]","data-testid":"select-sort",children:e.jsx(W,{placeholder:"Sort by"})}),e.jsxs(X,{children:[e.jsx(c,{value:"newest",children:"Newest"}),e.jsx(c,{value:"oldest",children:"Oldest"}),e.jsx(c,{value:"total-high",children:"Total: High to Low"}),e.jsx(c,{value:"total-low",children:"Total: Low to High"}),e.jsx(c,{value:"status",children:"Status"})]})]})]})]}),e.jsx(Y,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border bg-muted/50",children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Order"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Seller"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Items"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Price"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-border",children:C.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:7,className:"px-4 py-12 text-center",children:[e.jsx($,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No purchases found"}),e.jsx("p",{className:"text-muted-foreground",children:o||u!=="all"?"Try adjusting your search or filters":"You haven't made any purchases yet"})]})}):C.map(t=>{var p,j,H,Q,V,z;const s=((H=(j=(p=t.items)==null?void 0:p[0])==null?void 0:j.productId)==null?void 0:H.name)||"N/A",d=t.invoice||t._id.slice(-8),r=`${((Q=t.seller)==null?void 0:Q.firstName)||""} ${((V=t.seller)==null?void 0:V.lastName)||""}`.trim()||"Unknown",l=((z=t.items)==null?void 0:z.length)||0,h=t.createdAt?new Date(t.createdAt):new Date,m=t.status||"processing";return e.jsxs("tr",{className:"hover:bg-muted/50 cursor-pointer transition-colors","data-testid":`row-purchase-${t._id}`,onClick:()=>E(t),children:[e.jsxs("td",{className:"px-4 py-4",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:s}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Order #",d]})]}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm text-muted-foreground",children:D(h,"dd MMM yyyy")}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm",children:e.jsx("span",{className:"text-foreground hover:text-primary",children:r})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm text-muted-foreground",children:l}),e.jsxs("td",{className:"px-4 py-4 whitespace-nowrap text-sm font-medium text-foreground",children:["US$",f(t).toFixed(2)]}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsx(G,{className:se[m],children:O(m)})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-right text-sm",children:e.jsxs(ye,{children:[e.jsx(ke,{asChild:!0,onClick:je=>je.stopPropagation(),children:e.jsx(N,{variant:"ghost",size:"sm","data-testid":`button-actions-${t._id}`,children:e.jsx(Ie,{className:"h-4 w-4"})})}),e.jsxs(Se,{align:"end",children:[e.jsxs(T,{onSelect:()=>E(t),children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"View Details"]}),e.jsxs(T,{onSelect:()=>B(t),children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Print Receipt"]}),t.status==="shipped"&&e.jsxs(T,{onSelect:()=>M(t),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Track Package"]})]})]})})]},t._id)})})]})})}),C.length>0&&e.jsx(De,{currentPage:v,totalPages:pe,totalItems:P,itemsPerPage:w,onPageChange:ue,onItemsPerPageChange:ge,showingText:"purchases",className:"bg-white dark:bg-gray-950 rounded-lg border p-4"}),e.jsx(Pe,{open:de,onOpenChange:k,children:e.jsxs(Ce,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Te,{children:e.jsx($e,{children:"Order Details"})}),a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-lg mb-2","data-testid":"text-details-order-id",children:["Order #",a._id.slice(-8)]}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-1",children:[e.jsx("strong",{children:"Date:"})," ",a.createdAt?D(new Date(a.createdAt),"MMM d, yyyy 'at' h:mm a"):"Date unknown"]}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-1",children:[e.jsx("strong",{children:"Status:"}),e.jsx(G,{className:`ml-2 ${se[a.status]}`,children:O(a.status)})]}),a.tracking_number&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx("strong",{children:"Tracking:"})," ",a.tracking_number]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Customer Information"}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-1",children:[e.jsx("strong",{children:"Name:"})," ",(L=a.customer)==null?void 0:L.firstName," ",(U=a.customer)==null?void 0:U.lastName]}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-1",children:[e.jsx("strong",{children:"Email:"})," ",(q=a.customer)==null?void 0:q.email]}),((R=a.customer)==null?void 0:R.address)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Shipping Address:"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[a.customer.address.name,e.jsx("br",{}),a.customer.address.addrress1,e.jsx("br",{}),a.customer.address.city,", ",a.customer.address.state," ",a.customer.address.zipcode]})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Order Items"}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left p-3",children:"Product"}),e.jsx("th",{className:"text-center p-3",children:"Quantity"}),e.jsx("th",{className:"text-right p-3",children:"Price"}),e.jsx("th",{className:"text-right p-3",children:"Total"})]})}),e.jsx("tbody",{children:(a.items||[]).map((t,s)=>{var d,r,l,h,m;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[(d=t.productId)!=null&&d.images&&t.productId.images.length>0?e.jsx("img",{src:t.productId.images[0],alt:((r=t.productId)==null?void 0:r.name)||"Product",className:"w-12 h-12 rounded object-cover"}):e.jsx("div",{className:"w-12 h-12 bg-muted rounded flex items-center justify-center",children:e.jsx($,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:((l=t.productId)==null?void 0:l.name)||"Unknown Product"}),((m=(h=t.productId)==null?void 0:h.category)==null?void 0:m.name)&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t.productId.category.name})]})]})}),e.jsx("td",{className:"p-3 text-center",children:t.quantity||0}),e.jsx("td",{className:"p-3 text-right",children:n(t.price||0)}),e.jsx("td",{className:"p-3 text-right font-medium",children:n((t.quantity||0)*(t.price||0))})]},s)})})]})})]}),e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Order Summary"}),(()=>{const t=Z(a);return e.jsxs("div",{className:"space-y-2 max-w-sm ml-auto",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{children:n(t.subtotal)})]}),t.serviceFee>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Service Fee:"}),e.jsx("span",{children:n(t.serviceFee)})]}),t.tax>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Tax:"}),e.jsx("span",{children:n(t.tax)})]}),t.shippingFee>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Shipping:"}),e.jsx("span",{children:n(t.shippingFee)})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between font-semibold text-lg",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:n(t.total)})]})]})})()]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[a.status==="shipped"&&a.tracking_number&&e.jsxs(N,{variant:"outline",onClick:()=>M(a),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Track Package"]}),e.jsxs(N,{variant:"outline",onClick:()=>B(a),children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Print Receipt"]})]})]})]})})]})}export{ot as default};
