import{c as be,r as n,g as we,a as Se,b as Ce,d as Pe,j as e,B as C,x as B,q as _,z as Fe,C as Ie,a5 as Ee,E as ke,a6 as Ae,a7 as u}from"./index-GnvmivW0.js";import{u as Te,F as $e,a as g,b as j,f as N,c as v,d as y,t as qe}from"./form-CgNvNzQO.js";import{C as z,b as D,a as te,c as ie}from"./card-Bsqf9o7h.js";import{I as b}from"./input-CDJz7BeV.js";import{L as h}from"./label-CbaFYhHW.js";import{A as Le,a as Re,b as Me}from"./avatar-T6GBhCEI.js";import{B as x}from"./badge-CL9MXKGS.js";import{A as Be,a as _e}from"./alert-BCAR44i4.js";import{S as le}from"./separator-Datc7ShZ.js";import{S as oe}from"./square-pen-BpFUY4eK.js";import{I as re}from"./image-Hw4wFcaj.js";import{S as de}from"./store-CA2BTc9t.js";import{S as ne}from"./shield-TxVeUbf2.js";import{C as me}from"./circle-check-big-CLZG244L.js";import{U as ce}from"./user-CCcReMRJ.js";import{M as pe}from"./mail-Ck7aiNy-.js";import{P as xe}from"./phone-CoIyr-gn.js";import{M as fe}from"./map-pin-Dn0fBe7g.js";import{S as ze}from"./save-Xig5-s-l.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=be("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]),Ge=Ae({firstName:u().min(1,"First name is required"),lastName:u().min(1,"Last name is required"),userName:u().min(3,"Username must be at least 3 characters").regex(/^[a-zA-Z0-9_]+$/,"Username can only contain letters, numbers, and underscores"),email:u().email("Please enter a valid email address"),phone:u().optional().refine(r=>!r||r===""?!0:/^[\+]?[1-9][\d]{0,15}$|^[\+]?[(]?[0-9]{3}[)]?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4,6}$|^[\+]?[0-9]{8,15}$/.test(r.replace(/[\s\-\(\)]/g,"")),"Please enter a valid phone number"),country:u().min(1,"Country is required")});function ma(){var W,Z;const[r,P]=n.useState(!1),[G,T]=n.useState(""),[$,J]=n.useState(!1),[O,F]=n.useState(!1),[Q,I]=n.useState(!1),[Je,w]=n.useState(0),[he,S]=n.useState(0),H=n.useRef(null),K=n.useRef(null),{toast:p}=we(),{user:t,refreshUserData:E}=Se(),{isFirebaseReady:q,fetchSettings:V}=Ce();n.useEffect(()=>{q||V()},[q,V]);const L=(t==null?void 0:t._id)||(t==null?void 0:t.id),{data:m}=Pe({queryKey:[`/api/profile/${L}`],enabled:!!L,staleTime:0}),a=m||t,o=Te({resolver:qe(Ge),defaultValues:{firstName:(a==null?void 0:a.firstName)||"",lastName:(a==null?void 0:a.lastName)||"",userName:(a==null?void 0:a.userName)||"",email:(a==null?void 0:a.email)||"",phone:(a==null?void 0:a.phonenumber)||(a==null?void 0:a.phone)||"",country:(a==null?void 0:a.country)||""}});n.useEffect(()=>{m&&!r&&o.reset({firstName:m.firstName||"",lastName:m.lastName||"",userName:m.userName||"",email:m.email||"",phone:m.phonenumber||m.phone||"",country:m.country||""})},[m,r,o]);const k=(a==null?void 0:a.authProvider)==="google"||(a==null?void 0:a.authProvider)==="apple",ue=async s=>{try{J(!0),T("");const{phone:i,...c}=s,X={...c,phonenumber:i},A=await fetch("/api/users/profile",{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(X)}),l=await A.json();if(!A.ok)throw new Error(l.error||"Failed to update profile");if(l.data){const f=localStorage.getItem("accessToken");localStorage.setItem("user",JSON.stringify(l.data)),f&&localStorage.setItem("accessToken",f),o.reset({firstName:l.data.firstName||"",lastName:l.data.lastName||"",userName:l.data.userName||"",email:l.data.email||"",phone:l.data.phonenumber||l.data.phone||"",country:l.data.country||""})}_.invalidateQueries({queryKey:[`/api/profile/${L}`]}),E&&await E(),p({title:"Profile updated",description:"Your profile has been successfully updated."}),P(!1)}catch(i){const c=i instanceof Error?i.message:"Profile update failed";T(c),p({title:"Update failed",description:c,variant:"destructive"})}finally{J(!1)}},ge=()=>{o.reset(),P(!1),T("")},Y=async(s,i)=>{var l;const c=(l=s.target.files)==null?void 0:l[0];if(!c)return;if(!q){p({title:"Upload not ready",description:"Please wait for the app to fully load before uploading images.",variant:"destructive"});return}if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(c.type)){p({title:"Invalid file type",description:"Please select a valid image file (JPEG, PNG, GIF, or WebP)",variant:"destructive"});return}const A=5*1024*1024;if(c.size>A){p({title:"File too large",description:"Please select an image smaller than 5MB",variant:"destructive"});return}try{i==="profile"?(F(!0),w(0)):(I(!0),S(0));const f=Fe(),je=Date.now(),Ne=`${i==="profile"?"profile-images":"cover-images"}/${(t==null?void 0:t.id)||"unknown"}_${je}_${c.name}`,ve=Ie(f,Ne),U=Ee(ve,c);U.on("state_changed",d=>{const R=d.bytesTransferred/d.totalBytes*100;i==="profile"?w(Math.round(R)):S(Math.round(R))},d=>{console.error("Upload error:",d),p({title:"Upload failed",description:d.message||"Failed to upload image",variant:"destructive"}),i==="profile"?(F(!1),w(0)):(I(!1),S(0))},async()=>{try{const d=await ke(U.snapshot.ref),ee=await fetch("/api/users/profile",{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({[i==="profile"?"profilePhoto":"coverPhoto"]:d})}),M=await ee.json();if(!ee.ok)throw new Error(M.error||`Failed to update ${i} photo`);if(M.data){const se=localStorage.getItem("user");if(se){const ye={...JSON.parse(se),...M.data};localStorage.setItem("user",JSON.stringify(ye))}}const ae=(t==null?void 0:t._id)||(t==null?void 0:t.id);_.invalidateQueries({queryKey:["/api/profile",ae]}),_.invalidateQueries({queryKey:[`/api/profile/${ae}`]}),E&&await E(),p({title:`${i==="profile"?"Profile":"Cover"} photo updated`,description:`Your ${i} photo has been successfully updated.`})}catch(d){console.error("Profile update error:",d),p({title:"Update failed",description:d instanceof Error?d.message:`Failed to update ${i} photo`,variant:"destructive"})}finally{i==="profile"?(F(!1),w(0)):(I(!1),S(0))}})}catch(f){console.error("Image upload error:",f),p({title:"Upload failed",description:f instanceof Error?f.message:"Failed to upload image",variant:"destructive"}),i==="profile"?(F(!1),w(0)):(I(!1),S(0))}};return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:"w-full p-4 sm:p-6 space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground",children:"Profile"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Manage your account information and preferences"})]}),!r&&e.jsxs(C,{onClick:()=>P(!0),"data-testid":"button-edit-profile",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Edit Profile"]})]}),e.jsxs(z,{className:"overflow-hidden",children:[e.jsxs("div",{className:"relative h-32 sm:h-48 bg-gradient-to-r from-primary/20 to-primary/5",children:[a!=null&&a.coverPhoto?e.jsx("img",{src:a.coverPhoto,alt:"Cover",className:"w-full h-full object-cover","data-testid":"img-cover-photo"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(re,{className:"h-12 w-12 text-muted-foreground/30"})}),r&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:K,type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:s=>Y(s,"cover"),className:"hidden","data-testid":"input-cover-upload"}),e.jsx(C,{variant:"secondary",size:"sm",className:"absolute bottom-3 right-3",onClick:()=>{var s;return(s=K.current)==null?void 0:s.click()},disabled:Q,"data-testid":"button-upload-cover",children:Q?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"h-4 w-4 mr-2 animate-spin"}),he,"%"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Change Cover"]})})]}),e.jsx("div",{className:"absolute -bottom-12 left-4 sm:left-6",children:e.jsxs("div",{className:"relative",children:[e.jsxs(Le,{className:"h-24 w-24 border-4 border-background","data-testid":"avatar-profile",children:[e.jsx(Re,{src:a==null?void 0:a.profilePhoto}),e.jsxs(Me,{className:"text-lg bg-muted",children:[(W=a==null?void 0:a.firstName)==null?void 0:W[0],(Z=a==null?void 0:a.lastName)==null?void 0:Z[0]]})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:H,type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:s=>Y(s,"profile"),className:"hidden","data-testid":"input-file-upload"}),e.jsx(C,{variant:"secondary",size:"icon",className:"absolute bottom-0 right-0 h-8 w-8 rounded-full",onClick:()=>{var s;return(s=H.current)==null?void 0:s.click()},disabled:O,"data-testid":"button-upload-photo",children:O?e.jsx(B,{className:"h-4 w-4 animate-spin"}):e.jsx(De,{className:"h-4 w-4"})})]})]})})]}),e.jsxs(D,{className:"pt-16 pb-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-4",children:[e.jsxs("h2",{className:"text-xl font-semibold","data-testid":"text-display-name",children:[a==null?void 0:a.firstName," ",a==null?void 0:a.lastName]}),(a==null?void 0:a.seller)&&e.jsxs(x,{variant:"secondary",className:"gap-1",children:[e.jsx(de,{className:"h-3 w-3"}),"Seller"]}),(a==null?void 0:a.admin)&&e.jsxs(x,{variant:"default",className:"gap-1",children:[e.jsx(ne,{className:"h-3 w-3"}),"Admin"]}),(a==null?void 0:a.above_age)&&e.jsxs(x,{variant:"outline",className:"gap-1",children:[e.jsx(me,{className:"h-3 w-3"}),"Verified"]})]}),e.jsxs("p",{className:"text-muted-foreground","data-testid":"text-username-display",children:["@",(a==null?void 0:a.userName)||"username"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6",children:[e.jsxs(z,{className:"lg:col-span-1",children:[e.jsx(te,{children:e.jsxs(ie,{className:"flex items-center text-base sm:text-lg",children:[e.jsx(ce,{className:"h-5 w-5 mr-2"}),"Quick Info"]})}),e.jsxs(D,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center h-10 w-10 rounded-full bg-primary/10",children:e.jsx(pe,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Email"}),e.jsx("p",{className:"text-sm font-medium truncate","data-testid":"text-email-quick",children:(a==null?void 0:a.email)||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center h-10 w-10 rounded-full bg-primary/10",children:e.jsx(xe,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Phone"}),e.jsx("p",{className:"text-sm font-medium","data-testid":"text-phone-quick",children:(a==null?void 0:a.phonenumber)||(a==null?void 0:a.phone)||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center h-10 w-10 rounded-full bg-primary/10",children:e.jsx(fe,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Country"}),e.jsx("p",{className:"text-sm font-medium","data-testid":"text-country-quick",children:(a==null?void 0:a.country)||"Not provided"})]})]}),k&&e.jsx("div",{className:"pt-2",children:e.jsxs(x,{variant:"outline",className:"w-full justify-center gap-1",children:[(a==null?void 0:a.authProvider)==="google"?"Google":"Apple"," Account"]})})]})]}),e.jsxs(z,{className:"lg:col-span-2",children:[e.jsx(te,{children:e.jsxs(ie,{className:"flex items-center text-base sm:text-lg",children:[e.jsx(oe,{className:"h-5 w-5 mr-2"}),r?"Edit Information":"Profile Details"]})}),e.jsxs(D,{children:[G&&e.jsx(Be,{variant:"destructive",className:"mb-6","data-testid":"alert-update-error",children:e.jsx(_e,{children:G})}),r?e.jsx($e,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(ue),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{control:o.control,name:"firstName",render:({field:s})=>e.jsxs(j,{children:[e.jsx(N,{children:"First Name"}),e.jsx(v,{children:e.jsx(b,{placeholder:"Enter your first name","data-testid":"input-first-name",...s})}),e.jsx(y,{})]})}),e.jsx(g,{control:o.control,name:"lastName",render:({field:s})=>e.jsxs(j,{children:[e.jsx(N,{children:"Last Name"}),e.jsx(v,{children:e.jsx(b,{placeholder:"Enter your last name","data-testid":"input-last-name",...s})}),e.jsx(y,{})]})})]}),e.jsx(g,{control:o.control,name:"userName",render:({field:s})=>e.jsxs(j,{children:[e.jsx(N,{children:"Username"}),e.jsx(v,{children:e.jsx(b,{placeholder:"Enter your username","data-testid":"input-username",...s})}),e.jsx(y,{})]})}),e.jsx(g,{control:o.control,name:"email",render:({field:s})=>e.jsxs(j,{children:[e.jsx(N,{children:"Email Address"}),e.jsx(v,{children:e.jsx(b,{type:"email",placeholder:"Enter your email","data-testid":"input-email",disabled:k,...s})}),k&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Email cannot be changed for ",(a==null?void 0:a.authProvider)==="google"?"Google":"Apple"," accounts"]}),e.jsx(y,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{control:o.control,name:"phone",render:({field:s})=>e.jsxs(j,{children:[e.jsx(N,{children:"Phone Number"}),e.jsx(v,{children:e.jsx(b,{placeholder:"Enter your phone number","data-testid":"input-phone",...s})}),e.jsx(y,{})]})}),e.jsx(g,{control:o.control,name:"country",render:({field:s})=>e.jsxs(j,{children:[e.jsx(N,{children:"Country"}),e.jsx(v,{children:e.jsx(b,{placeholder:"Enter your country","data-testid":"input-country",...s})}),e.jsx(y,{})]})})]}),e.jsx(le,{className:"my-6"}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(C,{type:"button",variant:"outline",onClick:ge,disabled:$,"data-testid":"button-cancel",children:"Cancel"}),e.jsx(C,{type:"submit",disabled:$,"data-testid":"button-save",children:$?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"h-4 w-4 animate-spin mr-2"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),"Save Changes"]})})]})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{className:"text-sm font-medium text-muted-foreground",children:"First Name"}),e.jsx("p",{className:"text-foreground","data-testid":"text-first-name",children:(a==null?void 0:a.firstName)||"Not provided"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{className:"text-sm font-medium text-muted-foreground",children:"Last Name"}),e.jsx("p",{className:"text-foreground","data-testid":"text-last-name",children:(a==null?void 0:a.lastName)||"Not provided"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{className:"text-sm font-medium text-muted-foreground",children:"Username"}),e.jsxs("p",{className:"text-foreground","data-testid":"text-username",children:["@",(a==null?void 0:a.userName)||"Not provided"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4"}),"Email Address",k&&e.jsx(x,{variant:"secondary",className:"text-xs",children:(a==null?void 0:a.authProvider)==="google"?"Google":"Apple"})]}),e.jsx("p",{className:"text-foreground","data-testid":"text-email",children:(a==null?void 0:a.email)||"Not provided"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),"Phone Number"]}),e.jsx("p",{className:"text-foreground","data-testid":"text-phone",children:(a==null?void 0:a.phonenumber)||(a==null?void 0:a.phone)||"Not provided"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(fe,{className:"h-4 w-4"}),"Country"]}),e.jsx("p",{className:"text-foreground","data-testid":"text-country",children:(a==null?void 0:a.country)||"Not provided"})]})]}),e.jsx(le,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{className:"text-sm font-medium text-muted-foreground",children:"Account Status"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[a!=null&&a.seller?e.jsxs(x,{variant:"secondary",className:"gap-1",children:[e.jsx(de,{className:"h-3 w-3"}),"Seller Account"]}):e.jsxs(x,{variant:"outline",className:"gap-1",children:[e.jsx(ce,{className:"h-3 w-3"}),"Buyer Account"]}),(a==null?void 0:a.admin)&&e.jsxs(x,{variant:"default",className:"gap-1",children:[e.jsx(ne,{className:"h-3 w-3"}),"Administrator"]}),(a==null?void 0:a.above_age)&&e.jsxs(x,{variant:"outline",className:"gap-1 text-green-600 border-green-600",children:[e.jsx(me,{className:"h-3 w-3"}),"Age Verified"]})]})]})]})]})]})]})]})})}export{ma as default};
