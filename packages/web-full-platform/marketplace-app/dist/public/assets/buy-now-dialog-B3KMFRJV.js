import{c as ne,g as le,a as re,r as B,d as R,q as g,y as D,j as e,B as Q,x as _,T as oe}from"./index-GnvmivW0.js";import{D as ce,a as de,b as xe,c as me}from"./dialog-D1L4tMGI.js";import{B as he}from"./badge-CL9MXKGS.js";import{S as w}from"./separator-Datc7ShZ.js";import{A as fe,a as ge}from"./alert-BCAR44i4.js";import{u as ye}from"./useMutation-DAKVWGzI.js";import{C as q}from"./chevron-right-CXw-mF7y.js";import{P as be}from"./plus-CxBznHFO.js";import{C as we}from"./credit-card-B0WsppBV.js";import{M as je}from"./map-pin-Dn0fBe7g.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=ne("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);function J({open:m,onOpenChange:F,product:s,shippingEstimate:C,onOpenPaymentMethods:H,onOpenShippingAddresses:V,offerPrice:o}){var Y,P,T,$,U,G;const{toast:h}=le(),{user:t}=re(),[r,I]=B.useState(1),[S,L]=B.useState(!1),f=(s==null?void 0:s.quantity)||1,X=f>1,W=(t==null?void 0:t._id)||(t==null?void 0:t.id)||(t==null?void 0:t.id),x=(t==null?void 0:t.defaultpaymentmethod)||null,i=(t==null?void 0:t.address)||null,j=i&&i.zipcode&&i.state&&i.city;console.log("ðŸš¢ BUY NOW DIALOG - Query conditions:",{open:m,hasShippingProfile:!!(s!=null&&s.shipping_profile),hasWeight:!!((Y=s==null?void 0:s.shipping_profile)!=null&&Y.weight),weight:(P=s==null?void 0:s.shipping_profile)==null?void 0:P.weight,hasDefaultAddress:!!i,hasValidAddress:j,hasUser:!!t,defaultAddress:i,userAddress:t==null?void 0:t.address,willQueryRun:m&&!!((T=s==null?void 0:s.shipping_profile)!=null&&T.weight)&&j&&!!t});const Z=!!(m&&(($=s==null?void 0:s.shipping_profile)!=null&&$.weight)&&j&&t),{data:N,isLoading:u,error:ue}=R({queryKey:["/api/shipping/estimate",s==null?void 0:s._id,r,i==null?void 0:i.id],queryFn:async()=>{if(!(s!=null&&s.shipping_profile)||!i)return{amount:"0.00"};const n=(t==null?void 0:t._id)||(t==null?void 0:t.id)||(t==null?void 0:t.id),c=s._id||s.id;let d="";typeof s.owner=="string"?d=s.owner:s.owner&&(d=s.owner._id||s.owner.id||""),!d&&s.ownerId&&(d=typeof s.ownerId=="string"?s.ownerId:s.ownerId._id||s.ownerId.id||"");try{const l=await(await D("POST","/api/shipping/estimate",{weight:s.shipping_profile.weight,unit:s.shipping_profile.scale||"oz",product:c,owner:d,customer:n,tokshow:s.tokshow,buying_label:!1})).json();return(l==null?void 0:l.success)===!1&&(l!=null&&l.message)?{error:!0,message:l.message,amount:"0.00"}:l!=null&&l.error?{error:!0,message:l.error,amount:"0.00"}:l}catch(b){return console.error("Shipping estimate error:",b),{error:!0,message:"Unable to calculate shipping. Please try again.",amount:"0.00"}}},enabled:Z,staleTime:0,gcTime:0,refetchOnMount:"always",retry:!1}),a=N&&Object.keys(N).length>0?N:C;console.log("ðŸš¢ BUY NOW DIALOG - passedShippingEstimate:",C),console.log("ðŸš¢ BUY NOW DIALOG - fetchedShippingEstimate:",N),console.log("ðŸš¢ BUY NOW DIALOG - isLoadingShipping:",u),console.log("ðŸš¢ BUY NOW DIALOG - final shippingEstimate:",a);const E=!!(m&&(s!=null&&s.id)),{data:p,isLoading:ee}=R({queryKey:["/api/tax/estimate",s==null?void 0:s.id,r],enabled:E});B.useEffect(()=>{m&&(I(1),L(!1))},[m]);const se=()=>{r<f&&I(r+1)},ae=()=>{r>1&&I(r-1)},v=(o??(s==null?void 0:s.price)??0)*r,z=(a==null?void 0:a.error)===!0,te=(a==null?void 0:a.message)||"",M=z?0:parseFloat((a==null?void 0:a.amount)||"0"),y=parseFloat((p==null?void 0:p.tax)||"0"),O=v+M+y,k=ye({mutationFn:async()=>{var l,K;const n=s._id||s.id;let c="";if(typeof s.owner=="string"?c=s.owner:s.owner&&(c=s.owner._id||s.owner.id||""),!c&&s.ownerId&&(c=typeof s.ownerId=="string"?s.ownerId:s.ownerId._id||s.ownerId.id||""),console.log("ðŸš¢ BUY NOW DIALOG - shippingEstimate:",a),console.log("ðŸš¢ BUY NOW DIALOG - shippingEstimate.totalWeightOz:",a==null?void 0:a.totalWeightOz),console.log("ðŸš¢ BUY NOW DIALOG - shippingEstimate.carrierAccount:",a==null?void 0:a.carrierAccount),o!=null){const A={offeredPrice:o,product:n,seller:c,buyer:W,quantity:r,subtotal:parseFloat(v.toFixed(2)),shippingFee:parseFloat((a==null?void 0:a.amount)||"0"),tax:parseFloat(y.toString()||"0"),bundleId:(a==null?void 0:a.bundleId)||"",rate_id:(a==null?void 0:a.rate_id)||"",servicelevel:((l=a==null?void 0:a.servicelevel)==null?void 0:l.name)||(a==null?void 0:a.servicelevel)||"",totalWeightOz:parseFloat((a==null?void 0:a.totalWeightOz)||"0"),seller_shipping_fee_pay:parseFloat((a==null?void 0:a.seller_shipping_fee_pay)||"0")};return s.tokshow&&(A.tokshow=s.tokshow),console.log("ðŸ“¦ BUY NOW DIALOG - Creating OFFER with payload:",JSON.stringify(A,null,2)),{...await(await D("POST","/api/offers",A)).json(),isOffer:!0}}const d=s.tokshow?"tokshow":"marketplace",b={product:n,status:"processing",shippingFee:parseFloat((a==null?void 0:a.amount)||"0"),servicelevel:((K=a==null?void 0:a.servicelevel)==null?void 0:K.name)||(a==null?void 0:a.servicelevel)||"",rate_id:(a==null?void 0:a.rate_id)||"",bundleId:(a==null?void 0:a.bundleId)||"",totalWeightOz:parseFloat((a==null?void 0:a.totalWeightOz)||"0"),seller_shipping_fee_pay:parseFloat((a==null?void 0:a.seller_shipping_fee_pay)||"0"),carrierAccount:(a==null?void 0:a.carrierAccount)||"",subtotal:v,tax:parseFloat(y.toString()||"0"),seller:c,buyer:W,quantity:r,total:parseFloat(O.toFixed(2)),color:"",size:"",tokshow:s.tokshow||"",ordertype:d};return console.log("ðŸ“¦ BUY NOW DIALOG - Full payload before sending:",JSON.stringify(b,null,2)),await D("POST",`/api/orders/${n}`,b)},onSuccess:n=>{if(n!=null&&n.isOffer){console.log("Offer created, response:",n),h({title:"Offer Sent!",description:"Your offer has been sent to the seller. You can track it in My Offers."}),g.invalidateQueries({queryKey:["/api/offers"]}),g.invalidateQueries({queryKey:["/api/products"]}),g.invalidateQueries({queryKey:["/api/rooms"]}),F(!1);return}h({title:"Purchase Successful!",description:"Your order has been placed"}),g.invalidateQueries({queryKey:["/api/orders"]}),g.invalidateQueries({queryKey:["/api/rooms"]}),g.invalidateQueries({queryKey:["/api/products"]}),F(!1)},onError:n=>{var d;const c=((d=n==null?void 0:n.response)==null?void 0:d.error)||(n==null?void 0:n.message)||"Failed to complete purchase";h({title:o?"Offer Failed":"Purchase Failed",description:c,variant:"destructive"})}}),ie=()=>{if(!x){h({title:"No Payment Method",description:"Please add a payment method first",variant:"destructive"});return}if(!i){h({title:"No Address",description:"Please add a shipping address first",variant:"destructive"});return}if(r>f){h({title:"Quantity Error",description:"Quantity exceeds available stock",variant:"destructive"});return}k.mutate()};return e.jsx(ce,{open:m,onOpenChange:F,children:e.jsxs(de,{className:"bg-zinc-900 border-zinc-800 text-white max-w-lg max-h-[90vh] overflow-y-auto [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]",children:[e.jsx(xe,{children:e.jsx(me,{className:"text-white text-xl",children:"Buy Now"})}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"flex gap-4",children:[((U=s==null?void 0:s.images)==null?void 0:U[0])&&e.jsx("div",{className:"w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden bg-zinc-800",children:e.jsx("img",{src:s.images[0],alt:s.name,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-base leading-tight mb-1",children:s==null?void 0:s.name}),f>0&&e.jsxs("p",{className:"text-sm text-zinc-400",children:[f," available"]})]})]}),e.jsx(w,{className:"bg-zinc-800"}),X&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>L(!S),className:"w-full flex items-center justify-between py-2 text-sm","data-testid":"button-toggle-quantity",children:[e.jsxs("span",{className:"font-medium",children:["Quantity: ",r]}),e.jsx(q,{className:`h-4 w-4 text-zinc-400 transition-transform ${S?"rotate-90":""}`})]}),S&&e.jsxs("div",{className:"flex items-center gap-4 mt-2",children:[e.jsx(Q,{size:"icon",variant:"outline",className:"h-9 w-9 border-zinc-700 bg-zinc-800 text-white hover:bg-zinc-700",onClick:ae,disabled:r<=1,"data-testid":"button-decrement-quantity",children:e.jsx(Ne,{className:"h-4 w-4",style:{color:"white",stroke:"white"}})}),e.jsx("div",{className:"flex-1 text-center",children:e.jsx("span",{className:"text-lg font-bold",children:r})}),e.jsx(Q,{size:"icon",variant:"outline",className:"h-9 w-9 border-zinc-700 bg-zinc-800 text-white hover:bg-zinc-700",onClick:se,disabled:r>=f,"data-testid":"button-increment-quantity",children:e.jsx(be,{className:"h-4 w-4",style:{color:"white",stroke:"white"}})})]})]}),e.jsx(w,{className:"bg-zinc-800"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold mb-2",children:"Payment Method"}),e.jsxs("button",{onClick:H,className:"w-full flex items-center justify-between py-3 hover:bg-zinc-800/50 rounded-lg px-2 transition-colors","data-testid":"button-payment-method",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(we,{className:"h-5 w-5 text-zinc-400"}),x?e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"text-sm",children:[(G=x.brand)==null?void 0:G.toUpperCase()," â€¢â€¢â€¢â€¢ ",x.last4]}),x.exp_month&&x.exp_year&&e.jsxs("p",{className:"text-xs text-zinc-400",children:["Expires ",String(x.exp_month).padStart(2,"0"),"/",x.exp_year]})]}):e.jsx("span",{className:"text-sm text-zinc-400",children:"Add payment method"})]}),e.jsx(q,{className:"h-4 w-4 text-zinc-400"})]})]}),e.jsx(w,{className:"bg-zinc-800"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold mb-2",children:"Shipping Address"}),e.jsxs("button",{onClick:V,className:"w-full flex items-center justify-between py-3 hover:bg-zinc-800/50 rounded-lg px-2 transition-colors","data-testid":"button-shipping-address",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{className:"h-5 w-5 text-zinc-400"}),i?e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"text-sm",children:[(i==null?void 0:i.addrress1)||(i==null?void 0:i.address1)||"Address on file",i.city&&`, ${i.city}`]}),e.jsxs("p",{className:"text-xs text-zinc-400",children:[i.state&&`${i.state} `,i.zipcode]})]}):e.jsx("span",{className:"text-sm text-zinc-400",children:"Add shipping address"})]}),e.jsx(q,{className:"h-4 w-4 text-zinc-400"})]})]}),e.jsx(w,{className:"bg-zinc-800"}),o&&e.jsx("div",{className:"bg-blue-900/20 border border-blue-800/30 rounded-lg p-3",children:e.jsx("p",{className:"text-xs text-blue-300",children:"You won't be charged until the seller accepts your offer."})}),e.jsxs("div",{className:"space-y-2 bg-zinc-800/30 p-4 rounded-lg",children:[o&&e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(he,{className:"bg-green-600 text-white text-xs",children:"Offer Price"}),e.jsxs("span",{className:"text-xs text-zinc-400 line-through",children:["$",((s==null?void 0:s.price)||0).toFixed(2)]}),e.jsxs("span",{className:"text-xs text-green-400 font-medium",children:["$",o.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-zinc-400",children:o?"Your Offer":"Subtotal"}),e.jsxs("span",{className:"font-medium",children:["$",v.toFixed(2)]})]}),j&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-zinc-400",children:"Shipping"}),u?e.jsx(_,{className:"h-4 w-4 animate-spin"}):z?e.jsx("span",{className:"text-destructive text-xs font-semibold",children:"Error"}):e.jsxs("span",{className:"font-medium",children:["$",M.toFixed(2)]})]}),y>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-zinc-400",children:"Tax"}),ee?e.jsx(_,{className:"h-4 w-4 animate-spin"}):e.jsxs("span",{className:"font-medium",children:["$",y.toFixed(2)]})]}),e.jsx(w,{className:"bg-zinc-700 my-2"}),e.jsxs("div",{className:"flex justify-between text-base font-bold",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["$",O.toFixed(2)]})]})]}),z&&e.jsxs(fe,{variant:"destructive",className:"bg-destructive/10 border-destructive/20",children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsx(ge,{className:"ml-2",children:te})]}),!z&&e.jsx(Q,{className:"w-full h-12 text-base font-bold bg-primary hover:bg-primary/90 text-primary-foreground",onClick:ie,disabled:k.isPending||!x||!i||u,"data-testid":"button-confirm-buy-now",children:k.isPending?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-5 w-5 mr-2 animate-spin"}),o?"Submitting Offer...":"Processing..."]}):u?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-5 w-5 mr-2 animate-spin"}),"Calculating shipping..."]}):o?`Submit Offer - $${O.toFixed(2)}`:`Buy Now - $${O.toFixed(2)}`})]})]})})}const qe=Object.freeze(Object.defineProperty({__proto__:null,BuyNowDialog:J,default:J},Symbol.toStringTag,{value:"Module"}));export{J as B,Ne as M,qe as b};
