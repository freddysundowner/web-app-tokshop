import{f as A,r as d,e as J,t as V,D as z,j as t,L as v,d as T}from"./index-DOZKoalF.js";import{u as I}from"./useQuery-48pQeuS3.js";import{u as _}from"./useMutation-BBndlB0x.js";import{u as G,S as H}from"./show-card-CdrjScR7.js";import{B as M}from"./button-bCrgsaso.js";import{u as W,g as X}from"./use-api-config-Dxj_74i4.js";import{C as Y}from"./chevron-right-SEiIbCON.js";import"./avatar-BNno7OSM.js";import"./format-D46ChU1D.js";import"./isTomorrow-BvLd__Ji.js";function le(){var S,U,q,L;const[,g]=A("/category/:id"),o=g==null?void 0:g.id,[m,c]=d.useState(!1),{toast:f}=J(),j=V(),{externalApiUrl:$}=W(),{data:n}=I({queryKey:["/api/auth/session"]}),i=((S=n==null?void 0:n.data)==null?void 0:S._id)||((U=n==null?void 0:n.data)==null?void 0:U.id),{data:u}=I({queryKey:["/api/categories"]}),y=(u==null?void 0:u.categories)||[];let s=y.find(e=>e._id===o),l;if(!s)for(const e of y){const r=(q=e.subCategories)==null?void 0:q.find(a=>a._id===o);if(r){s=r,l=e;break}}const{data:h,fetchNextPage:b,hasNextPage:N,isFetchingNextPage:x,isLoading:K}=G({queryKey:["/api/rooms",o],queryFn:async({pageParam:e=1})=>{const r=new URLSearchParams({page:String(e),limit:"20",status:"active"});return o&&r.set("category",o),(await fetch(`/api/rooms?${r}`)).json()},getNextPageParam:(e,r)=>{const a=r.length,B=e.totalDoc||0,C=Math.max(e.limits||20,1),O=Math.ceil(B/C);return a<O?a+1:void 0},initialPageParam:1,enabled:!!o}),P=((L=h==null?void 0:h.pages)==null?void 0:L.flatMap(e=>e.rooms||[]))||[],F=d.useRef(null);d.useEffect(()=>{const e=new IntersectionObserver(a=>{a[0].isIntersecting&&N&&!x&&b()},{threshold:0,rootMargin:"100px"}),r=F.current;return r&&e.observe(r),()=>{r&&e.unobserve(r)}},[N,x,b]);const k=(s==null?void 0:s.subCategories)||[],E=!!l;z((s==null?void 0:s.name)||"Category");const p=_({mutationFn:async()=>{if(!i||!o)throw new Error("User not logged in");const e=await fetch(`/api/category/follow/${o}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({userid:i})});if(!e.ok){const r=await e.json();throw new Error(r.error||"Failed to follow category")}return e.json()},onSuccess:()=>{c(!0),j.invalidateQueries({queryKey:["/api/categories"]})},onError:e=>{f({title:"Error",description:e.message||"Failed to follow category",variant:"destructive"})}}),w=_({mutationFn:async()=>{if(!i||!o)throw new Error("User not logged in");const e=await fetch(`/api/category/unfollow/${o}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({userid:i})});if(!e.ok){const r=await e.json();throw new Error(r.error||"Failed to unfollow category")}return e.json()},onSuccess:()=>{c(!1),j.invalidateQueries({queryKey:["/api/categories"]})},onError:e=>{f({title:"Error",description:e.message||"Failed to unfollow category",variant:"destructive"})}});d.useEffect(()=>{var e;if(s&&i){const r=((e=s.followers)==null?void 0:e.includes(i))||!1;c(r)}else c(!1);window.scrollTo({top:0,behavior:"smooth"})},[o,s,i]);const R=()=>{if(!i){f({title:"Login Required",description:"Please log in to follow categories",variant:"destructive"});return}m?w.mutate():p.mutate()},Q=e=>e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toString();return s?t.jsx("div",{className:"flex flex-col min-h-screen bg-background","data-testid":"page-category",children:t.jsx("main",{className:"flex-1 overflow-y-auto bg-white dark:bg-background",children:t.jsx("div",{className:"flex justify-center w-full",children:t.jsxs("div",{className:"w-full lg:w-[90%] px-2 py-3 lg:p-6",children:[E&&l&&t.jsxs("div",{className:"flex items-center gap-2 mb-3 text-sm","data-testid":"breadcrumb",children:[t.jsx(v,{href:`/category/${l._id}`,className:"text-primary hover:underline",children:l.name}),t.jsx(Y,{className:"h-4 w-4 text-muted-foreground"}),t.jsx("span",{className:"text-muted-foreground",children:s==null?void 0:s.name})]}),t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h1",{className:"text-2xl lg:text-3xl font-bold text-foreground","data-testid":"heading-category",children:s==null?void 0:s.name}),t.jsx(M,{className:T("rounded-full font-semibold px-4 lg:px-6 h-9 lg:h-10",m?"bg-muted text-foreground hover:bg-muted/80":"bg-yellow-400 text-black hover:bg-yellow-500"),onClick:R,disabled:p.isPending||w.isPending,"data-testid":"button-follow-category",children:p.isPending||w.isPending?"Loading...":m?"Following":"Follow"})]}),!E&&k.length>0&&t.jsx("div",{className:"mb-6 overflow-x-auto scrollbar-hide","data-testid":"subcategories-container",children:t.jsx("div",{className:"flex gap-3",children:k.map(e=>{const r=e.icon?X(e.icon,$):"";return t.jsx(v,{href:`/category/${e._id}`,className:T("relative flex-shrink-0 h-16 lg:h-20 rounded-lg overflow-hidden transition-all","hover:ring-2 hover:ring-primary"),"data-testid":`subcategory-${e._id}`,children:t.jsxs("div",{className:"relative h-full w-32 lg:w-40",children:[r?t.jsx("img",{src:r,alt:e.name,className:"absolute inset-0 w-full h-full object-cover"}):t.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/20 to-primary/40"}),t.jsx("div",{className:"absolute inset-0 bg-black/30"}),t.jsxs("div",{className:"relative h-full flex flex-col justify-between p-2.5",children:[(e.viewersCount??0)>0&&t.jsxs("div",{className:"flex items-center gap-1 self-start",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-red-600"}),t.jsxs("span",{className:"text-white text-xs font-semibold",children:[Q(e.viewersCount??0)," viewers"]})]}),t.jsx("div",{className:"text-white font-bold text-sm text-left leading-tight",children:e.name})]})]})},e._id)})})}),K?t.jsx("div",{className:"flex items-center justify-center h-64",children:t.jsx("p",{className:"text-muted-foreground",children:"Loading shows..."})}):P.length===0?t.jsx("div",{className:"flex items-center justify-center h-64",children:t.jsx("p",{className:"text-muted-foreground",children:"No live shows in this category"})}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-2 lg:gap-4","data-testid":"live-shows-grid",children:P.map(e=>t.jsx(H,{show:e,currentUserId:i||"",variant:"grid",categoryName:s==null?void 0:s.name},e._id))}),t.jsx("div",{ref:F,className:"h-20 flex items-center justify-center mt-4",children:x&&t.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading more shows..."})})]})]})})})}):t.jsx("div",{className:"flex items-center justify-center min-h-screen",children:t.jsxs("div",{className:"text-center",children:[t.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Category not found"}),t.jsx(v,{href:"/browse",children:t.jsx(M,{children:"Back to Browse"})})]})})}export{le as default};
