import{r as p,a as be,b as Ne,f as we,j as e,B as v,I as ye}from"./index-FVTY5sKH.js";import{u as ve}from"./useQuery-DsZx8GVA.js";import{C as G}from"./card-CF4CqaN2.js";import{B as J}from"./badge-BTf7a5Ku.js";import{S as K,a as W,b as X,c as Z,d as x}from"./select-D3ZFUKhx.js";import{D as ke,a as Se,b as Pe,c as D}from"./dropdown-menu-BrJ5tGq0.js";import{D as Ce,a as Te,b as $e,c as De}from"./dialog-A2pFZcsY.js";import{a as N,f as n,g as ee}from"./pricing-DCyf_yea.js";import{C as Ie}from"./pagination-1EOLrp3H.js";import{S as Oe}from"./search-zDcbIzzp.js";import{P as I}from"./package-dXPzRBiL.js";import{E as Ae}from"./ellipsis-Ds8nGjh8.js";import{P as te}from"./printer-DfjmthyX.js";import{T as se}from"./truck-DDM-Vnwo.js";import{f as O}from"./format-D46ChU1D.js";import"./index-BdQq_4o_.js";import"./index-BaZiuLT8.js";import"./index-Cbw5mxKQ.js";import"./chevron-down-BD1mluAZ.js";import"./check-DWjWNqF1.js";import"./chevron-up-D8QnUA5s.js";import"./index-CoWBA0E_.js";import"./chevron-right-HRo85rGP.js";import"./circle-tm_CQXKA.js";import"./chevron-left-CnSIvoVj.js";const ae={processing:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400",shipped:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400",delivered:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400",cancelled:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",ended:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400"},re={processing:1,shipped:2,delivered:3,ended:4,cancelled:5},A=c=>c?c.split("_").map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(" "):"Unknown";function it(){var q,R,H,Q,V;const[c,w]=p.useState(""),[u,ne]=p.useState("all"),[_,ie]=p.useState("status"),[k,S]=p.useState(1),[y,le]=p.useState(20),[a,F]=p.useState(null),[de,P]=p.useState(!1),{user:i}=be(),{settings:ce}=Ne(),{toast:M}=we(),{data:g,isLoading:oe,error:C,isError:me,refetch:pe}=ve({queryKey:["external-purchases",i==null?void 0:i.id,u,k,y],queryFn:async()=>{const t=new URLSearchParams;i!=null&&i.id&&t.set("customer",i.id),u&&u!=="all"&&t.set("status",u),t.set("page",k.toString()),t.set("limit",y.toString());const s=await fetch(`/api/orders?${t.toString()}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error(`External API error: ${s.status}`);return s.json()},enabled:!!(i!=null&&i.id),staleTime:0,refetchOnMount:!0});p.useEffect(()=>{const t=sessionStorage.getItem("openPurchaseOrder");if(t)try{const s=JSON.parse(t);F(s),P(!0),sessionStorage.removeItem("openPurchaseOrder")}catch(s){console.error("Failed to parse order from sessionStorage:",s),sessionStorage.removeItem("openPurchaseOrder")}},[]);const E=(g==null?void 0:g.orders)||[],T=(g==null?void 0:g.total)||E.length,xe=Math.ceil(T/y),$=[...E.filter(t=>!c||t._id.toLowerCase().includes(c.toLowerCase())||(t.items||[]).some(l=>{var r,d;return(d=(r=l.productId)==null?void 0:r.name)==null?void 0:d.toLowerCase().includes(c.toLowerCase())}))].sort((t,s)=>{switch(_){case"total-high":return N(s)-N(t);case"total-low":return N(t)-N(s);case"status":const l=re[t.status]||999,r=re[s.status]||999;return l-r;default:return 0}}),B=t=>{if(!t.tracking_number){M({title:"No Tracking Available",description:"This order doesn't have a tracking number yet.",variant:"destructive"});return}const s=`https://parcelsapp.com/en/tracking/${t.tracking_number}`;window.open(s,"_blank","noopener,noreferrer")},L=t=>{F(t),P(!0)},U=t=>{var d,h,o,j,f;const s=ee(t),l=`
      <!DOCTYPE html>
      <html>
        <head>
          <title>Receipt - Order #${t.invoice||((d=t._id)==null?void 0:d.slice(-8))||"N/A"}</title>
          <style>
            body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .order-info { margin-bottom: 20px; }
            .items-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .items-table th, .items-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .items-table th { background-color: #f2f2f2; }
            .totals { margin-top: 20px; text-align: right; }
            .total-line { display: flex; justify-content: space-between; margin: 5px 0; }
            .final-total { font-weight: bold; border-top: 2px solid #000; padding-top: 5px; }
            @media print { .no-print { display: none; } }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Purchase Receipt</h1>
            <p>${ce.app_name}</p>
          </div>
          
          <div class="order-info">
            <h3>Order #${t.invoice||((h=t._id)==null?void 0:h.slice(-8))||"N/A"}</h3>
            <p><strong>Date:</strong> ${t.createdAt?O(new Date(t.createdAt),"MMM d, yyyy 'at' h:mm a"):"Date unknown"}</p>
            <p><strong>Status:</strong> ${A(t.status)}</p>
            <p><strong>Customer:</strong> ${((o=t.customer)==null?void 0:o.firstName)||""} ${((j=t.customer)==null?void 0:j.lastName)||""}</p>
            <p><strong>Email:</strong> ${((f=t.customer)==null?void 0:f.email)||""}</p>
            ${t.tracking_number?`<p><strong>Tracking:</strong> ${t.tracking_number}</p>`:""}
          </div>

          <table class="items-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              ${(t.items||[]).map(m=>{var b;return`
                <tr>
                  <td>${((b=m.productId)==null?void 0:b.name)||"Unknown Product"}</td>
                  <td>${m.quantity||0}</td>
                  <td>$${(m.price||0).toFixed(2)}</td>
                  <td>$${((m.quantity||0)*(m.price||0)).toFixed(2)}</td>
                </tr>
              `}).join("")}
            </tbody>
          </table>

          <div class="totals">
            <div class="total-line">
              <span>Subtotal:</span>
              <span>${n(s.subtotal)}</span>
            </div>
            ${s.serviceFee>0?`
              <div class="total-line">
                <span>Service Fee:</span>
                <span>${n(s.serviceFee)}</span>
              </div>
            `:""}
            ${s.tax>0?`
              <div class="total-line">
                <span>Tax:</span>
                <span>${n(s.tax)}</span>
              </div>
            `:""}
            ${s.shippingFee>0?`
              <div class="total-line">
                <span>Shipping:</span>
                <span>${n(s.shippingFee)}</span>
              </div>
            `:""}
            <div class="total-line final-total">
              <span>Total:</span>
              <span>${n(s.total)}</span>
            </div>
          </div>

          <div class="no-print" style="text-align: center; margin-top: 30px;">
            <button onclick="window.print()">Print Receipt</button>
            <button onclick="window.close()" style="margin-left: 10px;">Close</button>
          </div>
        </body>
      </html>
    `,r=window.open("","_blank","width=800,height=600");r?(r.document.write(l),r.document.close(),r.onload=()=>{r.print()}):M({title:"Print Blocked",description:"Unable to open print window. Please allow popups and try again.",variant:"destructive"})},he=t=>{ne(t),S(1)},ue=t=>{ie(t)},ge=t=>{S(t)},je=t=>{le(t),S(1)};return oe?e.jsxs("div",{className:"w-full p-4 sm:p-6 space-y-4 sm:space-y-6","data-testid":"page-purchases",children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between sm:items-center gap-4",children:e.jsxs("div",{children:[e.jsx("div",{className:"h-8 bg-muted rounded w-32 animate-pulse"}),e.jsx("div",{className:"h-4 bg-muted rounded w-48 mt-2 animate-pulse"})]})}),e.jsx("div",{className:"grid gap-4",children:[1,2,3].map(t=>e.jsx("div",{className:"h-32 bg-muted rounded animate-pulse"},t))})]}):me?e.jsx("div",{className:"w-full p-4 sm:p-6","data-testid":"page-purchases",children:e.jsxs(G,{className:"p-8 text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"Unable to load purchases"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:(C==null?void 0:C.message)||"There was an error loading your purchases. Please try again."}),e.jsx(v,{onClick:()=>pe(),"data-testid":"button-retry-purchases",children:"Try Again"})]})}):e.jsxs("div",{className:"w-full p-4 sm:p-6 space-y-4 sm:space-y-6","data-testid":"page-purchases",children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between sm:items-center gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground","data-testid":"text-page-title",children:"My Purchases"}),e.jsxs("p",{className:"text-sm text-muted-foreground","data-testid":"text-page-description",children:["Track your order history and purchase status (",T," purchases)"]})]})}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(ye,{placeholder:"Search purchases...",value:c,onChange:t=>w(t.target.value),className:"pl-10","data-testid":"input-search-purchases"})]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(K,{value:u,onValueChange:he,children:[e.jsx(W,{className:"w-[140px]","data-testid":"select-status-filter",children:e.jsx(X,{placeholder:"Status"})}),e.jsxs(Z,{children:[e.jsx(x,{value:"all",children:"All Status"}),e.jsx(x,{value:"processing",children:"Processing"}),e.jsx(x,{value:"shipped",children:"Shipped"}),e.jsx(x,{value:"delivered",children:"Delivered"}),e.jsx(x,{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs(K,{value:_,onValueChange:ue,children:[e.jsx(W,{className:"w-[140px]","data-testid":"select-sort",children:e.jsx(X,{placeholder:"Sort by"})}),e.jsxs(Z,{children:[e.jsx(x,{value:"total-high",children:"Total: High to Low"}),e.jsx(x,{value:"total-low",children:"Total: Low to High"}),e.jsx(x,{value:"status",children:"Status"})]})]})]})]}),e.jsx(G,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border bg-muted/50",children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Order"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Seller"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Items"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Price"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-border",children:$.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:7,className:"px-4 py-12 text-center",children:[e.jsx(I,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No purchases found"}),e.jsx("p",{className:"text-muted-foreground",children:c||u!=="all"?"Try adjusting your search or filters":"You haven't made any purchases yet"})]})}):$.map(t=>{var j,f,m,b,z,Y;const s=((m=(f=(j=t.items)==null?void 0:j[0])==null?void 0:f.productId)==null?void 0:m.name)||"N/A",l=t.invoice||t._id.slice(-8),r=`${((b=t.seller)==null?void 0:b.firstName)||""} ${((z=t.seller)==null?void 0:z.lastName)||""}`.trim()||"Unknown",d=((Y=t.items)==null?void 0:Y.length)||0,h=t.createdAt?new Date(t.createdAt):new Date,o=t.status||"processing";return e.jsxs("tr",{className:"hover:bg-muted/50 cursor-pointer transition-colors","data-testid":`row-purchase-${t._id}`,onClick:()=>L(t),children:[e.jsxs("td",{className:"px-4 py-4",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:s}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Order #",l]})]}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm text-muted-foreground",children:O(h,"dd MMM yyyy")}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm",children:e.jsx("span",{className:"text-foreground hover:text-primary",children:r})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm text-muted-foreground",children:d}),e.jsxs("td",{className:"px-4 py-4 whitespace-nowrap text-sm font-medium text-foreground",children:["US$",N(t).toFixed(2)]}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsx(J,{className:ae[o],children:A(o)})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-right text-sm",children:e.jsxs(ke,{children:[e.jsx(Se,{asChild:!0,onClick:fe=>fe.stopPropagation(),children:e.jsx(v,{variant:"ghost",size:"sm","data-testid":`button-actions-${t._id}`,children:e.jsx(Ae,{className:"h-4 w-4"})})}),e.jsxs(Pe,{align:"end",children:[e.jsxs(D,{onSelect:()=>L(t),children:[e.jsx(I,{className:"h-4 w-4 mr-2"}),"View Details"]}),e.jsxs(D,{onSelect:()=>U(t),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Print Receipt"]}),t.status==="shipped"&&e.jsxs(D,{onSelect:()=>B(t),children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Track Package"]})]})]})})]},t._id)})})]})})}),$.length>0&&e.jsx(Ie,{currentPage:k,totalPages:xe,totalItems:T,itemsPerPage:y,onPageChange:ge,onItemsPerPageChange:je,showingText:"purchases",className:"bg-white dark:bg-gray-950 rounded-lg border p-4"}),e.jsx(Ce,{open:de,onOpenChange:P,children:e.jsxs(Te,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx($e,{children:e.jsx(De,{children:"Order Details"})}),a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-lg mb-2","data-testid":"text-details-order-id",children:["Order #",a.invoice||((q=a._id)==null?void 0:q.slice(-8))||"N/A"]}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-1",children:[e.jsx("strong",{children:"Date:"})," ",a.createdAt?O(new Date(a.createdAt),"MMM d, yyyy 'at' h:mm a"):"Date unknown"]}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-1",children:[e.jsx("strong",{children:"Status:"}),e.jsx(J,{className:`ml-2 ${ae[a.status]}`,children:A(a.status)})]}),a.tracking_number&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx("strong",{children:"Tracking:"})," ",a.tracking_number]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Customer Information"}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-1",children:[e.jsx("strong",{children:"Name:"})," ",(R=a.customer)==null?void 0:R.firstName," ",(H=a.customer)==null?void 0:H.lastName]}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-1",children:[e.jsx("strong",{children:"Email:"})," ",(Q=a.customer)==null?void 0:Q.email]}),((V=a.customer)==null?void 0:V.address)&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Shipping Address:"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[a.customer.address.name,e.jsx("br",{}),a.customer.address.addrress1,e.jsx("br",{}),a.customer.address.city,", ",a.customer.address.state," ",a.customer.address.zipcode]})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Order Items"}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left p-3",children:"Product"}),e.jsx("th",{className:"text-center p-3",children:"Quantity"}),e.jsx("th",{className:"text-right p-3",children:"Price"}),e.jsx("th",{className:"text-right p-3",children:"Total"})]})}),e.jsx("tbody",{children:(a.items||[]).map((t,s)=>{var l,r,d,h,o;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[(l=t.productId)!=null&&l.images&&t.productId.images.length>0?e.jsx("img",{src:t.productId.images[0],alt:((r=t.productId)==null?void 0:r.name)||"Product",className:"w-12 h-12 rounded object-cover"}):e.jsx("div",{className:"w-12 h-12 bg-muted rounded flex items-center justify-center",children:e.jsx(I,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:((d=t.productId)==null?void 0:d.name)||"Unknown Product"}),((o=(h=t.productId)==null?void 0:h.category)==null?void 0:o.name)&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t.productId.category.name})]})]})}),e.jsx("td",{className:"p-3 text-center",children:t.quantity||0}),e.jsx("td",{className:"p-3 text-right",children:n(t.price||0)}),e.jsx("td",{className:"p-3 text-right font-medium",children:n((t.quantity||0)*(t.price||0))})]},s)})})]})})]}),e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Order Summary"}),(()=>{const t=ee(a);return e.jsxs("div",{className:"space-y-2 max-w-sm ml-auto",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal:"}),e.jsx("span",{children:n(t.subtotal)})]}),t.serviceFee>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Service Fee:"}),e.jsx("span",{children:n(t.serviceFee)})]}),t.tax>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Tax:"}),e.jsx("span",{children:n(t.tax)})]}),t.shippingFee>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Shipping:"}),e.jsx("span",{children:n(t.shippingFee)})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between font-semibold text-lg",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:n(t.total)})]})]})})()]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[a.status==="shipped"&&a.tracking_number&&e.jsxs(v,{variant:"outline",onClick:()=>B(a),children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Track Package"]}),e.jsxs(v,{variant:"outline",onClick:()=>U(a),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Print Receipt"]})]})]})]})})]})}export{it as default};
