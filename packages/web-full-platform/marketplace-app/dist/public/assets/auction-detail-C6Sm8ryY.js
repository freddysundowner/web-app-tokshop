const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/payment-shipping-alert-dialog-BU0vf8yY.js","assets/index-GnvmivW0.js","assets/index-B0C4fpEQ.css","assets/sheet-D5QVNRkq.js","assets/payment-shipping-sheet-C7qiIXfa.js","assets/package-DWwkENv3.js","assets/chevron-right-CXw-mF7y.js","assets/credit-card-B0WsppBV.js"])))=>i.map(i=>d[i]);
import{c as ge,p as Be,u as _e,a as Ie,b as Te,g as Le,aa as Fe,r as u,d as le,j as e,B as v,e as z,x as $e,q as ue,a9 as xe}from"./index-GnvmivW0.js";import{u as Me}from"./useMutation-DAKVWGzI.js";import{B as De}from"./badge-CL9MXKGS.js";import{A as qe,a as ze,b as Oe}from"./avatar-T6GBhCEI.js";import{C,b as P,a as me,c as he}from"./card-Bsqf9o7h.js";import{S as Re}from"./separator-Datc7ShZ.js";import{A as He}from"./arrow-left-CUbNyMTb.js";import{C as Ke}from"./chevron-left-BnuQCvWV.js";import{C as Ve}from"./chevron-right-CXw-mF7y.js";import{C as Ye}from"./clock-C8Dw1EBc.js";import{U as Qe}from"./user-CCcReMRJ.js";import{C as Je}from"./circle-alert-COJng_1I.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=ge("Hammer",[["path",{d:"m15 12-8.373 8.373a1 1 0 1 1-3-3L12 9",key:"eefl8a"}],["path",{d:"m18 15 4-4",key:"16gjal"}],["path",{d:"m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172V7l-2.26-2.26a6 6 0 0 0-4.202-1.756L9 2.96l.92.82A6.18 6.18 0 0 1 12 8.4V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5",key:"b7pghm"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=ge("ShieldCheck",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),Ge=u.lazy(()=>xe(()=>import("./payment-shipping-alert-dialog-BU0vf8yY.js"),__vite__mapDeps([0,1,2,3])).then(N=>({default:N.PaymentShippingAlertDialog}))),Xe=u.lazy(()=>xe(()=>import("./payment-shipping-sheet-C7qiIXfa.js"),__vite__mapDeps([4,1,2,3,5,6,7])).then(N=>({default:N.PaymentShippingSheet})));function mt(){var te,se,ie,ne,ae,oe;const[,N]=Be("/auction/:auctionId"),[,O]=_e(),{user:i,refreshUserData:fe}=Ie(),{settings:Ze}=Te(),{toast:x}=Le(),{socket:l,isConnected:E,connect:be,disconnect:je}=Fe(),[R,T]=u.useState(0),[B,h]=u.useState(0),[_,w]=u.useState(!1),m=N==null?void 0:N.auctionId,y=(i==null?void 0:i._id)||(i==null?void 0:i.id),L=(i==null?void 0:i.userName)||(i==null?void 0:i.firstName)||"Guest",S=u.useRef(null),[H,F]=u.useState(!1),[K,V]=u.useState(!1);console.log("ðŸ” STEP 1: Product ID from URL params:",m);const{data:n,isLoading:Y,refetch:Ne}=le({queryKey:["/api/products",m],enabled:!!m});console.log("ðŸ” STEP 2: Product fetch result:",{isLoading:Y,hasProduct:!!n,productKeys:n?Object.keys(n):[]}),n&&(console.log("ðŸ” STEP 3: Product data structure:",{productId:n._id,productName:n.name,hasAuction:!!n.auction,auctionKeys:n.auction?Object.keys(n.auction):[],auctionId:(te=n.auction)==null?void 0:te._id,bidsCount:((ie=(se=n.auction)==null?void 0:se.bids)==null?void 0:ie.length)||0}),console.log("ðŸ” STEP 4: Full auction object:",n.auction),console.log("ðŸ” STEP 5: Bids array:",(ne=n.auction)==null?void 0:ne.bids));const s=n,{data:f,isLoading:Q}=le({queryKey:["/api/shipping/estimate",m],queryFn:async()=>{var t,o;if(!n)return console.log("ðŸ“¦ Shipping estimate: No product data yet"),null;try{console.log("ðŸ“¦ Fetching shipping estimate for product:",{productId:m,weight:n.weight,unit:n.unit,ownerId:n.ownerId});const a=await fetch("/api/shipping/estimate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({weight:n.weight||1,unit:n.unit||"oz",product:m,owner:((t=n.ownerId)==null?void 0:t._id)||n.ownerId,tokshow:((o=n.tokshow)==null?void 0:o._id)||n.tokshow||null,buying_label:!1,customer:(i==null?void 0:i._id)||(i==null?void 0:i.id)||null})});if(console.log("ðŸ“¦ Shipping estimate response status:",a.status),!a.ok)return console.log("ðŸ“¦ Shipping estimate failed with status:",a.status),null;const d=await a.json();return console.log("ðŸ“¦ Shipping estimate data:",d),d}catch(a){return console.error("ðŸ“¦ Failed to fetch shipping estimate:",a),null}},enabled:!!n&&!!m});console.log("ðŸ“¦ Shipping estimate state:",{isLoadingShipping:Q,hasEstimate:!!f,estimateData:f}),u.useEffect(()=>{if(!l){console.log("ðŸ“± Waiting for socket to initialize...");return}return console.log("ðŸ“± Socket ready - connecting..."),be(),()=>{console.log("ðŸ“± Auction detail page unmounting - disconnecting socket..."),je()}},[l]),u.useEffect(()=>{if(n&&!S.current){const o=(n.auction||n)._id||m;S.current=o,console.log("ðŸ“‹ Stored auction ID:",o)}},[n,m]),u.useEffect(()=>{if(!l||!E||!S.current||!y)return;const t=S.current;console.log("ðŸ“¤ Joining scheduled auction:",{auctionId:t,userId:y,userName:L,socketConnected:E}),l.emit("join-scheduled-auction",{auction:t,userId:y,userName:L}),console.log("âœ… Joined scheduled auction room:",t);const o=c=>{console.log("ðŸ” BID-UPDATED received on auction detail page:",c),ue.invalidateQueries({queryKey:["/api/products",m]})},a=c=>{console.log("ðŸ AUCTION-ENDED received:",c),ue.invalidateQueries({queryKey:["/api/products",m]}),x({title:"Auction Ended",description:"This auction has concluded."})},d=c=>{console.log("ðŸŽ‰ SCHEDULED-AUCTION-CREATED received:",c),Ne().then(()=>{var j;(j=c.auction)!=null&&j._id&&(S.current=c.auction._id)}),x({title:"New Auction Available",description:"A new auction has been scheduled for this product."})};return l.on("bid-updated",o),l.on("auction-ended",a),l.on("scheduled-auction-created",d),()=>{l.off("bid-updated",o),l.off("auction-ended",a),l.off("scheduled-auction-created",d),console.log("ðŸ“¤ Leaving scheduled auction:",t),l.emit("leave-scheduled-auction",{auction:t,userId:y})}},[l,E,m,y,L,x]),u.useEffect(()=>{if(!s){h(0),w(!1);return}const t=()=>{const a=Date.now(),d=s.auction,c=d==null?void 0:d.start_time_date,j=d==null?void 0:d.end_time_date,I=c&&c>0?c:null,re=j&&j>0?j:null;if(I&&re){const D=I,ce=re;if(a<D){const q=Math.floor((D-a)/1e3);w(!0),h(q);return}if(a>=D&&a<ce){const q=Math.floor((ce-a)/1e3);w(!1),h(q);return}w(!1),h(0);return}if(s.ended){w(!1),h(0);return}const M=s.duration||0,A=s.startedTime||s.started_time;if(!(s.started||!1)||!A||A===0){h(M*60);return}if(!M){h(0);return}const de=typeof A=="string"?new Date(A).getTime():A;if(isNaN(de)){h(0);return}const Pe=de+M*60*1e3,Ee=Math.max(0,Math.floor((Pe-a)/1e3));h(Ee)};t();const o=setInterval(t,1e3);return()=>clearInterval(o)},[s]);const ye=t=>{if(t===0)return"Auction Ended";const o=Math.floor(t/86400),a=Math.floor(t%86400/3600),d=Math.floor(t%3600/60),c=t%60;return o>0?`${o}d ${a}h ${d}m`:a>0?`${a}h ${d}m ${c}s`:d>0?`${d}m ${c}s`:`${c}s`},r=(s==null?void 0:s.auction)||{},p=(r==null?void 0:r.bids)||[],ve=p.reduce((t,o)=>Math.max(t,Number(o.amount)||0),0),J=Number(ve||(r==null?void 0:r.newbaseprice)||(r==null?void 0:r.baseprice)||0);r!=null&&r.newbaseprice||r!=null&&r.baseprice;const W=(r==null?void 0:r.increaseBidBy)||5,G=p.find(t=>{var a;return(((a=t.user)==null?void 0:a._id)||t.userId)===(i==null?void 0:i.id)}),X=G?Number(G.amount):null,we=p.length>0&&((ae=p[p.length-1])==null?void 0:ae.userId)===(i==null?void 0:i.id),k=B===0||(s==null?void 0:s.ended),Se=()=>{if(!i)return!1;const t=i;return!!(t.address&&t.defaultpaymentmethod)},$=Me({mutationFn:async t=>{if(!i)throw new Error("Please sign in to place a bid");if(!Se())throw F(!0),new Error("Please add payment and shipping information before bidding");if(!l||!E)throw new Error("Not connected to server. Please try again.");const o=s.auction||s,a=o._id||s._id;return console.log("ðŸ“¤ Placing bid via socket:",{user:y,amount:t,auction:a,increaseBidBy:o.increaseBidBy||W}),new Promise((d,c)=>{const j=setTimeout(()=>{c(new Error("Bid request timed out"))},1e4),I=()=>{clearTimeout(j),console.log("âœ… Bid confirmed by server"),d(!0)};l.once("bid-updated",I),l.emit("place-bid",{user:y,amount:t,increaseBidBy:o.increaseBidBy||W,auction:a,prebid:!1,autobid:!1,autobidamount:t,roomId:a,type:"scheduled"}),console.log("âœ… Bid socket event emitted, waiting for confirmation...")})},onSuccess:()=>{x({title:"Bid placed!",description:"Your bid has been placed successfully."})},onError:t=>{x({title:"Bid failed",description:t.message||"Failed to place bid. Please try again.",variant:"destructive"})}}),ke=()=>{if(!i){x({title:"Sign in required",description:"Please sign in to place a bid.",variant:"destructive"});return}if(_){x({title:"Auction not started",description:"This auction hasn't started yet. Please wait.",variant:"destructive"});return}if(k){x({title:"Auction ended",description:"This auction has already ended.",variant:"destructive"});return}const t=(r==null?void 0:r.newbaseprice)||(s==null?void 0:s.default_startprice)||0;$.mutate(t)};if(Y)return e.jsx("div",{className:"min-h-screen bg-background p-4",children:e.jsx("div",{className:"max-w-6xl mx-auto",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-96 bg-muted rounded-lg"}),e.jsx("div",{className:"h-64 bg-muted rounded-lg"})]})})});if(!s)return e.jsx("div",{className:"min-h-screen bg-background p-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto text-center py-12",children:[e.jsx("p",{className:"text-muted-foreground",children:"Auction not found"}),e.jsx(v,{onClick:()=>O("/"),className:"mt-4",children:"Go Home"})]})});const b=s.images||s.productImages||[],g=typeof s.ownerId=="object"?s.ownerId:null,Z=((oe=s.ownerId)==null?void 0:oe._id)||s.ownerId,U=(g==null?void 0:g.userName)||(g==null?void 0:g.firstName)||"Seller",Ae=g==null?void 0:g.profilePhoto,ee=B>0&&B<=300,Ce=(i==null?void 0:i.id)===Z;return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"sticky top-0 z-10 bg-background border-b border-border p-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto flex items-center gap-4",children:[e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>window.history.back(),"data-testid":"button-back",children:e.jsx(He,{className:"h-5 w-5"})}),e.jsx("h1",{className:"font-semibold truncate flex-1",children:s.name||"Auction"})]})}),e.jsx("div",{className:"max-w-6xl mx-auto p-4 md:p-6",children:e.jsxs("div",{className:"grid md:grid-cols-5 gap-6",children:[e.jsxs("div",{className:"md:col-span-2 space-y-6",children:[e.jsx(C,{children:e.jsxs(P,{className:"p-4",children:[e.jsx("div",{className:"relative aspect-square bg-muted rounded-lg overflow-hidden",children:b.length>0?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:b[R],alt:s.name,className:"absolute inset-0 w-full h-full object-cover"}),b.length>1&&e.jsxs(e.Fragment,{children:[e.jsx(v,{variant:"ghost",size:"icon",className:"absolute left-2 top-1/2 -translate-y-1/2 bg-background/80 hover:bg-background",onClick:()=>T(t=>(t-1+b.length)%b.length),"data-testid":"button-prev-image",children:e.jsx(Ke,{className:"h-5 w-5"})}),e.jsx(v,{variant:"ghost",size:"icon",className:"absolute right-2 top-1/2 -translate-y-1/2 bg-background/80 hover:bg-background",onClick:()=>T(t=>(t+1)%b.length),"data-testid":"button-next-image",children:e.jsx(Ve,{className:"h-5 w-5"})})]})]}):e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(pe,{className:"h-24 w-24 text-muted-foreground/20"})})}),b.length>1&&e.jsx("div",{className:"flex gap-2 mt-4 overflow-x-auto",children:b.map((t,o)=>e.jsx("button",{onClick:()=>T(o),className:z("flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 transition-colors",R===o?"border-primary":"border-border hover:border-primary/50"),"data-testid":`thumbnail-${o}`,children:e.jsx("img",{src:t,alt:"",className:"w-full h-full object-cover"})},o))})]})}),e.jsxs(C,{children:[e.jsx(me,{children:e.jsx(he,{children:"Item Description"})}),e.jsxs(P,{className:"space-y-4",children:[s.description&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Description"}),e.jsx("p",{className:"text-muted-foreground",children:s.description})]}),s.category&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Category"}),e.jsx(De,{variant:"outline",children:s.category.name||s.category})]})]})]})]}),e.jsxs("div",{className:"md:col-span-3 space-y-6",children:[e.jsx(C,{children:e.jsxs(P,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:z("p-4 rounded-lg border-2",k?"border-muted bg-muted/50":_?"border-primary bg-primary/10":ee?"border-destructive bg-destructive/10 animate-pulse":"border-primary bg-primary/10"),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ye,{className:"h-5 w-5"}),e.jsx("span",{className:"font-semibold",children:_?"Starts in":"Time Remaining"})]}),e.jsx("p",{className:z("text-2xl font-bold",k?"text-muted-foreground":ee?"text-destructive":"text-primary"),children:ye(B)})]}),e.jsx(Re,{}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Current Bid"}),e.jsxs("p",{className:"text-3xl font-bold text-primary","data-testid":"current-bid",children:["$",J.toFixed(2),!Q&&(f==null?void 0:f.amount)&&e.jsxs("span",{className:"text-sm text-muted-foreground font-normal",children:[" ","+ $",(typeof f.amount=="string"?parseFloat(f.amount):f.amount).toFixed(2)," shipping + taxes"]})]}),p.length>0&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[p.length," ",p.length===1?"bid":"bids"]})]}),we&&!k&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-primary/10 rounded-lg border border-primary",children:[e.jsx(We,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold text-primary",children:"You're winning!"})]}),k?e.jsxs("div",{className:"p-4 bg-muted rounded-lg text-center",children:[e.jsx("p",{className:"font-semibold mb-2",children:"Auction Ended"}),p.length>0?e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Winning bid: $",J.toFixed(2)]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No bids placed"})]}):_?e.jsxs("div",{className:"p-4 bg-muted rounded-lg text-center",children:[e.jsx("p",{className:"font-semibold mb-2",children:"Auction Not Started"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Bidding will open when the auction starts"})]}):Ce?e.jsxs("div",{className:"p-4 bg-muted rounded-lg text-center",children:[e.jsx("p",{className:"font-semibold mb-2",children:"Your Auction"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"You cannot bid on your own auction"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx(v,{onClick:ke,className:"w-full",size:"lg",disabled:$.isPending,"data-testid":"button-quick-bid",children:$.isPending?e.jsx($e,{className:"h-5 w-5 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-5 w-5 mr-2"}),"Place Bid - $",((r==null?void 0:r.newbaseprice)||(s==null?void 0:s.default_startprice)||0).toFixed(2)]})}),X!==null&&e.jsxs("p",{className:"text-xs text-muted-foreground text-center","data-testid":"text-user-bid",children:["Your bid: $",X.toFixed(2)]})]})]})}),e.jsxs(C,{children:[e.jsx(me,{children:e.jsx(he,{children:"Seller Information"})}),e.jsxs(P,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(qe,{className:"h-12 w-12",children:[e.jsx(ze,{src:Ae}),e.jsx(Oe,{children:U[0].toUpperCase()})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold",children:U}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Seller"})]})]}),e.jsxs(v,{variant:"outline",className:"w-full",onClick:()=>O(`/profile/${Z}`),"data-testid":"button-view-seller",children:[e.jsx(Qe,{className:"h-4 w-4 mr-2"}),"View Seller Profile"]})]})]}),e.jsx(C,{children:e.jsx(P,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Je,{className:"h-5 w-5 mt-0.5 text-primary flex-shrink-0"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("p",{children:"By bidding, you agree to buy this item if you win."}),e.jsx("p",{children:"All bids are binding and cannot be retracted."})]})]})})})]})]})}),H&&e.jsx(u.Suspense,{fallback:e.jsx("div",{}),children:e.jsx(Ge,{open:H,onOpenChange:F,onAddInfo:()=>{F(!1),V(!0)}})}),K&&e.jsx(u.Suspense,{fallback:e.jsx("div",{}),children:e.jsx(Xe,{open:K,onOpenChange:t=>{V(t),t||fe()}})})]})}export{mt as default};
