import{R as d,b as Pe,r as $,j as u,e as ke,a as Oe,k as Q}from"./index-sx6K5zvX.js";import{D as Re,a as Ae,b as Ne,c as _e,d as Le,e as se}from"./dialog-lan0uYA-.js";import{B as V}from"./button-BhKWRVKT.js";import{P as l}from"./index-x7xp_GjN.js";var ie="clover",Ie=function(e){return e===3?"v3":e},ce="https://js.stripe.com",Te="".concat(ce,"/").concat(ie,"/stripe.js"),Ue=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,De=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/;var Me=function(e){return Ue.test(e)||De.test(e)},We=function(){for(var e=document.querySelectorAll('script[src^="'.concat(ce,'"]')),t=0;t<e.length;t++){var n=e[t];if(Me(n.src))return n}return null},Z=function(e){var t="",n=document.createElement("script");n.src="".concat(Te).concat(t);var o=document.head||document.body;if(!o)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return o.appendChild(n),n},qe=function(e,t){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"8.2.0",startTime:t})},A=null,M=null,W=null,Be=function(e){return function(t){e(new Error("Failed to load Stripe.js",{cause:t}))}},Fe=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},Je=function(e){return A!==null?A:(A=new Promise(function(t,n){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe){t(window.Stripe);return}try{var o=We();if(!(o&&e)){if(!o)o=Z(e);else if(o&&W!==null&&M!==null){var a;o.removeEventListener("load",W),o.removeEventListener("error",M),(a=o.parentNode)===null||a===void 0||a.removeChild(o),o=Z(e)}}W=Fe(t,n),M=Be(n),o.addEventListener("load",W),o.addEventListener("error",M)}catch(c){n(c);return}}),A.catch(function(t){return A=null,Promise.reject(t)}))},$e=function(e,t,n){if(e===null)return null;var o=t[0],a=o.match(/^pk_test/),c=Ie(e.version),p=ie;a&&c!==p&&console.warn("Stripe.js@".concat(c," was loaded on the page, but @stripe/stripe-js@").concat("8.2.0"," expected Stripe.js@").concat(p,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var s=e.apply(void 0,t);return qe(s,n),s},N,ue=!1,le=function(){return N||(N=Je(null).catch(function(e){return N=null,Promise.reject(e)}),N)};Promise.resolve().then(function(){return le()}).catch(function(r){ue||console.warn(r)});var Ve=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];ue=!0;var o=Date.now();return le().then(function(a){return $e(a,t,o)})};function ee(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(o){return Object.getOwnPropertyDescriptor(r,o).enumerable})),t.push.apply(t,n)}return t}function te(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ee(Object(t),!0).forEach(function(n){de(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ee(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function q(r){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?q=function(e){return typeof e}:q=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},q(r)}function de(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function Ye(r,e){if(r==null)return{};var t={},n=Object.keys(r),o,a;for(a=0;a<n.length;a++)o=n[a],!(e.indexOf(o)>=0)&&(t[o]=r[o]);return t}function ze(r,e){if(r==null)return{};var t=Ye(r,e),n,o;if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(r);for(o=0;o<a.length;o++)n=a[o],!(e.indexOf(n)>=0)&&Object.prototype.propertyIsEnumerable.call(r,n)&&(t[n]=r[n])}return t}function pe(r,e){return Ge(r)||Ke(r,e)||Xe(r,e)||He()}function Ge(r){if(Array.isArray(r))return r}function Ke(r,e){var t=r&&(typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"]);if(t!=null){var n=[],o=!0,a=!1,c,p;try{for(t=t.call(r);!(o=(c=t.next()).done)&&(n.push(c.value),!(e&&n.length===e));o=!0);}catch(s){a=!0,p=s}finally{try{!o&&t.return!=null&&t.return()}finally{if(a)throw p}}return n}}function Xe(r,e){if(r){if(typeof r=="string")return re(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return re(r,e)}}function re(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function He(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var h=function(e,t,n){var o=!!n,a=d.useRef(n);d.useEffect(function(){a.current=n},[n]),d.useEffect(function(){if(!o||!e)return function(){};var c=function(){a.current&&a.current.apply(a,arguments)};return e.on(t,c),function(){e.off(t,c)}},[o,t,e,a])},Y=function(e){var t=d.useRef(e);return d.useEffect(function(){t.current=e},[e]),t.current},R=function(e){return e!==null&&q(e)==="object"},Qe=function(e){return R(e)&&typeof e.then=="function"},Ze=function(e){return R(e)&&typeof e.elements=="function"&&typeof e.createToken=="function"&&typeof e.createPaymentMethod=="function"&&typeof e.confirmCardPayment=="function"},ne="[object Object]",et=function r(e,t){if(!R(e)||!R(t))return e===t;var n=Array.isArray(e),o=Array.isArray(t);if(n!==o)return!1;var a=Object.prototype.toString.call(e)===ne,c=Object.prototype.toString.call(t)===ne;if(a!==c)return!1;if(!a&&!n)return e===t;var p=Object.keys(e),s=Object.keys(t);if(p.length!==s.length)return!1;for(var x={},y=0;y<p.length;y+=1)x[p[y]]=!0;for(var S=0;S<s.length;S+=1)x[s[S]]=!0;var i=Object.keys(x);if(i.length!==p.length)return!1;var v=e,E=t,C=function(k){return r(v[k],E[k])};return i.every(C)},fe=function(e,t,n){return R(e)?Object.keys(e).reduce(function(o,a){var c=!R(t)||!et(e[a],t[a]);return n.includes(a)?(c&&console.warn("Unsupported prop change: options.".concat(a," is not a mutable property.")),o):c?te(te({},o||{}),{},de({},a,e[a])):o},null):null},me="Invalid prop `stripe` supplied to `Elements`. We recommend using the `loadStripe` utility from `@stripe/stripe-js`. See https://stripe.com/docs/stripe-js/react#elements-props-stripe for details.",oe=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:me;if(e===null||Ze(e))return e;throw new Error(t)},tt=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:me;if(Qe(e))return{tag:"async",stripePromise:Promise.resolve(e).then(function(o){return oe(o,t)})};var n=oe(e,t);return n===null?{tag:"empty"}:{tag:"sync",stripe:n}},rt=function(e){!e||!e._registerWrapper||!e.registerAppInfo||(e._registerWrapper({name:"react-stripe-js",version:"5.3.0"}),e.registerAppInfo({name:"react-stripe-js",version:"5.3.0",url:"https://stripe.com/docs/stripe-js/react"}))},B=d.createContext(null);B.displayName="ElementsContext";var ve=function(e,t){if(!e)throw new Error("Could not find Elements context; You need to wrap the part of your app that ".concat(t," in an <Elements> provider."));return e},he=function(e){var t=e.stripe,n=e.options,o=e.children,a=d.useMemo(function(){return tt(t)},[t]),c=d.useState(function(){return{stripe:a.tag==="sync"?a.stripe:null,elements:a.tag==="sync"?a.stripe.elements(n):null}}),p=pe(c,2),s=p[0],x=p[1];d.useEffect(function(){var i=!0,v=function(C){x(function(P){return P.stripe?P:{stripe:C,elements:C.elements(n)}})};return a.tag==="async"&&!s.stripe?a.stripePromise.then(function(E){E&&i&&v(E)}):a.tag==="sync"&&!s.stripe&&v(a.stripe),function(){i=!1}},[a,s,n]);var y=Y(t);d.useEffect(function(){y!==null&&y!==t&&console.warn("Unsupported prop change on Elements: You cannot change the `stripe` prop after setting it.")},[y,t]);var S=Y(n);return d.useEffect(function(){if(s.elements){var i=fe(n,S,["clientSecret","fonts"]);i&&s.elements.update(i)}},[n,S,s.elements]),d.useEffect(function(){rt(s.stripe)},[s.stripe]),d.createElement(B.Provider,{value:s},o)};he.propTypes={stripe:l.any,options:l.object};var nt=function(e){var t=d.useContext(B);return ve(t,e)},ot=function(){var e=nt("calls useElements()"),t=e.elements;return t};l.func.isRequired;var ye=d.createContext(null);ye.displayName="CheckoutContext";l.any,l.shape({clientSecret:l.oneOfType([l.string,l.instanceOf(Promise)]).isRequired,elementsOptions:l.object}).isRequired;var z=function(e){var t=d.useContext(ye),n=d.useContext(B);if(t){if(n)throw new Error("You cannot wrap the part of your app that ".concat(e," in both <CheckoutProvider> and <Elements> providers."));return t}else return ve(n,e)},at=["mode"],st=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},g=function(e,t){var n="".concat(st(e),"Element"),o=function(s){var x=s.id,y=s.className,S=s.options,i=S===void 0?{}:S,v=s.onBlur,E=s.onFocus,C=s.onReady,P=s.onChange,k=s.onEscape,_=s.onClick,L=s.onLoadError,I=s.onLoaderStart,T=s.onNetworksChange,ge=s.onConfirm,be=s.onCancel,Se=s.onShippingAddressChange,Ee=s.onShippingRateChange,xe=s.onSavedPaymentMethodRemove,Ce=s.onSavedPaymentMethodUpdate,U=z("mounts <".concat(n,">")),D="elements"in U?U.elements:null,O="checkoutState"in U?U.checkoutState:null,j=(O==null?void 0:O.type)==="success"||(O==null?void 0:O.type)==="loading"?O.sdk:null,je=d.useState(null),G=pe(je,2),f=G[0],we=G[1],w=d.useRef(null),F=d.useRef(null);h(f,"blur",v),h(f,"focus",E),h(f,"escape",k),h(f,"click",_),h(f,"loaderror",L),h(f,"loaderstart",I),h(f,"networkschange",T),h(f,"confirm",ge),h(f,"cancel",be),h(f,"shippingaddresschange",Se),h(f,"shippingratechange",Ee),h(f,"savedpaymentmethodremove",xe),h(f,"savedpaymentmethodupdate",Ce),h(f,"change",P);var J;C&&(e==="expressCheckout"?J=C:J=function(){C(f)}),h(f,"ready",J),d.useLayoutEffect(function(){if(w.current===null&&F.current!==null&&(D||j)){var m=null;if(j)switch(e){case"payment":m=j.createPaymentElement(i);break;case"address":if("mode"in i){var X=i.mode,H=ze(i,at);if(X==="shipping")m=j.createShippingAddressElement(H);else if(X==="billing")m=j.createBillingAddressElement(H);else throw new Error("Invalid options.mode. mode must be 'billing' or 'shipping'.")}else throw new Error("You must supply options.mode. mode must be 'billing' or 'shipping'.");break;case"expressCheckout":m=j.createExpressCheckoutElement(i);break;case"currencySelector":m=j.createCurrencySelectorElement();break;case"taxId":m=j.createTaxIdElement(i);break;default:throw new Error("Invalid Element type ".concat(n,". You must use either the <PaymentElement />, <AddressElement options={{mode: 'shipping'}} />, <AddressElement options={{mode: 'billing'}} />, or <ExpressCheckoutElement />."))}else D&&(m=D.create(e,i));w.current=m,we(m),m&&m.mount(F.current)}},[D,j,i]);var K=Y(i);return d.useEffect(function(){if(w.current){var m=fe(i,K,["paymentRequest"]);m&&"update"in w.current&&w.current.update(m)}},[i,K]),d.useLayoutEffect(function(){return function(){if(w.current&&typeof w.current.destroy=="function")try{w.current.destroy(),w.current=null}catch{}}},[]),d.createElement("div",{id:x,className:y,ref:F})},a=function(s){z("mounts <".concat(n,">"));var x=s.id,y=s.className;return d.createElement("div",{id:x,className:y})},c=t?a:o;return c.propTypes={id:l.string,className:l.string,onChange:l.func,onBlur:l.func,onFocus:l.func,onReady:l.func,onEscape:l.func,onClick:l.func,onLoadError:l.func,onLoaderStart:l.func,onNetworksChange:l.func,onConfirm:l.func,onCancel:l.func,onShippingAddressChange:l.func,onShippingRateChange:l.func,onSavedPaymentMethodRemove:l.func,onSavedPaymentMethodUpdate:l.func,options:l.object},c.displayName=n,c.__elementType=e,c},b=typeof window>"u",it=d.createContext(null);it.displayName="EmbeddedCheckoutProviderContext";var ct=function(){var e=z("calls useStripe()"),t=e.stripe;return t};g("auBankAccount",b);var ae=g("card",b);g("cardNumber",b);g("cardExpiry",b);g("cardCvc",b);g("iban",b);g("payment",b);g("expressCheckout",b);g("paymentRequestButton",b);g("linkAuthentication",b);g("address",b);g("shippingAddress",b);g("paymentMethodMessaging",b);g("taxId",b);function ut({onSuccess:r,onClose:e}){const t=ct(),n=ot(),{toast:o}=ke(),{user:a}=Oe(),[c,p]=$.useState(!1),s=async x=>{var S;if(x.preventDefault(),!t||!n||!a)return;const y=n.getElement(ae);if(y){p(!0);try{const i=a,v=i.email;if(!v)throw new Error("User email not found. Please contact support.");const C=await(await Q("POST","/stripe/setupitent",{email:v})).json(),{clientSecret:P,customer_id:k}=C;if(!P)throw new Error("Failed to initialize payment setup. Please try again.");if(!k)throw new Error("Customer ID not found. Please contact support.");const{error:_,setupIntent:L}=await t.confirmCardSetup(P,{payment_method:{card:y}});if(_)throw new Error(_.message);if(!L||!L.payment_method)throw new Error("Failed to set up payment method");const I=(S=i.defaultpaymentmethod)==null?void 0:S._id,T={customer_id:k,userid:i.id||i._id};I&&(T.methodid=I),await Q("POST","/stripe/savepaymentmethod",T),o({title:"Card Added",description:"Your payment method has been saved successfully."}),r&&r(),e()}catch(i){console.error("Failed to add payment method:",i);let v="Failed to add payment method. Please try again.";if(i!=null&&i.text)try{const E=JSON.parse(i.text);v=E.error||E.message||v}catch{typeof i.text=="string"&&(v=i.text)}else i!=null&&i.message&&(v=i.message);o({title:"Error",description:v,variant:"destructive"})}finally{p(!1)}}};return u.jsxs("form",{onSubmit:s,children:[u.jsx("div",{className:"space-y-4 py-4",children:u.jsxs("div",{className:"space-y-2",children:[u.jsx("label",{className:"text-sm font-medium leading-none",children:"Card Details"}),u.jsx("div",{className:"border rounded-md p-3 bg-background",children:u.jsx(ae,{options:{style:{base:{fontSize:"16px",color:"hsl(var(--foreground))","::placeholder":{color:"hsl(var(--muted-foreground))"}},invalid:{color:"hsl(var(--destructive))"}}}})})]})}),u.jsxs(se,{className:"flex-col sm:flex-row gap-2",children:[u.jsx(V,{type:"button",variant:"outline",onClick:e,disabled:c,"data-testid":"button-cancel",className:"w-full sm:w-auto",children:"Cancel"}),u.jsx(V,{type:"submit",disabled:!t||c,"data-testid":"button-add-card",className:"w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-black",children:c?"Adding...":"Add Card"})]})]})}function mt({open:r,onOpenChange:e,onSuccess:t}){const{settings:n}=Pe(),[o,a]=$.useState(null);$.useEffect(()=>{n.stripe_publishable_key&&a(Ve(n.stripe_publishable_key))},[n.stripe_publishable_key]);const c={mode:"setup",currency:"usd",appearance:{theme:"stripe"}},p=n.stripe_publishable_key&&n.stripe_publishable_key.trim().length>0;return u.jsx(Re,{open:r,onOpenChange:e,children:u.jsxs(Ae,{className:"sm:max-w-md","data-testid":"dialog-add-payment",children:[u.jsxs(Ne,{children:[u.jsx(_e,{children:"Add Payment Method"}),u.jsx(Le,{children:"Enter your card details to add a new payment method."})]}),p?o?u.jsx(he,{stripe:o,options:c,children:u.jsx(ut,{onSuccess:t,onClose:()=>e(!1)})}):u.jsx("div",{className:"py-8 text-center text-muted-foreground",children:"Loading payment form..."}):u.jsxs("div",{className:"py-8 px-4 space-y-4",children:[u.jsxs("div",{className:"text-center",children:[u.jsx("div",{className:"w-12 h-12 rounded-full bg-destructive/10 flex items-center justify-center mx-auto mb-4",children:u.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-destructive",children:[u.jsx("circle",{cx:"12",cy:"12",r:"10"}),u.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),u.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})}),u.jsx("h3",{className:"font-semibold text-foreground mb-2",children:"Payment System Not Configured"}),u.jsx("p",{className:"text-sm text-muted-foreground",children:"Stripe payment processing is not configured. Please contact the administrator to set up payment processing."})]}),u.jsx(se,{children:u.jsx(V,{type:"button",variant:"outline",onClick:()=>e(!1),"data-testid":"button-close",className:"w-full",children:"Close"})})]})]})})}export{mt as A};
