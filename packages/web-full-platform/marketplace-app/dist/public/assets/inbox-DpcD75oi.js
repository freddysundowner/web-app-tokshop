import{a as ze,p as Ye,u as He,r,g as Qe,j as e,e as m,B,L as ae,x as re,A as ie,h as ne,i as oe,k as le,l as ce,m as de,n as ue,o as me,aH as Ke,aI as he,aL as Ve,aO as qe,aQ as We,aS as _e,aP as Ge}from"./index-GnvmivW0.js";import{I as fe}from"./input-CDJz7BeV.js";import{A as xe,a as ge,b as pe}from"./avatar-T6GBhCEI.js";import{B as Je}from"./badge-CL9MXKGS.js";import{S as je}from"./scroll-area-FQ9vYp1R.js";import{D as Xe,a as Ze,b as es,c as be}from"./dropdown-menu-B2qYf86A.js";import{D as ss,a as ts,b as as,c as rs}from"./dialog-D1L4tMGI.js";import{b as is,c as ns,m as os,d as ls,e as cs,f as ds,u as Ne,h as E,g as us,i as ve,j as ms,k as hs,l as fs,n as xs}from"./firebase-chat-DdFjaliD.js";import{S as ye}from"./search-DE1AZ4db.js";import{A as gs}from"./arrow-left-CUbNyMTb.js";import{E as ps}from"./ellipsis-vertical-CJSSwQPi.js";import{S as js}from"./shield-TxVeUbf2.js";import{B as H}from"./ban-C4WTfSqp.js";import{I as bs}from"./image-Hw4wFcaj.js";import{S as Ns}from"./send-BnGR3x8s.js";import"./index-CmYyiKyk.js";import"./index-BdQq_4o_.js";import"./index-kVvGtud3.js";import"./chevron-right-CXw-mF7y.js";import"./check-DoxmrmEj.js";import"./circle-iUglX5Df.js";function Ys(){const{user:i}=ze(),[,p]=Ye("/inbox/:chatId?"),[,w]=He(),[n,P]=r.useState(null),[j,Q]=r.useState(""),[K,we]=r.useState(""),[V,T]=r.useState(!1),[d,ke]=r.useState([]),[Ue,q]=r.useState([]),[Ie,A]=r.useState(!0),[k,W]=r.useState(!1),[U,_]=r.useState(!1),I=r.useRef(null),G=r.useRef(null),[O,L]=r.useState(!1),[M,Se]=r.useState(!1),[Ce,F]=r.useState(!1),[De,S]=r.useState(!1),[b,C]=r.useState(!1),[J,Be]=r.useState(!1),[R,Ee]=r.useState(!1),[X,Pe]=r.useState(""),[$,Z]=r.useState(null),{toast:u}=Qe(),t=(i==null?void 0:i._id)||(i==null?void 0:i.id)||"",h=(i==null?void 0:i.userName)||(i==null?void 0:i.firstName)||"User",f=(i==null?void 0:i.profilePhoto)||"";r.useEffect(()=>{if(!t)return;(async()=>{try{const a=Ke(he(),"chats"),l=Ve(a,qe("userIds","array-contains",t)),Y=(await We(l)).docs.map(async N=>{try{const te=N.data().users||[];let g=!1;const $e=te.map(v=>{if(v.id===t){const D={...v};return f&&v.profilePhoto!==f&&(D.profilePhoto=f,g=!0),!v.userName&&h&&h!=="User"&&(D.userName=h,g=!0),!v.firstName&&(i!=null&&i.firstName)&&(D.firstName=i.firstName,g=!0),D}return v});g&&(await _e(Ge(he(),"chats",N.id),{users:$e}),console.log("Updated user data in chat:",N.id))}catch(x){console.error("Error updating chat:",N.id,x)}});await Promise.all(Y)}catch(a){console.error("Error updating user profile in chats:",a)}})()},[t,f,h,i]),r.useEffect(()=>{if(!t){A(!1);return}const s=is(t,a=>{ke(a),A(!1)},a=>{console.error("Error loading chats:",a),A(!1)});return()=>s()},[t]),r.useEffect(()=>{if(!n){q([]);return}const s=ns(n,a=>{const l=a.map(c=>({id:c.id,senderId:c.sender,content:c.message,timestamp:Te(c.date),isOwn:c.sender===t,isImage:xs(c.message)}));q(l),setTimeout(()=>{var c;return(c=G.current)==null?void 0:c.scrollIntoView({behavior:"smooth"})},100)},a=>{console.error("Error loading messages:",a)});return t&&os(n,t),()=>s()},[n,t]),r.useEffect(()=>{if(!n||!t)return;const s=d.find(a=>a.id===n);s!=null&&s.otherUserId&&ls(t,s.otherUserId).then(a=>{L(a.hasBlockedOther),Se(a.isBlockedByOther)})},[n,t,d]),r.useEffect(()=>{if(!n)return;const s=d.find(l=>l.id===n);if(!(s!=null&&s.otherUserId))return;const a=cs(s.otherUserId,l=>{Be(l.online),Pe(l.lastSeen)});return()=>a()},[n,d]),r.useEffect(()=>{if(!n)return;const s=d.find(l=>l.id===n);if(!(s!=null&&s.otherUserId))return;const a=ds(n,s.otherUserId,l=>{Ee(l)});return()=>a()},[n,d]),r.useEffect(()=>{if(t)return Ne(t,!0),()=>{Ne(t,!1)}},[t]),r.useEffect(()=>{if(!n||!t)return;let s;return j?(E(n,t,!0),s=setTimeout(()=>{E(n,t,!1)},3e3)):E(n,t,!1),()=>{s&&clearTimeout(s),n&&E(n,t,!1)}},[j,n,t]);const z=r.useRef(!1);r.useEffect(()=>{const s=p==null?void 0:p.chatId;s&&d.length>0&&d.some(x=>x.id===s)&&(P(s),T(!0));const a=new URLSearchParams(window.location.search),l=a.get("otherUserId"),c=a.get("otherUserName"),Y=a.get("otherUserPhoto");l&&t&&!s&&!z.current&&(z.current=!0,(async()=>{try{const x={firstName:(i==null?void 0:i.firstName)||"",lastName:(i==null?void 0:i.lastName)||"",userName:h,profilePhoto:f},g=await us(t,l,x,{firstName:c||"",lastName:"",userName:c||"",profilePhoto:Y||""});window.history.replaceState({},"",`/inbox/${g}`),w(`/inbox/${g}`)}catch(x){console.error("Error creating chat:",x),z.current=!1,u({title:"Error",description:"Failed to open chat. Please try again.",variant:"destructive"})}})())},[p==null?void 0:p.chatId,d,t,h,f,i,w,u]);const Te=s=>new Date(parseInt(s)).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}),Ae=d.filter(s=>s.userName.toLowerCase().includes(K.toLowerCase())),o=d.find(s=>s.id===n),y=O||M,ee=async()=>{if(j.trim()&&n&&t&&!y&&!k){W(!0);const s=await ve(n,j.trim(),t,h,f);s.success?Q(""):(console.error("Failed to send message:",s.error),u({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"})),W(!1)}},Oe=async s=>{var l;const a=(l=s.target.files)==null?void 0:l[0];if(!(!a||!n||!t||y)){if(!a.type.startsWith("image/")){u({title:"Invalid file",description:"Please select an image file.",variant:"destructive"});return}if(a.size>5*1024*1024){u({title:"File too large",description:"Please select an image smaller than 5MB.",variant:"destructive"});return}_(!0);try{const c=await ms(a,t);await ve(n,c,t,h,f),u({title:"Image sent",description:"Your image has been sent successfully."})}catch(c){console.error("Error uploading image:",c),u({title:"Upload failed",description:"Failed to upload image. Please try again.",variant:"destructive"})}finally{_(!1),I.current&&(I.current.value="")}}},Le=async()=>{if(!(o!=null&&o.otherUserId)||!t)return;C(!0);const s=await hs(t,o.otherUserId);C(!1),F(!1),s?(L(!0),u({title:"User blocked",description:`You have blocked ${o.userName}. They can no longer send you messages.`})):u({title:"Error",description:"Failed to block user. Please try again.",variant:"destructive"})},Me=async()=>{if(!(o!=null&&o.otherUserId)||!t)return;C(!0);const s=await fs(t,o.otherUserId);C(!1),S(!1),s?(L(!1),u({title:"User unblocked",description:`You have unblocked ${o.userName}.`})):u({title:"Error",description:"Failed to unblock user. Please try again.",variant:"destructive"})},Fe=s=>{P(s),T(!0),w(`/inbox/${s}`)},Re=()=>{T(!1),P(null),w("/inbox")},se=s=>s.replace("@","").substring(0,2).toUpperCase();return e.jsxs("div",{className:"h-full bg-background","data-testid":"page-inbox",children:[e.jsx("input",{ref:I,type:"file",accept:"image/*",onChange:Oe,className:"hidden"}),e.jsx("div",{className:"flex justify-center w-full h-full",children:e.jsx("div",{className:"w-full lg:w-[90%] h-full",children:Ie?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading chats..."})}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 h-full",children:[e.jsxs("div",{className:m("lg:col-span-1 border-r border-border bg-card",V&&"hidden lg:block"),children:[e.jsxs("div",{className:"p-4 border-b border-border",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4","data-testid":"text-inbox-title",children:"Messages"}),e.jsxs("div",{className:"relative",children:[e.jsx(ye,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(fe,{placeholder:"Search conversations...",value:K,onChange:s=>we(s.target.value),className:"pl-10","data-testid":"input-search-conversations"})]})]}),e.jsx(je,{className:"h-[calc(100vh-12rem)]",children:e.jsx("div",{className:"divide-y divide-border",children:Ae.map(s=>e.jsxs("button",{onClick:()=>Fe(s.id),className:m("w-full p-4 flex items-start gap-3 hover-elevate active-elevate-2 transition-colors text-left",n===s.id&&"bg-muted"),"data-testid":`conversation-${s.id}`,children:[e.jsxs("div",{className:"relative",children:[e.jsxs(xe,{className:"h-12 w-12",children:[e.jsx(ge,{src:s.userAvatar}),e.jsx(pe,{children:se(s.userName)})]}),s.online&&e.jsx("span",{className:"absolute bottom-0 right-0 h-3 w-3 bg-green-500 rounded-full border-2 border-card"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:m("text-sm font-medium truncate",s.unread?"text-foreground":"text-muted-foreground"),children:s.userName}),e.jsx("span",{className:"text-xs text-muted-foreground ml-2 flex-shrink-0",children:s.timestamp})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:m("text-sm truncate",s.unread?"font-medium text-foreground":"text-muted-foreground"),children:s.lastMessage}),s.unreadCount&&s.unreadCount>0&&e.jsx(Je,{variant:"default",className:"ml-2 flex-shrink-0 h-5 min-w-[20px] flex items-center justify-center",children:s.unreadCount})]})]})]},s.id))})})]}),e.jsx("div",{className:m("lg:col-span-2 flex flex-col",!V&&"hidden lg:flex"),children:o?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border bg-card flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(B,{variant:"ghost",size:"icon",className:"lg:hidden",onClick:Re,"data-testid":"button-back-to-list",children:e.jsx(gs,{className:"h-5 w-5"})}),e.jsx(ae,{href:`/profile/${o.otherUserId}`,children:e.jsxs(xe,{className:"h-10 w-10 cursor-pointer hover-elevate",children:[e.jsx(ge,{src:o.userAvatar}),e.jsx(pe,{children:se(o.userName)})]})}),e.jsxs("div",{children:[e.jsx(ae,{href:`/profile/${o.otherUserId}`,children:e.jsx("p",{className:"font-medium text-foreground hover:underline cursor-pointer","data-testid":"text-conversation-user",children:o.userName})}),!y&&e.jsxs(e.Fragment,{children:[R&&e.jsx("p",{className:"text-xs text-primary italic",children:"typing..."}),!R&&J&&e.jsx("p",{className:"text-xs text-green-600 dark:text-green-400",children:"Online"}),!R&&!J&&X&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Last seen ",X]})]})]})]}),e.jsxs(Xe,{children:[e.jsx(Ze,{asChild:!0,children:e.jsx(B,{variant:"ghost",size:"icon","data-testid":"button-conversation-menu",children:e.jsx(ps,{className:"h-5 w-5"})})}),e.jsx(es,{align:"end",children:O?e.jsxs(be,{onClick:()=>S(!0),"data-testid":"menu-item-unblock",children:[e.jsx(js,{className:"h-4 w-4 mr-2"}),"Unblock User"]}):!M&&e.jsxs(be,{onClick:()=>F(!0),className:"text-destructive","data-testid":"menu-item-block",children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Block User"]})})]})]}),y&&e.jsxs("div",{className:"bg-destructive/10 border-y border-destructive/20 p-4 text-center",children:[O&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-destructive",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsxs("span",{children:["You blocked ",o.userName,"."," ",e.jsx("button",{onClick:()=>S(!0),className:"underline font-medium",children:"Unblock"})]})]}),M&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-destructive",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsxs("span",{children:["You have been blocked by ",o.userName]})]})]}),e.jsx(je,{className:"flex-1 p-4",children:e.jsxs("div",{className:"space-y-4",children:[Ue.map(s=>e.jsx("div",{className:m("flex",s.isOwn?"justify-end":"justify-start"),"data-testid":`message-${s.id}`,children:e.jsx("div",{className:m("max-w-[70%] rounded-lg",s.isImage?"p-0":"px-4 py-2",s.isOwn?"bg-primary text-primary-foreground":"bg-muted text-foreground"),children:s.isImage?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s.content,alt:"Chat image",className:"rounded-lg max-w-full h-auto cursor-pointer",onClick:()=>Z(s.content),style:{maxHeight:"300px"}}),e.jsx("p",{className:m("text-xs mt-1 px-2 pb-1",s.isOwn?"text-primary-foreground/70 text-right":"text-muted-foreground"),children:s.timestamp})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm",children:s.content}),e.jsx("p",{className:m("text-xs mt-1",s.isOwn?"text-primary-foreground/70":"text-muted-foreground"),children:s.timestamp})]})})},s.id)),e.jsx("div",{ref:G})]})}),!y&&e.jsxs("div",{className:"p-4 border-t border-border bg-card",children:[U&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-2",children:[e.jsx(re,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Uploading image..."})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx(B,{variant:"ghost",size:"icon",onClick:()=>{var s;return(s=I.current)==null?void 0:s.click()},disabled:U,"data-testid":"button-attach-image",children:e.jsx(bs,{className:"h-5 w-5"})}),e.jsx("div",{className:"flex-1",children:e.jsx(fe,{placeholder:"Type a message...",value:j,onChange:s=>Q(s.target.value),onKeyPress:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),ee())},disabled:k||U,className:"resize-none","data-testid":"input-message"})}),e.jsx(B,{onClick:ee,disabled:!j.trim()||k||U,"data-testid":"button-send-message",children:k?e.jsx(re,{className:"h-4 w-4 animate-spin"}):e.jsx(Ns,{className:"h-4 w-4"})})]})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-center p-8",children:e.jsxs("div",{children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(ye,{className:"h-8 w-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No conversation selected"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose a conversation from the list to start messaging"})]})})})]})})}),e.jsx(ie,{open:Ce,onOpenChange:F,children:e.jsxs(ne,{children:[e.jsxs(oe,{children:[e.jsxs(le,{children:["Block ",o==null?void 0:o.userName,"?"]}),e.jsx(ce,{children:"They won't be able to send you messages anymore. You can unblock them anytime."})]}),e.jsxs(de,{children:[e.jsx(ue,{disabled:b,children:"Cancel"}),e.jsx(me,{onClick:Le,disabled:b,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:b?"Blocking...":"Block"})]})]})}),e.jsx(ie,{open:De,onOpenChange:S,children:e.jsxs(ne,{children:[e.jsxs(oe,{children:[e.jsxs(le,{children:["Unblock ",o==null?void 0:o.userName,"?"]}),e.jsx(ce,{children:"They will be able to send you messages again."})]}),e.jsxs(de,{children:[e.jsx(ue,{disabled:b,children:"Cancel"}),e.jsx(me,{onClick:Me,disabled:b,children:b?"Unblocking...":"Unblock"})]})]})}),e.jsx(ss,{open:!!$,onOpenChange:()=>Z(null),children:e.jsxs(ts,{className:"max-w-4xl",children:[e.jsx(as,{children:e.jsx(rs,{children:"Image Preview"})}),$&&e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("img",{src:$,alt:"Full size",className:"max-w-full max-h-[80vh] object-contain rounded-lg"})})]})})]})}export{Ys as default};
