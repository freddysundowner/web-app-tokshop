import{b as te,a as re,Z as ae,u as oe,r as f,O as ie,j as e,d as x,m as O,L as D}from"./index-FVTY5sKH.js";import{u as ne,S as de}from"./show-card-DdIkBK1N.js";import{A as W,a as K,b as Z}from"./avatar-BgbrThQo.js";import{C as z}from"./card-CF4CqaN2.js";import{C as j}from"./checkbox-CNlG1UXm.js";import{u as G,g as L}from"./use-api-config-CmVD2X-T.js";import{C as B}from"./chevron-up-D8QnUA5s.js";import{C as Q}from"./chevron-down-BD1mluAZ.js";import{S as le}from"./search-zDcbIzzp.js";import{P as ce}from"./package-dXPzRBiL.js";import{S as me}from"./shopping-bag-CmfLtQot.js";import"./useQuery-DsZx8GVA.js";import"./format-D46ChU1D.js";import"./isTomorrow-B3a_VsBR.js";import"./index-Cbw5mxKQ.js";import"./check-DWjWNqF1.js";const ue=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t);function xe({product:t}){var d,c,r,N,w;const{externalApiUrl:n}=G(),h=(d=t.images)!=null&&d[0]?L(t.images[0],n):"",l=((c=t.ownerId)==null?void 0:c.userName)||((r=t.ownerId)==null?void 0:r.firstName)||"Seller",m=(N=t.ownerId)!=null&&N.profilePhoto?L(t.ownerId.profilePhoto,n):"";return e.jsx(D,{href:`/product/${t._id}`,children:e.jsxs(z,{className:"group hover-elevate active-elevate-2 cursor-pointer overflow-hidden border-border","data-testid":`card-product-${t._id}`,children:[e.jsx("div",{className:"relative aspect-square bg-muted overflow-hidden",children:h?e.jsx("img",{src:h,alt:t.name,className:"w-full h-full object-cover","data-testid":`img-product-${t._id}`}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gradient-to-br from-muted to-muted/50",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 text-muted-foreground/40",children:[e.jsx(ce,{className:"h-16 w-16",strokeWidth:1.5}),e.jsx(me,{className:"h-8 w-8 -mt-4",strokeWidth:1.5})]})})}),e.jsxs("div",{className:"p-3 space-y-2",children:[e.jsx("h3",{className:"font-medium text-sm text-foreground line-clamp-2 min-h-[2.5rem]","data-testid":`text-product-name-${t._id}`,children:t.name}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-bold text-foreground","data-testid":`text-price-${t._id}`,children:ue(t.price)}),t.quantity&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Qty: ",t.quantity]})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-1 border-t border-border",children:[e.jsxs(W,{className:"h-5 w-5",children:[e.jsx(K,{src:m,alt:l}),e.jsx(Z,{className:"bg-primary text-primary-foreground text-xs",children:(w=l[0])==null?void 0:w.toUpperCase()})]}),e.jsx("p",{className:"text-xs text-muted-foreground truncate","data-testid":`text-seller-${t._id}`,children:l})]})]})]})})}function he({user:t}){var m;const{externalApiUrl:n}=G(),h=t.profilePhoto?L(t.profilePhoto,n):"",l=t.firstName&&t.lastName?`${t.firstName} ${t.lastName}`:t.userName||"User";return e.jsx(D,{href:`/profile/${t._id}`,children:e.jsx(z,{className:"group hover-elevate active-elevate-2 cursor-pointer p-4","data-testid":`card-user-${t._id}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(W,{className:"h-12 w-12",children:[e.jsx(K,{src:h,alt:l}),e.jsx(Z,{className:"bg-primary text-primary-foreground",children:(m=l[0])==null?void 0:m.toUpperCase()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-foreground truncate","data-testid":`text-username-${t._id}`,children:l}),t.bio&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-1",children:t.bio})]})]})})})}function Re(){var E;const{settings:t}=te(),{user:n}=re(),h=ae(),[,l]=oe(),m=f.useRef(null),d=new URLSearchParams(h),c=d.get("q")||"",r=d.get("filter")||"all",[N,w]=f.useState("relevant"),v=d.get("live")==="true",y=d.get("upcoming")==="true",S=d.get("freeShipping")==="true",C=d.get("reducedShipping")==="true",[k,H]=f.useState(!0),[P,J]=f.useState(!0),V=(n==null?void 0:n._id)||(n==null?void 0:n.id)||"";ie(c?`Search: ${c} - ${t.app_name}`:`Search - ${t.app_name}`);const{data:i,fetchNextPage:A,hasNextPage:U,isFetchingNextPage:$,isLoading:g,error:F}=ne({queryKey:["/api/products/search",c,r,v,y,S,C],staleTime:0,gcTime:0,queryFn:async({pageParam:s=1})=>{const a=new URLSearchParams({q:c,page:String(s),limit:"20",type:r});v&&(a.set("started","true"),a.set("ended","false")),y&&(a.set("started","false"),a.set("ended","false")),S&&a.set("freeShipping","true"),C&&a.set("reducedShipping","true");const o=await fetch(`/api/products/search?${a.toString()}`);if(!o.ok)throw new Error("Search failed");return o.json()},getNextPageParam:s=>{const a=s.pagination.page;let o=0;return r==="products"?o=s.results.products.pages:r==="shows"?o=s.results.shows.pages:r==="users"?o=s.results.users.pages:o=Math.max(s.results.products.pages,s.results.shows.pages,s.results.users.pages),a<o?a+1:void 0},initialPageParam:1,enabled:!!c});f.useEffect(()=>{if(!m.current||!U||$)return;const s=new IntersectionObserver(a=>{a[0].isIntersecting&&A()},{threshold:.1});return s.observe(m.current),()=>s.disconnect()},[U,$,A]);const _=(i==null?void 0:i.pages.flatMap(s=>{var a;return((a=s.results.products)==null?void 0:a.data)||[]}))||[],R=(i==null?void 0:i.pages.flatMap(s=>{var a;return((a=s.results.shows)==null?void 0:a.data)||[]}))||[],I=(i==null?void 0:i.pages.flatMap(s=>{var a;return((a=s.results.users)==null?void 0:a.data)||[]}))||[],p=((E=i==null?void 0:i.pages[0])==null?void 0:E.results)||{products:{total:0},shows:{total:0},users:{total:0}},u=s=>{d.set("filter",s),l(`/search?${d.toString()}`)},b=(s,a)=>{const o=new URLSearchParams(h);a?o.set(s,"true"):o.delete(s),l(`/search?${o.toString()}`)},X=r==="all"||r==="products",Y=r==="all"||r==="shows",ee=r==="all"||r==="users",se=(()=>{var s,a,o,q,T,M;return r==="products"?((s=p.products)==null?void 0:s.total)||0:r==="shows"?((a=p.shows)==null?void 0:a.total)||0:r==="users"?((o=p.users)==null?void 0:o.total)||0:(((q=p.products)==null?void 0:q.total)||0)+(((T=p.shows)==null?void 0:T.total)||0)+(((M=p.users)==null?void 0:M.total)||0)})();return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"flex justify-center w-full",children:e.jsx("div",{className:"w-full lg:w-[90%]",children:e.jsxs("div",{className:"flex gap-6 px-4 md:px-6 lg:px-8 py-6",children:[e.jsxs("div",{className:"hidden md:block flex-shrink-0 w-64 space-y-6 sticky top-6 self-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-foreground mb-3",children:"Filter by"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>u("all"),className:x("w-full text-left px-3 py-2 rounded-md text-sm transition-colors",r==="all"?"bg-foreground text-background font-medium":"text-foreground hover:bg-muted"),"data-testid":"filter-all",children:"Top"}),e.jsx("button",{onClick:()=>u("products"),className:x("w-full text-left px-3 py-2 rounded-md text-sm transition-colors",r==="products"?"bg-foreground text-background font-medium":"text-foreground hover:bg-muted"),"data-testid":"filter-products",children:"Products"}),e.jsx("button",{onClick:()=>u("shows"),className:x("w-full text-left px-3 py-2 rounded-md text-sm transition-colors",r==="shows"?"bg-foreground text-background font-medium":"text-foreground hover:bg-muted"),"data-testid":"filter-shows",children:"Shows"}),e.jsx("button",{onClick:()=>u("users"),className:x("w-full text-left px-3 py-2 rounded-md text-sm transition-colors",r==="users"?"bg-foreground text-background font-medium":"text-foreground hover:bg-muted"),"data-testid":"filter-users",children:"Users"})]})]}),(r==="shows"||r==="all")&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"border-t border-border pt-6",children:[e.jsxs("button",{onClick:()=>H(!k),className:"w-full flex items-center justify-between mb-3","data-testid":"toggle-time-of-show",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Time of Show"}),k?e.jsx(B,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(Q,{className:"h-4 w-4 text-muted-foreground"})]}),k&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{id:"live",checked:v,onCheckedChange:s=>b("live",s),"data-testid":"checkbox-live"}),e.jsx("label",{htmlFor:"live",className:"text-sm text-foreground cursor-pointer",children:"Live"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{id:"upcoming",checked:y,onCheckedChange:s=>b("upcoming",s),"data-testid":"checkbox-upcoming"}),e.jsx("label",{htmlFor:"upcoming",className:"text-sm text-foreground cursor-pointer",children:"Upcoming"})]})]})]}),e.jsxs("div",{className:"border-t border-border pt-6",children:[e.jsxs("button",{onClick:()=>J(!P),className:"w-full flex items-center justify-between mb-3","data-testid":"toggle-shipping",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Reduced Shipping"}),P?e.jsx(B,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(Q,{className:"h-4 w-4 text-muted-foreground"})]}),P&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{id:"free",checked:S,onCheckedChange:s=>b("freeShipping",s),"data-testid":"checkbox-free"}),e.jsx("label",{htmlFor:"free",className:"text-sm text-foreground cursor-pointer",children:"FREE"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{id:"reduced",checked:C,onCheckedChange:s=>b("reducedShipping",s),"data-testid":"checkbox-reduced"}),e.jsx("label",{htmlFor:"reduced",className:"text-sm text-foreground cursor-pointer",children:"Reduced"})]})]})]})]})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("h1",{className:"text-2xl font-bold text-foreground mb-2","data-testid":"text-search-query",children:['Search results for "',c,'"']}),e.jsx("p",{className:"text-muted-foreground",children:g?"Searching...":`Found ${se} results`})]}),e.jsxs("div",{className:"flex md:hidden items-center gap-2 mb-6 border-b border-border overflow-x-auto",children:[e.jsx("button",{onClick:()=>u("all"),className:x("px-4 py-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors",r==="all"?"border-primary text-foreground":"border-transparent text-muted-foreground hover:text-foreground"),"data-testid":"button-filter-all",children:"Top"}),e.jsx("button",{onClick:()=>u("products"),className:x("px-4 py-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors",r==="products"?"border-primary text-foreground":"border-transparent text-muted-foreground hover:text-foreground"),"data-testid":"button-filter-products",children:"Products"}),e.jsx("button",{onClick:()=>u("shows"),className:x("px-4 py-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors",r==="shows"?"border-primary text-foreground":"border-transparent text-muted-foreground hover:text-foreground"),"data-testid":"button-filter-shows",children:"Shows"}),e.jsx("button",{onClick:()=>u("users"),className:x("px-4 py-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors",r==="users"?"border-primary text-foreground":"border-transparent text-muted-foreground hover:text-foreground"),"data-testid":"button-filter-users",children:"Users"})]}),g&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(O,{className:"h-8 w-8 animate-spin text-primary"})}),F&&e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-destructive",children:"Failed to load search results"})}),!g&&!F&&_.length===0&&R.length===0&&I.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(le,{className:"h-16 w-16 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-lg font-medium text-foreground mb-2",children:"No results found"}),e.jsx("p",{className:"text-muted-foreground",children:"Try adjusting your search or filters"})]}),!g&&!F&&e.jsxs("div",{className:"space-y-8",children:[X&&_.length>0&&e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4",children:_.map(s=>e.jsx(xe,{product:s},s._id))}),Y&&R.length>0&&e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:R.map(s=>e.jsx(de,{show:s,currentUserId:V},s._id))}),ee&&I.length>0&&e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4",children:I.map(s=>e.jsx(he,{user:s},s._id))}),U&&e.jsx("div",{ref:m,className:"flex items-center justify-center py-8",children:$&&e.jsx(O,{className:"h-6 w-6 animate-spin text-primary"})})]})]})]})})})})}export{Re as default};
